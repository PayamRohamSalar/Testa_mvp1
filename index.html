<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>پلتفرم نوآوری باز + TESTA</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      // Fallback loader for React, ReactDOM, and Babel if CDN fails
      (function () {
        function loadScript(src) {
          return new Promise(function(resolve, reject) {
            var s = document.createElement('script');
            s.src = src;
            s.onload = resolve;
            s.onerror = function() { reject(new Error('Failed to load ' + src)); };
            document.head.appendChild(s);
          });
        }

        async function ensureDependencies() {
          var needsReact = !window.React;
          var needsReactDOM = !window.ReactDOM;
          var needsBabel = !window.Babel;

          if (!needsReact && !needsReactDOM && !needsBabel) {
            return;
          }

          var cdnCandidates = {
            react: [
              'https://cdn.jsdelivr.net/npm/react@18/umd/react.development.js',
              'https://unpkg.com/react@18/umd/react.development.js'
            ],
            reactDom: [
              'https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.development.js',
              'https://unpkg.com/react-dom@18/umd/react-dom.development.js'
            ],
            babel: [
              'https://cdn.jsdelivr.net/npm/@babel/standalone/babel.min.js',
              'https://unpkg.com/@babel/standalone/babel.min.js'
            ]
          };

          try {
            if (needsReact) {
              for (var i = 0; i < cdnCandidates.react.length && !window.React; i++) {
                await loadScript(cdnCandidates.react[i]);
              }
            }
            if (needsReactDOM) {
              for (var j = 0; j < cdnCandidates.reactDom.length && !window.ReactDOM; j++) {
                await loadScript(cdnCandidates.reactDom[j]);
              }
            }
            if (needsBabel) {
              for (var k = 0; k < cdnCandidates.babel.length && !window.Babel; k++) {
                await loadScript(cdnCandidates.babel[k]);
              }
            }
          } catch (e) {
            console.error('Failed loading dependencies:', e);
          }

          if (window.Babel && typeof window.Babel.transformScriptTags === 'function') {
            // Compile any <script type="text/babel"> tags if Babel loaded late
            window.Babel.transformScriptTags();
          } else if (!window.React || !window.ReactDOM) {
            document.body.innerHTML = '<div style="padding:20px;color:red;font-family:Arial">خطا در بارگذاری وابستگی‌ها. لطفاً اتصال اینترنت یا فایروال را بررسی کنید.</div>';
          }
        }

        // Kick off dependency check as early as possible
        ensureDependencies();
      })();
    </script>
    <style>
        body {
            font-family: 'Tahoma', 'Arial', sans-serif;
        }

        /* Enhanced Loading Animations */
        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .animate-spin {
            animation: spin 1s linear infinite;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: .5;
            }
        }

        .animate-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        /* Skeleton Loading Animation */
        @keyframes skeleton-shimmer {
            0% {
                background-position: -200px 0;
            }
            100% {
                background-position: calc(200px + 100%) 0;
            }
        }

        .skeleton {
            background: linear-gradient(
                90deg,
                #f0f0f0 25%,
                #e0e0e0 50%,
                #f0f0f0 75%
            );
            background-size: 200px 100%;
            animation: skeleton-shimmer 1.5s infinite linear;
        }

        /* Button Loading States */
        .btn-loading {
            position: relative;
            color: transparent !important;
        }

        .btn-loading::after {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            top: 50%;
            left: 50%;
            margin-left: -8px;
            margin-top: -8px;
            border: 2px solid #ffffff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s linear infinite;
        }

        /* Page Loading Overlay */
        .page-loading {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        /* Form Field Loading */
        .field-loading {
            position: relative;
        }

        .field-loading::after {
            content: '';
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            width: 12px;
            height: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 50%;
            border-top-color: #3b82f6;
            animation: spin 1s linear infinite;
        }

        /* Fade In Animation */
        @keyframes fade-in {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        .animate-fade-in {
            animation: fade-in 0.5s ease-out forwards;
            opacity: 0;
        }

        /* Slide In Animations */
        @keyframes slide-in-up {
            from {
                transform: translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes slide-in-down {
            from {
                transform: translateY(-20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes slide-in-left {
            from {
                transform: translateX(-20px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slide-in-right {
            from {
                transform: translateX(20px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .animate-slide-in-up {
            animation: slide-in-up 0.5s ease-out forwards;
            opacity: 0;
        }

        .animate-slide-in-down {
            animation: slide-in-down 0.5s ease-out forwards;
            opacity: 0;
        }

        .animate-slide-in-left {
            animation: slide-in-left 0.5s ease-out forwards;
            opacity: 0;
        }

        .animate-slide-in-right {
            animation: slide-in-right 0.5s ease-out forwards;
            opacity: 0;
        }

        /* Scale In Animation */
        @keyframes scale-in {
            from {
                transform: scale(0.9);
                opacity: 0;
            }
            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        .animate-scale-in {
            animation: scale-in 0.3s ease-out forwards;
            opacity: 0;
        }

        /* Bounce Animation */
        @keyframes bounce {
            0%, 20%, 53%, 80%, 100% {
                transform: translate3d(0,0,0);
            }
            40%, 43% {
                transform: translate3d(0, -8px, 0);
            }
            70% {
                transform: translate3d(0, -4px, 0);
            }
            90% {
                transform: translate3d(0, -2px, 0);
            }
        }

        .animate-bounce {
            animation: bounce 1s infinite;
        }

        /* Focus Styles for Accessibility */
        .focus-ring:focus {
            outline: 2px solid #3B82F6;
            outline-offset: 2px;
        }

        /* Enhanced Mobile Touch Targets & Accessibility */
        @media (max-width: 768px) {
            /* WCAG AAA compliant touch targets (minimum 44x44px) */
            button, .touch-target, a {
                min-height: 48px;
                min-width: 48px;
                padding: 12px 16px;
            }

            input, select, textarea {
                font-size: 16px; /* Prevent zoom on iOS */
                padding: 16px;
                border-radius: 8px;
                min-height: 48px;
            }

            /* Enhanced touch feedback */
            button:active, .touch-target:active {
                transform: scale(0.98);
                transition: transform 0.1s ease;
            }

            /* Better mobile spacing */
            .space-y-6 > * + * {
                margin-top: 2rem;
            }

            .space-y-8 > * + * {
                margin-top: 2.5rem;
            }

            /* Mobile container improvements */
            .container, .max-w-5xl {
                padding-left: 1rem;
                padding-right: 1rem;
            }

            /* Mobile-friendly navigation */
            nav {
                padding: 0.75rem 1rem;
            }

            /* Stack grid items vertically on mobile */
            .grid.md\\:grid-cols-2 > * {
                margin-bottom: 1.5rem;
            }

            /* Mobile card improvements */
            .card {
                margin-bottom: 1rem;
                border-radius: 12px;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            }

            /* Better mobile table handling */
            .table-responsive {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            .grid.md\\:grid-cols-4 > * {
                margin-bottom: 1rem;
            }
        }

        /* Tablet adjustments */
        @media (min-width: 769px) and (max-width: 1024px) {
            .max-w-5xl {
                max-width: 90vw;
            }

            .max-w-7xl {
                max-width: 95vw;
            }
        }

        /* High Contrast Mode Support */
        @media (prefers-contrast: high) {
            .bg-blue-50 { background-color: #ffffff; }
            .bg-green-50 { background-color: #ffffff; }
            .bg-red-50 { background-color: #ffffff; }
            .bg-yellow-50 { background-color: #ffffff; }
            .text-blue-600 { color: #000000; }
            .text-green-600 { color: #000000; }
            .text-red-600 { color: #000000; }
            .text-yellow-600 { color: #000000; }
        }

        /* Enhanced Mobile Touch and Gesture Support */
        @media (max-width: 640px) {
            /* Larger tap targets for small screens */
            button, a, input, select, textarea {
                min-height: 48px;
                touch-action: manipulation; /* Prevent double-tap zoom */
            }

            /* Better mobile typography */
            .text-sm { font-size: 0.9rem; }
            .text-base { font-size: 1rem; }
            .text-lg { font-size: 1.125rem; }
            .text-xl { font-size: 1.25rem; }

            /* Mobile-first navigation */
            .mobile-nav-overlay {
                position: fixed;
                inset: 0;
                background: rgba(0, 0, 0, 0.5);
                backdrop-filter: blur(4px);
                z-index: 999;
            }

            /* Better mobile forms */
            .mobile-form {
                padding: 1rem;
                margin: 0 -1rem;
            }

            /* Mobile grid improvements */
            .grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            /* Mobile card spacing */
            .card-mobile {
                margin-bottom: 1rem;
                border-radius: 0.75rem;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            }

            /* Mobile-friendly modals */
            .modal-mobile {
                margin: 1rem;
                max-height: 90vh;
                overflow-y: auto;
            }
        }

        /* Enhanced tablet support */
        @media (min-width: 641px) and (max-width: 1024px) {
            .tablet-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 1.5rem;
            }

            /* Better tablet navigation */
            nav .hidden { display: block; }
            .mobile-menu-button { display: none; }
        }

        /* Page transition animations */
        @keyframes page-enter {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes page-exit {
            from {
                opacity: 1;
                transform: translateY(0);
            }
            to {
                opacity: 0;
                transform: translateY(-10px);
            }
        }

        .page-transition {
            animation: page-enter 0.3s ease-out;
        }

        /* Loading shimmer effect */
        @keyframes shimmer {
            0% {
                background-position: -1000px 0;
            }
            100% {
                background-position: 1000px 0;
            }
        }

        .shimmer {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 1000px 100%;
            animation: shimmer 2s infinite;
        }

        /* Interactive button states */
        .btn-interactive {
            transition: all 0.15s ease;
            transform: translateZ(0); /* Force hardware acceleration */
        }

        .btn-interactive:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        .btn-interactive:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        /* Card hover effects */
        .card-hover {
            transition: all 0.2s ease;
        }

        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
        }

        /* Focus improvements for accessibility */
        .focus-visible {
            outline: 2px solid #3B82F6;
            outline-offset: 2px;
            border-radius: 4px;
        }

        /* Better focus indicators for keyboard navigation */
        button:focus-visible,
        a:focus-visible,
        input:focus-visible,
        select:focus-visible,
        textarea:focus-visible {
            outline: 2px solid #3B82F6;
            outline-offset: 2px;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        /* High contrast mode improvements */
        @media (prefers-contrast: high) {
            .card-hover:hover {
                border: 2px solid #000;
            }
            
            button {
                border: 1px solid currentColor;
            }
            
            .focus-visible {
                outline: 3px solid currentColor;
            }
        }

        /* Reduced motion support - enhanced */
        @media (prefers-reduced-motion: reduce) {
            .animate-fade-in,
            .animate-slide-in-up,
            .animate-slide-in-down,
            .animate-slide-in-left,
            .animate-slide-in-right,
            .animate-scale-in,
            .animate-spin,
            .animate-pulse,
            .animate-bounce,
            .page-transition,
            .shimmer,
            .btn-interactive,
            .card-hover {
                animation: none !important;
                transition: none !important;
                transform: none !important;
            }
        }
    </style>
</head>
<body class="bg-gray-100">
    <!-- Skip Navigation Link for Accessibility -->
    <a href="#main-content" class="sr-only focus:not-sr-only focus:absolute focus:top-4 focus:left-4 bg-blue-600 text-white px-4 py-2 rounded z-50 focus-ring">
      پرش به محتوای اصلی
    </a>

    <div id="root"></div>

<script type="text/babel" data-presets="env,react" data-plugins="proposal-class-properties,proposal-optional-chaining,proposal-nullish-coalescing-operator">
    // =========================
    // --- STORAGE ADAPTERS ---
    // =========================
    const storage = {
      get(key, fallback) {
        try {
          const raw = localStorage.getItem(key);
          return raw ? JSON.parse(raw) : fallback;
        } catch {
          return fallback;
        }
      },
      set(key, value) {
        localStorage.setItem(key, JSON.stringify(value));
      },
      has(key) {
        return localStorage.getItem(key) !== null;
      },
      clear() {
        localStorage.clear();
      }
    };
  
    // =========================
    // --- DATA KEYS & MODELS ---
    // =========================
    // Keep keys centralized for easy future migration to API/DB
    const KEYS = {
      "users": "users",
      "orgs": "orgs",
      "challenges": "challenges",
      "submissions": "submissions",
      "messages": "messages",
      "events": "events",
      "exhibitors": "exhibitors",
      "notifications": "notifications",
      "reputationEvents": "reputationEvents",
      "settings": "settings",
      "session": "session",
      "seeded": "seeded"
    };
  
    // Minimal shapes (for reference / future validation)
    // user: {id, role: "ADMIN"|"SEEKER"|"SOLVER", email, name, password, orgId?, avatar?, bio?, skills?, reputation}
    // org: {id, name, domains:[], description?, logo?, website?, contactInfo}
    // challenge: {id, orgId, title, problem?, success?, deliverables?, reward, category, deadline?, tags?, attachments?, status, createdAt, updatedAt}
    // submission: {id, challengeId, userId, ndaAcceptedAt?, status, data:{summary, proposal, files[], video?}, createdAt, updatedAt}
    // message: {id, submissionId, fromUserId, body, createdAt, readAt?}
    // event: {id, day, track, time, title, speakers[], description?, location?, capacity?}
    // exhibitor: {id, name, boothCode, category, description?, logo?, website?, contactInfo}
    // notification: {id, type, text, createdAt, read?, userId?, targetId?}
    // reputationEvent: {id, userId, type, points, at, description?}
    // settings: {kiosk:boolean, countdownTarget:ISO|null, theme?, language?}
  
    // ====================================
    // --- SEED DATA (runs once per user) ---
    // ====================================
    function seedDataOnce() {
      console.log('Checking if seeded:', storage.has(KEYS.seeded));
      if (storage.has(KEYS.seeded)) {
        console.log('Already seeded, skipping...');
        return;
      }
      console.log('Seeding data...');

      // Force seeding by removing the seeded flag first
      try {
        localStorage.removeItem('seeded');
        console.log('Removed seeded flag');
      } catch (e) {
        console.log('Could not remove seeded flag:', e);
      }
  
      // Demo users (per spec)
      const users = [
        {
          "id": "u-admin",
          "role": "ADMIN",
          "email": "admin@platform.ir",
          "name": "مدیر سیستم",
          "password": "123456",
          "avatar": null,
          "bio": "مدیر ارشد پلتفرم نوآوری باز",
          "skills": ["مدیریت", "توسعه نرم‌افزار"],
          "reputation": 1000
        },
        {
          "id": "u-seeker",
          "role": "SEEKER",
          "email": "info@parstech.ir",
          "name": "پارس‌تک",
          "password": "123456",
          "orgId": "o-pars",
          "avatar": null,
          "bio": "شرکت پیشرو در حوزه انرژی و IoT",
          "skills": ["انرژی", "IoT", "مدیریت پروژه"],
          "reputation": 850
        },
        {
          "id": "u-solver",
          "role": "SOLVER",
          "email": "a.mohammadi@university.ac.ir",
          "name": "امیر محمدی",
          "password": "123456",
          "avatar": null,
          "bio": "پژوهشگر و توسعه‌دهنده نرم‌افزار",
          "skills": ["هوش مصنوعی", "یادگیری ماشین", "پایتون"],
          "reputation": 650
        },
        {
          "id": "u-solver2",
          "role": "SOLVER",
          "email": "sara.ahmadi@tech.ir",
          "name": "سارا احمدی",
          "password": "123456",
          "avatar": null,
          "bio": "متخصص حوزه انرژی و بهینه‌سازی",
          "skills": ["انرژی", "بهینه‌سازی", "MATLAB"],
          "reputation": 720
        }
      ];
  
      const orgs = [
        {
          "id": "o-pars",
          "name": "شرکت توسعه فناوری پارس",
          "domains": ["انرژی","IoT"],
          "description": "شرکت پیشرو در حوزه انرژی و اینترنت اشیاء",
          "logo": null,
          "website": "https://parstech.ir",
          "contactInfo": {
            "phone": "+98-21-12345678",
            "address": "تهران، خیابان ولیعصر"
          }
        },
        {
          "id": "o-green",
          "name": "شرکت انرژی سبز",
          "domains": ["انرژی", "محیط زیست"],
          "description": "توسعه‌دهنده راه‌حل‌های انرژی پاک",
          "logo": null,
          "website": "https://greenenergy.ir",
          "contactInfo": {
            "phone": "+98-31-87654321",
            "address": "اصفهان، شهرک صنعتی"
          }
        }
      ];
  
      // Sample challenges
      const challenges = [
        {
          "id": "c-energy",
          "orgId": "o-pars",
          "title": "سامانه مدیریت هوشمند انرژی",
          "problem": "کاهش تلفات و پایش مصرف در مقیاس صنعتی. نیاز به راه‌حلی برای نظارت بر مصرف انرژی و بهینه‌سازی آن در کارخانه‌ها و مراکز صنعتی.",
          "success": "دقت پایش > ۹۵٪، گزارش‌گیری برخط، کاهش ۲۰٪ مصرف انرژی",
          "deliverables": "طرح فنی + PoC + مستندات کامل",
          "reward": 50000000,
          "category": "Energy",
          "deadline": "2024-06-30T23:59:59Z",
          "tags": ["Energy","IoT","بهینه‌سازی"],
          "attachments": [],
          "status": "published",
          "createdAt": "2024-01-15T10:00:00Z",
          "updatedAt": "2024-01-15T10:00:00Z"
        },
        {
          "id": "c-green",
          "orgId": "o-green",
          "title": "پنل خورشیدی هوشمند",
          "problem": "طراحی سیستم ردیابی خورشید برای حداکثر بهره‌وری از انرژی خورشیدی",
          "success": "افزایش ۳۰٪ بازدهی نسبت به پنل‌های ثابت",
          "deliverables": "نمونه اولیه + نرم‌افزار کنترل",
          "reward": 30000000,
          "category": "Energy",
          "deadline": "2024-07-15T23:59:59Z",
          "tags": ["انرژی خورشیدی", "هوش مصنوعی", "رباتیک"],
          "attachments": [],
          "status": "published",
          "createdAt": "2024-01-20T14:30:00Z",
          "updatedAt": "2024-01-20T14:30:00Z"
        }
      ];
  
      // Sample submissions
      const submissions = [
        {
          "id": "sub-1",
          "challengeId": "c-energy",
          "userId": "u-solver",
          "ndaAcceptedAt": "2024-01-16T09:00:00Z",
          "ndaVersion": "1.0",
          "status": "under_review",
          "scores": {
            "fit": 8,
            "feasibility": 7,
            "costTime": 9,
            "innovation": 6,
            "total": 7.9
          },
          "scoredAt": "2024-01-17T10:00:00Z",
          "data": {
            "summary": "راه‌حل مبتنی بر IoT برای پایش هوشمند انرژی",
            "proposal": "استفاده از سنسورهای IoT و الگوریتم‌های یادگیری ماشین برای پیش‌بینی و بهینه‌سازی مصرف انرژی",
            "files": ["proposal.pdf", "technical_specs.docx"],
            "video": "demo.mp4"
          },
          "createdAt": "2024-01-16T09:00:00Z",
          "updatedAt": "2024-01-16T09:00:00Z"
        },
        {
          "id": "sub-2",
          "challengeId": "c-energy",
          "userId": "u-solver2",
          "ndaAcceptedAt": "2024-01-21T11:00:00Z",
          "ndaVersion": "1.0",
          "status": "under_review",
          "scores": {
            "fit": 7,
            "feasibility": 8,
            "costTime": 6,
            "innovation": 8,
            "total": 7.4
          },
          "scoredAt": "2024-01-22T14:00:00Z",
          "data": {
            "summary": "سیستم ردیابی خورشید با کنترل هوشمند",
            "proposal": "طراحی مکانیزم ردیابی دو محوره با کنترل فازی برای حداکثر بهره‌وری انرژی خورشیدی",
            "files": ["draft_proposal.pdf"],
            "video": null
          },
          "createdAt": "2024-01-21T11:00:00Z",
          "updatedAt": "2024-01-21T11:00:00Z"
        },
        {
          "id": "sub-3",
          "challengeId": "c-green",
          "userId": "u-solver",
          "ndaAcceptedAt": "2024-01-25T09:00:00Z",
          "ndaVersion": "1.0",
          "status": "received",
          "data": {
            "summary": "راه‌حل ترکیبی انرژی پاک",
            "proposal": "ترکیب سیستم‌های خورشیدی و بادی برای تأمین انرژی پایدار",
            "files": ["combined_energy_proposal.pdf"],
            "video": "combined_demo.mp4"
          },
          "createdAt": "2024-01-25T09:00:00Z",
          "updatedAt": "2024-01-25T09:00:00Z"
        }
      ];
  
      // Sample messages
      const messages = [
        {
          id: "msg-1",
          submissionId: "sub-1",
          fromUserId: "u-seeker",
          body: "پیشنهاد شما بسیار جالب است. آیا امکان ارائه جزئیات بیشتر در مورد الگوریتم‌های یادگیری ماشین وجود دارد؟",
          createdAt: "2024-01-17T10:00:00Z",
          readAt: "2024-01-17T14:30:00Z"
        },
        {
          id: "msg-2",
          submissionId: "sub-1",
          fromUserId: "u-solver",
          body: "بله، حتماً. من یک مستند فنی کامل آماده کرده‌ام که شامل جزئیات الگوریتم‌ها و نتایج آزمایشات است.",
          createdAt: "2024-01-17T15:00:00Z",
          readAt: null
        },
        {
          id: "msg-3",
          submissionId: "sub-2",
          fromUserId: "u-seeker",
          body: "پیشنهاد شما در مورد سیستم ردیابی خورشیدی بسیار جذاب است. آیا نمونه‌ای از این سیستم را قبلاً پیاده‌سازی کرده‌اید؟",
          createdAt: "2024-01-22T09:15:00Z",
          readAt: null
        },
        {
          id: "msg-4",
          submissionId: "sub-2",
          fromUserId: "u-solver2",
          body: "بله، ما یک نمونه اولیه کوچک در آزمایشگاه دانشگاه پیاده‌سازی کرده‌ایم. کارایی آن حدود ۳۵٪ بهتر از پنل‌های ثابت بود.",
          createdAt: "2024-01-22T11:30:00Z",
          readAt: null
        },
        {
          id: "msg-5",
          submissionId: "sub-3",
          fromUserId: "u-seeker",
          body: "پیشنهاد ترکیبی انرژی شما جالب توجه است. لطفاً در مورد هزینه‌های پیاده‌سازی توضیح دهید.",
          createdAt: "2024-01-26T14:20:00Z",
          readAt: null
        }
      ];
  
      // TESTA Events
      const events = [
        { 
          id: "ev-1", 
          day: 1, 
          track: "Keynote", 
          time: "10:00", 
          title: "افتتاحیه TESTA", 
          speakers: ["دکتر احمدی", "مهندس محمدی"],
          description: "مراسم افتتاحیه نمایشگاه فناوری و نوآوری TESTA",
          location: "سالن اصلی",
          capacity: 500
        },
        {
          id: "ev-2",
          day: 1,
          track: "Energy",
          time: "14:00",
          title: "آینده انرژی در ایران",
          speakers: ["دکتر رضایی"],
          description: "بررسی چالش‌ها و فرصت‌های حوزه انرژی",
          location: "سالن انرژی",
          capacity: 200
        },
        {
          id: "ev-3",
          day: 2,
          track: "IoT",
          time: "11:00",
          title: "اینترنت اشیاء و شهر هوشمند",
          speakers: ["مهندس کریمی", "دکتر نوری"],
          description: "کاربردهای IoT در توسعه شهرهای هوشمند",
          location: "سالن IoT",
          capacity: 150
        }
      ];
      
      const exhibitors = [
        { 
          id: "ex-1", 
          name: "پارس‌تک", 
          boothCode: "A12", 
          category: "Energy",
          description: "نمایشگر راه‌حل‌های انرژی هوشمند",
          logo: null,
          website: "https://parstech.ir",
          contactInfo: {
            phone: "+98-21-12345678",
            email: "info@parstech.ir"
          }
        },
        {
          id: "ex-2",
          name: "شرکت انرژی سبز",
          boothCode: "B08",
          category: "Energy",
          description: "راه‌حل‌های انرژی پاک و تجدیدپذیر",
          logo: null,
          website: "https://greenenergy.ir",
          contactInfo: {
            phone: "+98-31-87654321",
            email: "info@greenenergy.ir"
          }
        },
        {
          id: "ex-3",
          name: "تک‌نو",
          boothCode: "C15",
          category: "IoT",
          description: "پلتفرم‌های IoT و هوش مصنوعی",
          logo: null,
          website: "https://techno.ir",
          contactInfo: {
            phone: "+98-51-11223344",
            email: "info@techno.ir"
          }
        }
      ];
  
      // Sample notifications
      const notifications = [
        {
          id: "notif-1",
          type: "challenge",
          text: "چالش جدید 'سامانه مدیریت هوشمند انرژی' منتشر شد",
          createdAt: "2024-01-15T10:00:00Z",
          read: false,
          userId: "u-solver",
          targetId: "c-energy"
        },
        {
          id: "notif-2",
          type: "message",
          text: "پیام جدید در پیشنهاد شما دریافت شد",
          createdAt: "2024-01-17T10:00:00Z",
          read: true,
          userId: "u-solver",
          targetId: "msg-1"
        },
        {
          id: "notif-3",
          type: "event",
          text: "رویداد 'آینده انرژی در ایران' فردا ساعت ۱۴:۰۰ برگزار می‌شود",
          createdAt: "2024-01-20T09:00:00Z",
          read: false,
          userId: "u-solver",
          targetId: "ev-2"
        }
      ];
  
      // Sample reputation events
      const reputationEvents = [
        {
          id: "rep-1",
          userId: "u-solver",
          type: "submission_created",
          points: 50,
          at: "2024-01-16T09:00:00Z",
          description: "ایجاد پیشنهاد برای چالش 'سامانه مدیریت هوشمند انرژی'"
        },
        {
          id: "rep-2",
          userId: "u-solver",
          type: "message_received",
          points: 10,
          at: "2024-01-17T10:00:00Z",
          description: "دریافت پیام از کارفرما"
        },
        {
          id: "rep-3",
          userId: "u-solver2",
          type: "submission_created",
          points: 50,
          at: "2024-01-21T11:00:00Z",
          description: "ایجاد پیشنهاد برای چالش 'پنل خورشیدی هوشمند'"
        }
      ];
  
      // Initialize all collections (overwrite to ensure consistency during reseed)
      storage.set(KEYS.users, users);
      storage.set(KEYS.orgs, orgs);
      storage.set(KEYS.challenges, challenges);
      storage.set(KEYS.submissions, submissions);
      storage.set(KEYS.messages, messages);
      storage.set(KEYS.events, events);
      storage.set(KEYS.exhibitors, exhibitors);
      storage.set(KEYS.notifications, notifications);
      storage.set(KEYS.reputationEvents, reputationEvents);
      storage.set(KEYS.settings, {
        kiosk: false,
        countdownTarget: "2024-06-20T09:00:00Z", // TESTA start date
        theme: "light",
        language: "fa"
      });
      storage.set(KEYS.session, null);
  
      // mark seeded
      localStorage.setItem(KEYS.seeded, "1");
      console.log('Seeding complete! Users stored:', users.length);

      // Verify data was stored
      const storedUsers = storage.get(KEYS.users, []);
      console.log('Verification - stored users count:', storedUsers.length);
      if (storedUsers.length === 0) {
        console.error('ERROR: Users were not stored properly!');
      } else {
        console.log('Users successfully stored:', storedUsers.map(u => ({email: u.email, role: u.role})));
      }
    }

    // Expose seeding function for debug/reset actions
    window.seedDataOnce = seedDataOnce;
  
    // ================================
    // --- HOOK: useLocalStorage(key) ---
    // ================================
    // Simple helper to bind React state to localStorage
    function useLocalStorage(key, initialValue) {
      const [state, setState] = React.useState(() => storage.get(key, initialValue));
      React.useEffect(() => { storage.set(key, state); }, [key, state]);
      return [state, setState];
    }

    // ================================
    // --- ENHANCED FORM VALIDATION ---
    // ================================
    
    // Form validation utilities
    const validators = {
      required: (value) => {
        if (!value || (typeof value === 'string' && !value.trim())) {
          return 'این فیلد الزامی است';
        }
        return null;
      },
      
      email: (value) => {
        if (!value) return null;
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return emailRegex.test(value) ? null : 'ایمیل نامعتبر است';
      },
      
      minLength: (min) => (value) => {
        if (!value) return null;
        return value.length >= min ? null : `حداقل ${min} کاراکتر مورد نیاز است`;
      },
      
      maxLength: (max) => (value) => {
        if (!value) return null;
        return value.length <= max ? null : `حداکثر ${max} کاراکتر مجاز است`;
      },
      
      pattern: (regex, message) => (value) => {
        if (!value) return null;
        return regex.test(value) ? null : message;
      },
      
      numeric: (value) => {
        if (!value) return null;
        return !isNaN(value) && !isNaN(parseFloat(value)) ? null : 'مقدار باید عددی باشد';
      },
      
      url: (value) => {
        if (!value) return null;
        try {
          new URL(value);
          return null;
        } catch {
          return 'آدرس وب نامعتبر است';
        }
      }
    };

    // Enhanced form validation hook
    function useFormValidation(initialValues, rules) {
      const [values, setValues] = React.useState(initialValues);
      const [errors, setErrors] = React.useState({});
      const [touched, setTouched] = React.useState({});
      const [isSubmitting, setIsSubmitting] = React.useState(false);

      const validateField = React.useCallback((name, value) => {
        const fieldRules = rules[name];
        if (!fieldRules) return null;

        for (const rule of fieldRules) {
          const error = rule(value);
          if (error) return error;
        }
        return null;
      }, [rules]);

      const setValue = React.useCallback((name, value) => {
        setValues(prev => ({ ...prev, [name]: value }));
        
        // Real-time validation for touched fields
        if (touched[name]) {
          const error = validateField(name, value);
          setErrors(prev => ({ ...prev, [name]: error }));
        }
      }, [validateField, touched]);

      const setFieldTouched = React.useCallback((name) => {
        setTouched(prev => ({ ...prev, [name]: true }));
        
        // Validate on blur
        const error = validateField(name, values[name]);
        setErrors(prev => ({ ...prev, [name]: error }));
      }, [validateField, values]);

      const validateAll = React.useCallback(() => {
        const newErrors = {};
        let isValid = true;

        Object.keys(rules).forEach(name => {
          const error = validateField(name, values[name]);
          newErrors[name] = error;
          if (error) isValid = false;
        });

        setErrors(newErrors);
        setTouched(Object.keys(rules).reduce((acc, key) => ({ ...acc, [key]: true }), {}));
        return isValid;
      }, [rules, validateField, values]);

      const reset = React.useCallback(() => {
        setValues(initialValues);
        setErrors({});
        setTouched({});
        setIsSubmitting(false);
      }, [initialValues]);

      return {
        values,
        errors,
        touched,
        isSubmitting,
        setValue,
        setFieldTouched,
        setIsSubmitting,
        validateAll,
        reset,
        isValid: Object.values(errors).every(error => !error)
      };
    }

    // ================================
    // --- KEYBOARD NAVIGATION UTILITIES ---
    // ================================
    
    // Enhanced keyboard navigation hook
    function useKeyboardNavigation(items, options = {}) {
      const {
        loop = true,
        onSelect = () => {},
        orientation = 'vertical'
      } = options;
      
      const [currentIndex, setCurrentIndex] = React.useState(-1);
      
      const handleKeyDown = React.useCallback((event) => {
        const key = event.key;
        const isVertical = orientation === 'vertical';
        const nextKey = isVertical ? 'ArrowDown' : 'ArrowRight';
        const prevKey = isVertical ? 'ArrowUp' : 'ArrowLeft';
        
        switch (key) {
          case nextKey:
            event.preventDefault();
            setCurrentIndex(prev => {
              const next = prev + 1;
              return next >= items.length ? (loop ? 0 : prev) : next;
            });
            break;
            
          case prevKey:
            event.preventDefault();
            setCurrentIndex(prev => {
              const next = prev - 1;
              return next < 0 ? (loop ? items.length - 1 : 0) : next;
            });
            break;
            
          case 'Enter':
          case ' ':
            event.preventDefault();
            if (currentIndex >= 0 && currentIndex < items.length) {
              onSelect(items[currentIndex], currentIndex);
            }
            break;
            
          case 'Home':
            event.preventDefault();
            setCurrentIndex(0);
            break;
            
          case 'End':
            event.preventDefault();
            setCurrentIndex(items.length - 1);
            break;
            
          case 'Escape':
            event.preventDefault();
            setCurrentIndex(-1);
            break;
        }
      }, [items, loop, onSelect, orientation]);
      
      return {
        currentIndex,
        setCurrentIndex,
        handleKeyDown
      };
    }

    // Focus management utilities
    const focusManager = {
      // Store the last focused element for restoration
      lastFocused: null,
      
      // Save current focus
      saveFocus: () => {
        focusManager.lastFocused = document.activeElement;
      },
      
      // Restore saved focus
      restoreFocus: () => {
        if (focusManager.lastFocused && focusManager.lastFocused.focus) {
          focusManager.lastFocused.focus();
          focusManager.lastFocused = null;
        }
      },
      
      // Focus trap for modals
      trapFocus: (element) => {
        const focusableElements = element.querySelectorAll(
          'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
        );
        const firstElement = focusableElements[0];
        const lastElement = focusableElements[focusableElements.length - 1];
        
        const handleTabKey = (e) => {
          if (e.key !== 'Tab') return;
          
          if (e.shiftKey) {
            if (document.activeElement === firstElement) {
              lastElement.focus();
              e.preventDefault();
            }
          } else {
            if (document.activeElement === lastElement) {
              firstElement.focus();
              e.preventDefault();
            }
          }
        };
        
        element.addEventListener('keydown', handleTabKey);
        firstElement?.focus();
        
        return () => {
          element.removeEventListener('keydown', handleTabKey);
        };
      },
      
      // Auto-focus first focusable element
      focusFirst: (element) => {
        const focusable = element.querySelector(
          'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
        );
        focusable?.focus();
      }
    };

    // Skip link component for accessibility
    function SkipLink({ href, children }) {
      return (
        <a
          href={href}
          className="sr-only focus:not-sr-only focus:absolute focus:top-4 focus:left-4 bg-blue-600 text-white px-4 py-2 rounded-md z-50 focus-ring"
          onFocus={(e) => e.target.classList.remove('sr-only')}
          onBlur={(e) => e.target.classList.add('sr-only')}
        >
          {children}
        </a>
      );
    }

    // ================================
    // --- TINY HASH ROUTER ---
    // ================================
    function useHashRouter(defaultRoute = 'home') {
      const getRouteFromHash = () => {
        const hash = window.location.hash.slice(1); // Remove #
        return hash || defaultRoute;
      };

      const [currentRoute, setCurrentRoute] = React.useState(getRouteFromHash);

      React.useEffect(() => {
        const handleHashChange = () => {
          setCurrentRoute(getRouteFromHash());
        };

        window.addEventListener('hashchange', handleHashChange);
        return () => window.removeEventListener('hashchange', handleHashChange);
      }, []);

      const navigate = (route) => {
        window.location.hash = route;
      };

      return [currentRoute, navigate];
    }

    // ================================
    // --- NAVIGATION COMPONENT ---
    // ================================
    function Navigation({ currentRoute, navigate, session, onLogout, kioskMode }) {
      const [mobileMenuOpen, setMobileMenuOpen] = React.useState(false);

      // Get unread message count
      const getUnreadMessageCount = () => {
        if (!session) return 0;
        const messages = JSON.parse(localStorage.getItem('messages') || '[]');
        return messages.filter(msg =>
          msg.fromUserId !== session.userId && !msg.readAt
        ).length;
      };

      // Close mobile menu when clicking outside or on escape
      React.useEffect(() => {
        const handleEscape = (event) => {
          if (event.key === 'Escape' && mobileMenuOpen) {
            setMobileMenuOpen(false);
          }
        };

        const handleClickOutside = (event) => {
          if (mobileMenuOpen && !event.target.closest('nav')) {
            setMobileMenuOpen(false);
          }
        };

        if (mobileMenuOpen) {
          document.addEventListener('keydown', handleEscape);
          document.addEventListener('click', handleClickOutside);
        }

        return () => {
          document.removeEventListener('keydown', handleEscape);
          document.removeEventListener('click', handleClickOutside);
        };
      }, [mobileMenuOpen]);

      // Define navigation items based on user role
      const getNavItems = () => {
        const baseItems = [
          { key: 'home', label: 'خانه', icon: '🏠', public: true }
        ];

        if (!session) {
          // Unauthenticated users
          return [
            ...baseItems,
            { key: 'challenges', label: 'چالش‌ها', icon: '🎯', public: true },
            { key: 'testa-home', label: 'TESTA', icon: '🎪', public: true },
            { key: 'testa-schedule', label: 'برنامه TESTA', icon: '📅', public: true },
            { key: 'testa-events', label: 'رویدادهای TESTA', icon: '🎤', public: true },
            { key: 'testa-booths', label: 'نمایشگاه‌ها', icon: '🏪', public: true }
          ];
        }

        // Authenticated users
        const authenticatedItems = [...baseItems];

        // Role-specific navigation
        if (session.role === 'ADMIN') {
          authenticatedItems.push(
            { key: 'challenges', label: 'چالش‌ها', icon: '🎯' },
            { key: 'admin', label: 'مدیریت', icon: '⚙️' },
            { key: 'testa-home', label: 'TESTA', icon: '🎪' },
            { key: 'testa-schedule', label: 'برنامه TESTA', icon: '📅' },
            { key: 'testa-events', label: 'رویدادهای TESTA', icon: '🎤' },
            { key: 'testa-booths', label: 'نمایشگاه‌ها', icon: '🏪' },
            { key: 'testa-stats', label: 'آمار TESTA', icon: '📊' }
          );
        } else if (session.role === 'SEEKER') {
          const unreadCount = getUnreadMessageCount();
          authenticatedItems.push(
            { key: 'challenges', label: 'چالش‌ها', icon: '🎯' },
            { key: 'create-challenge', label: 'ایجاد چالش', icon: '➕' },
            { key: 'my-challenges', label: 'چالش‌های من', icon: '📝' },
            { key: 'submissions', label: 'مدیریت پیشنهادات', icon: '📊' },
            { key: 'messages', label: unreadCount > 0 ? `پیام‌ها (${unreadCount})` : 'پیام‌ها', icon: '💬' },
            { key: 'profile', label: 'پروفایل سازمان', icon: '🏢' },
            { key: 'testa-home', label: 'TESTA', icon: '🎪' },
            { key: 'testa-schedule', label: 'برنامه TESTA', icon: '📅' },
            { key: 'testa-events', label: 'رویدادهای TESTA', icon: '🎤' },
            { key: 'testa-booths', label: 'نمایشگاه‌ها', icon: '🏪' },
            { key: 'testa-stats', label: 'آمار TESTA', icon: '📊' }
          );
        } else if (session.role === 'SOLVER') {
          const unreadCount = getUnreadMessageCount();
          authenticatedItems.push(
            { key: 'challenges', label: 'چالش‌ها', icon: '🎯' },
            { key: 'my-submissions', label: 'پیشنهادات من', icon: '📋' },
            { key: 'messages', label: unreadCount > 0 ? `پیام‌ها (${unreadCount})` : 'پیام‌ها', icon: '💬' },
            { key: 'profile', label: 'پروفایل', icon: '👤' },
            { key: 'testa-home', label: 'TESTA', icon: '🎪' },
            { key: 'testa-schedule', label: 'برنامه TESTA', icon: '📅' },
            { key: 'testa-events', label: 'رویدادهای TESTA', icon: '🎤' },
            { key: 'testa-booths', label: 'نمایشگاه‌ها', icon: '🏪' },
            { key: 'testa-stats', label: 'آمار TESTA', icon: '📊' }
          );
        }

        return authenticatedItems;
      };

      const navItems = getNavItems();

      const handleLogout = () => {
        if (confirm('آیا می‌خواهید از حساب کاربری خارج شوید؟')) {
          storage.set(KEYS.session, null);
          onLogout();
          navigate('home');
        }
      };

      return (
        <nav className={`bg-white border-b border-gray-200 shadow-sm ${kioskMode?.isKioskMode ? 'h-20 text-lg' : ''}`}>
          <div className={`${kioskMode?.isKioskMode ? 'max-w-7xl' : 'max-w-5xl'} mx-auto px-6`}>
            <div className={`flex items-center justify-between ${kioskMode?.isKioskMode ? 'h-20' : 'h-16'}`}>
              <div className="flex items-center">
                <button
                  onClick={() => navigate('home')}
                  className="text-xl font-bold text-gray-900 hover:text-blue-600 transition-colors focus-ring"
                  aria-label="بازگشت به صفحه اصلی"
                >
                  پلتفرم نوآوری باز
                </button>

                {/* Mobile Menu Toggle */}
                <button
                  onClick={() => setMobileMenuOpen(!mobileMenuOpen)}
                  className="md:hidden ml-4 p-2 rounded-md text-gray-600 hover:text-gray-900 hover:bg-gray-100 focus-ring"
                  aria-label="منوی ناوبری"
                  aria-expanded={mobileMenuOpen}
                >
                  <span className="sr-only">باز کردن منو</span>
                  <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d={mobileMenuOpen ? "M6 18L18 6M6 6l12 12" : "M4 6h16M4 12h16M4 18h16"} />
                  </svg>
                </button>
              </div>
              
              <div className="flex items-center space-x-reverse space-x-4">
                {/* Desktop Navigation Items */}
                <div className="hidden md:flex space-x-reverse space-x-6">
                  {navItems.map(item => (
                    <button
                      key={item.key}
                      onClick={() => navigate(item.key)}
                      className={`touch-target flex items-center px-3 py-2 rounded-md text-sm font-medium transition-colors focus-ring ${
                        currentRoute === item.key
                          ? 'bg-blue-100 text-blue-700'
                          : 'text-gray-600 hover:text-gray-900 hover:bg-gray-50'
                      }`}
                      aria-current={currentRoute === item.key ? 'page' : undefined}
                      aria-label={`رفتن به ${item.label}`}
                    >
                      <span className="ml-2" aria-hidden="true">{item.icon}</span>
                      {item.label}
                    </button>
                  ))}
                </div>

                {/* User Info & Auth */}
                <div className="border-r border-gray-200 pr-4">
                  {session ? (
                    <div className="flex items-center space-x-reverse space-x-3">
                      <div className="text-left">
                        <div className="text-sm font-medium text-gray-900">
                          {kioskMode?.isKioskMode ? maskEmail(session.name) : session.name}
                        </div>
                        <div className="text-xs text-gray-500">
                          {session.role === 'ADMIN' && 'مدیر سیستم'}
                          {session.role === 'SEEKER' && 'جستجوگر'}
                          {session.role === 'SOLVER' && 'حل‌کننده'}
                        </div>
                      </div>
                      <button
                        onClick={handleLogout}
                        className={`touch-target p-2 rounded-md transition-colors focus-ring ${
                          kioskMode?.isKioskMode
                            ? 'text-gray-300 cursor-not-allowed'
                            : 'text-gray-500 hover:text-red-600 hover:bg-red-50'
                        }`}
                        title={kioskMode?.isKioskMode ? "در حالت کیوسک غیرفعال" : "خروج"}
                        disabled={kioskMode?.isKioskMode}
                        aria-label="خروج از حساب کاربری"
                      >
                        🚪
                      </button>
                    </div>
                  ) : (
                    <div className="flex items-center space-x-reverse space-x-2">
                      <button
                        onClick={() => navigate('login')}
                        className="px-3 py-1 text-sm text-gray-600 hover:text-gray-900"
                      >
                        ورود
                      </button>
                      <button
                        onClick={() => navigate('register')}
                        className="px-3 py-1 text-sm bg-blue-600 text-white rounded hover:bg-blue-700"
                      >
                        ثبت‌نام
                      </button>
                    </div>
                  )}
                </div>
              </div>

              {/* Mobile Menu Overlay */}
              {mobileMenuOpen && (
                <div className="md:hidden fixed inset-0 top-16 bg-white border-t border-gray-200 z-40">
                  <div className="px-4 py-6 space-y-4">
                    {/* Mobile Navigation Items */}
                    {navItems.map(item => (
                      <button
                        key={item.key}
                        onClick={() => {
                          navigate(item.key);
                          setMobileMenuOpen(false);
                        }}
                        className={`w-full touch-target flex items-center px-4 py-3 rounded-lg text-base font-medium transition-colors focus-ring ${
                          currentRoute === item.key
                            ? 'bg-blue-100 text-blue-700'
                            : 'text-gray-700 hover:text-gray-900 hover:bg-gray-50'
                        }`}
                        aria-current={currentRoute === item.key ? 'page' : undefined}
                      >
                        <span className="ml-3" aria-hidden="true">{item.icon}</span>
                        {item.label}
                      </button>
                    ))}

                    {/* Mobile Auth Section */}
                    {session && (
                      <div className="border-t border-gray-200 pt-4 mt-4">
                        <div className="flex items-center space-x-reverse space-x-3 mb-4">
                          <div className="text-left">
                            <div className="text-sm font-medium text-gray-900">
                              {kioskMode?.isKioskMode ? maskEmail(session.name) : session.name}
                            </div>
                            <div className="text-xs text-gray-500">
                              {session.role === 'ADMIN' && 'مدیر سیستم'}
                              {session.role === 'SEEKER' && 'جستجوگر'}
                              {session.role === 'SOLVER' && 'حل‌کننده'}
                            </div>
                          </div>
                        </div>
                        <button
                          onClick={() => {
                            onLogout();
                            setMobileMenuOpen(false);
                          }}
                          className={`w-full touch-target p-3 rounded-lg transition-colors focus-ring ${
                            kioskMode?.isKioskMode
                              ? 'text-gray-300 cursor-not-allowed'
                              : 'text-red-600 hover:bg-red-50 hover:text-red-700'
                          }`}
                          disabled={kioskMode?.isKioskMode}
                          aria-label="خروج از حساب کاربری"
                        >
                          🚪 خروج
                        </button>
                      </div>
                    )}

                    {!session && (
                      <div className="border-t border-gray-200 pt-4 mt-4 space-y-3">
                        <button
                          onClick={() => {
                            navigate('login');
                            setMobileMenuOpen(false);
                          }}
                          className="w-full touch-target p-3 rounded-lg bg-blue-600 text-white hover:bg-blue-700 transition-colors focus-ring"
                          aria-label="ورود به حساب کاربری"
                        >
                          🚪 ورود
                        </button>
                        <button
                          onClick={() => {
                            navigate('register');
                            setMobileMenuOpen(false);
                          }}
                          className="w-full touch-target p-3 rounded-lg bg-gray-600 text-white hover:bg-gray-700 transition-colors focus-ring"
                          aria-label="ثبت‌نام حساب جدید"
                        >
                          ثبت‌نام
                        </button>
                      </div>
                    )}
                  </div>
                </div>
              )}
            </div>
          </div>
        </nav>
      );
    }

    // ================================
    // --- UI COMPONENTS ---
    // ================================
    
    // Loading Spinner Component
    function LoadingSpinner({ size = 'md', className = '' }) {
      const sizeClasses = {
        sm: 'w-4 h-4',
        md: 'w-6 h-6',
        lg: 'w-8 h-8',
        xl: 'w-12 h-12'
      };
      
      return (
        <div className={`animate-spin rounded-full border-2 border-current border-t-transparent ${sizeClasses[size]} ${className}`} aria-hidden="true" />
      );
    }
    
    // Button with Loading State
    function ButtonLoader({ children, loading = false, disabled = false, className = '', ...props }) {
      return (
        <button
          {...props}
          disabled={loading || disabled}
          className={`relative inline-flex items-center justify-center gap-2 transition-all duration-200 focus-ring ${className} ${loading || disabled ? 'cursor-not-allowed opacity-70' : ''}`}
        >
          {loading && (
            <LoadingSpinner size="sm" className="absolute" />
          )}
          <span className={loading ? 'opacity-0' : 'opacity-100'}>
            {children}
          </span>
        </button>
      );
    }
    
    // Fullscreen Page Loader using the primary LoadingSpinner
    function PageLoader({ message = 'در حال بارگذاری...' }) {
      return (
        <div className="fixed inset-0 bg-white bg-opacity-90 flex items-center justify-center z-50">
          <div className="text-center">
            <LoadingSpinner size="xl" className="mx-auto mb-4" />
            <p className="text-gray-600 text-lg">{message}</p>
          </div>
        </div>
      );
    }
    
    // Form Field Component
    function FormField({ label, required = false, error, hint, children, className = '' }) {
      const fieldId = React.useId();
      
      return (
        <div className={`space-y-2 ${className}`}>
          {label && (
            <label 
              htmlFor={fieldId} 
              className={`block text-sm font-medium ${error ? 'text-red-700' : 'text-gray-700'}`}
            >
              {label}
              {required && <span className="text-red-500 mr-1" aria-label="ضروری">*</span>}
            </label>
          )}
          {React.cloneElement(children, { id: fieldId, 'aria-invalid': !!error })}
          {error && (
            <p className="text-sm text-red-600 flex items-center gap-1" role="alert">
              <span aria-hidden="true">⚠️</span>
              {error}
            </p>
          )}
          {hint && !error && (
            <p className="text-sm text-gray-500">{hint}</p>
          )}
        </div>
      );
    }
    
    // Enhanced Text Input Component
    function TextInput({ 
      type = 'text', 
      value = '', 
      onChange, 
      error = false, 
      disabled = false,
      placeholder = '', 
      className = '',
      'aria-describedby': ariaDescribedBy,
      ...props 
    }) {
      const [focused, setFocused] = React.useState(false);
      const [showPassword, setShowPassword] = React.useState(false);
      
      const isPassword = type === 'password';
      const inputType = isPassword && showPassword ? 'text' : type;
      
      return (
        <div className="relative">
          <input
            {...props}
            type={inputType}
            value={value}
            onChange={onChange}
            disabled={disabled}
            placeholder={placeholder}
            className={`
              w-full px-4 py-3 border-2 rounded-lg transition-all duration-200
              ${error 
                ? 'border-red-300 focus:border-red-500 focus:ring-2 focus:ring-red-200' 
                : focused 
                  ? 'border-blue-500 focus:border-blue-500 focus:ring-2 focus:ring-blue-200'
                  : 'border-gray-300 hover:border-gray-400 focus:border-blue-500 focus:ring-2 focus:ring-blue-200'
              }
              ${disabled ? 'bg-gray-50 text-gray-500 cursor-not-allowed' : 'bg-white'}
              ${className}
            `}
            onFocus={() => setFocused(true)}
            onBlur={() => setFocused(false)}
            aria-describedby={ariaDescribedBy}
          />
          
          {/* Password visibility toggle */}
          {isPassword && value && (
            <button
              type="button"
              onClick={() => setShowPassword(!showPassword)}
              className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700 focus:outline-none focus:text-gray-700"
              aria-label={showPassword ? 'مخفی کردن رمز عبور' : 'نمایش رمز عبور'}
              tabIndex={0}
            >
              {showPassword ? '🙈' : '👁️'}
            </button>
          )}
          
          {/* Loading indicator for async validation */}
          {props.validating && (
            <div className="absolute left-3 top-1/2 transform -translate-y-1/2">
              <LoadingSpinner size="sm" className="text-blue-500" />
            </div>
          )}
        </div>
      );
    }
    
    // Toast Notification Component
    function ToastContainer({ toasts, onRemoveToast }) {
      return (
        <div className="fixed top-4 right-4 z-50 space-y-2" role="alert" aria-live="polite">
          {toasts.map((toast) => (
            <Toast key={toast.id} toast={toast} onRemove={() => onRemoveToast(toast.id)} />
          ))}
        </div>
      );
    }
    
    function Toast({ toast, onRemove }) {
      React.useEffect(() => {
        if (toast.autoRemove !== false) {
          const timer = setTimeout(onRemove, toast.duration || 5000);
          return () => clearTimeout(timer);
        }
      }, [toast, onRemove]);
      
      const typeClasses = {
        success: 'bg-green-500 text-white',
        error: 'bg-red-500 text-white',
        warning: 'bg-yellow-500 text-white',
        info: 'bg-blue-500 text-white'
      };
      
      const icons = {
        success: '✅',
        error: '❌',
        warning: '⚠️',
        info: 'ℹ️'
      };
      
      return (
        <div className={`
          animate-slide-in-right p-4 rounded-lg shadow-lg max-w-sm w-full
          ${typeClasses[toast.type] || typeClasses.info}
        `}>
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-2">
              <span aria-hidden="true">{icons[toast.type] || icons.info}</span>
              <span className="font-medium">{toast.message}</span>
            </div>
            <button
              onClick={onRemove}
              className="text-white hover:text-gray-200 focus:outline-none focus:text-gray-200"
              aria-label="بستن اعلان"
            >
              ✕
            </button>
          </div>
        </div>
      );
    }
    
    // Skeleton Loader Component
    function SkeletonLoader({ className = '', lines = 3, avatar = false }) {
      return (
        <div className={`animate-pulse ${className}`}>
          {avatar && (
            <div className="flex items-center space-x-4 space-x-reverse mb-4">
              <div className="w-12 h-12 bg-gray-300 rounded-full"></div>
              <div className="flex-1">
                <div className="h-4 bg-gray-300 rounded w-1/2 mb-2"></div>
                <div className="h-3 bg-gray-300 rounded w-1/3"></div>
              </div>
            </div>
          )}
          <div className="space-y-3">
            {Array.from({ length: lines }).map((_, i) => (
              <div key={i} className={`h-4 bg-gray-300 rounded ${
                i === lines - 1 ? 'w-2/3' : 'w-full'
              }`}></div>
            ))}
          </div>
        </div>
      );
    }
    
    // Progress Indicator Component
    function ProgressBar({ progress, className = '', showPercentage = true }) {
      return (
        <div className={`w-full bg-gray-200 rounded-full overflow-hidden ${className}`}>
          <div 
            className="h-2 bg-blue-600 rounded-full transition-all duration-300 ease-out"
            style={{ width: `${Math.min(100, Math.max(0, progress))}%` }}
            role="progressbar"
            aria-valuenow={progress}
            aria-valuemin="0"
            aria-valuemax="100"
          >
            {showPercentage && (
              <span className="sr-only">{Math.round(progress)}% تکمیل شده</span>
            )}
          </div>
        </div>
      );
    }
    
    // Enhanced Modal Component
    function Modal({ isOpen, onClose, title, children, size = 'md', className = '' }) {
      const [isAnimating, setIsAnimating] = React.useState(false);
      
      const sizeClasses = {
        sm: 'max-w-md',
        md: 'max-w-lg',
        lg: 'max-w-2xl',
        xl: 'max-w-4xl'
      };
      
      const modalRef = React.useRef(null);
      const removeFocusTrap = React.useRef(null);
      
      React.useEffect(() => {
        if (isOpen) {
          setIsAnimating(true);
          document.body.style.overflow = 'hidden';
          
          // Save focus and set up focus trap
          focusManager.saveFocus();
          
          // Set up focus trap after modal renders
          setTimeout(() => {
            if (modalRef.current) {
              removeFocusTrap.current = focusManager.trapFocus(modalRef.current);
            }
          }, 100);
        } else {
          document.body.style.overflow = 'unset';
          
          // Remove focus trap and restore focus
          if (removeFocusTrap.current) {
            removeFocusTrap.current();
            removeFocusTrap.current = null;
          }
          focusManager.restoreFocus();
        }
        
        return () => {
          document.body.style.overflow = 'unset';
          if (removeFocusTrap.current) {
            removeFocusTrap.current();
          }
        };
      }, [isOpen]);
      
      React.useEffect(() => {
        const handleEscape = (e) => {
          if (e.key === 'Escape' && isOpen) {
            onClose();
          }
        };
        
        if (isOpen) {
          document.addEventListener('keydown', handleEscape);
        }
        
        return () => {
          document.removeEventListener('keydown', handleEscape);
        };
      }, [isOpen, onClose]);
      
      if (!isOpen) return null;
      
      return (
        <div 
          className={`fixed inset-0 z-50 flex items-center justify-center p-4 ${isAnimating ? 'animate-fade-in' : ''}`}
          onClick={(e) => e.target === e.currentTarget && onClose()}
          role="dialog"
          aria-modal="true"
          aria-labelledby={title ? 'modal-title' : undefined}
        >
          {/* Backdrop */}
          <div className="absolute inset-0 bg-black bg-opacity-50 animate-fade-in"></div>
          
          {/* Modal Content */}
          <div 
            ref={modalRef}
            className={`relative bg-white rounded-xl shadow-xl w-full animate-scale-in ${sizeClasses[size]} ${className}`}
          >
            {/* Header */}
            {title && (
              <div className="flex items-center justify-between p-6 border-b border-gray-200">
                <h2 id="modal-title" className="text-xl font-semibold text-gray-900">
                  {title}
                </h2>
                <button
                  onClick={onClose}
                  className="text-gray-400 hover:text-gray-600 focus:outline-none focus:text-gray-600 transition-colors"
                  aria-label="بستن"
                >
                  <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                  </svg>
                </button>
              </div>
            )}
            
            {/* Content */}
            <div className="p-6">
              {children}
            </div>
          </div>
        </div>
      );
    }
    
    // ================================
    // --- AUTH COMPONENTS ---
    // ================================
    function LoginForm({ onLogin }) {
      const [email, setEmail] = React.useState('');
      const [password, setPassword] = React.useState('');
      const [error, setError] = React.useState('');
      const [loading, setLoading] = React.useState(false);

      // Demo accounts for quick testing
      const demoAccounts = [
        { email: 'admin@platform.ir', password: '123456', role: 'ADMIN', label: 'مدیر سیستم' },
        { email: 'info@parstech.ir', password: '123456', role: 'SEEKER', label: 'پارس‌تک (جستجوگر)' },
        { email: 'a.mohammadi@university.ac.ir', password: '123456', role: 'SOLVER', label: 'امیر محمدی (حل‌کننده)' },
        { email: 'sara.ahmadi@tech.ir', password: '123456', role: 'SOLVER', label: 'سارا احمدی (حل‌کننده)' }
      ];

      const fillDemo = (account) => {
        setEmail(account.email);
        setPassword(account.password);
        setError('');
      };

      const handleSubmit = async (e) => {
        e.preventDefault();
        setLoading(true);
        setError('');

        try {
          // Get users from localStorage
          const users = storage.get(KEYS.users, []);
          console.log('Login attempt - Email:', email, 'Users found:', users.length);

          const user = users.find(u => u.email === email && u.password === password);
          if (!user) {
            console.log('User not found. Available users:', users.map(u => ({email: u.email, role: u.role})));
          }

          if (!user) {
            setError('ایمیل یا رمز عبور اشتباه است');
            return;
          }

          // Set session
          const session = {
            userId: user.id,
            email: user.email,
            name: user.name,
            role: user.role,
            orgId: user.orgId || null,
            loginAt: new Date().toISOString()
          };

          storage.set(KEYS.session, session);
          onLogin(session);

        } catch (err) {
          setError('خطا در ورود به سیستم');
        } finally {
          setLoading(false);
        }
      };

      // Debug: verify component references
      try {
        console.debug('LoginForm render - component types:', {
          FormField: typeof FormField,
          TextInput: typeof TextInput,
          ButtonLoader: typeof ButtonLoader
        });
      } catch (e) {
        console.warn('LoginForm debug failed:', e);
      }

      return (
        <div className="max-w-md mx-auto">
          <div className="bg-white rounded-xl shadow-lg p-8">
            <div className="text-center mb-6">
              <h2 className="text-2xl font-bold text-gray-900 mb-2">ورود به سیستم</h2>
              <p className="text-gray-600">به پلتفرم نوآوری باز تستا خوش آمدید</p>
            </div>

            {/* Demo Accounts */}
            <div className="mb-6 p-4 bg-blue-50 rounded-lg">
              <h3 className="font-medium text-blue-800 mb-3">حساب‌های نمونه:</h3>
              <div className="space-y-2">
                {demoAccounts.map((account, index) => (
                  <button
                    key={index}
                    onClick={() => fillDemo(account)}
                    className="w-full text-right p-2 text-sm bg-white border border-blue-200 rounded hover:bg-blue-50 transition-colors"
                  >
                    <div className="font-medium text-blue-900">{account.label}</div>
                    <div className="text-blue-600 text-xs">{account.email}</div>
                  </button>
                ))}
              </div>
            </div>

            <form onSubmit={handleSubmit} className="space-y-4" noValidate>
              <FormField
                label="ایمیل"
                required
                error={error && error.includes('ایمیل') ? error : undefined}
              >
                <TextInput
                  id="login-email"
                  type="email"
                  value={email}
                  onChange={(e) => {
                    setEmail(e.target.value);
                    if (error) setError('');
                  }}
                  error={error && error.includes('ایمیل')}
                  placeholder="email@example.com"
                  autoComplete="email"
                  aria-describedby="login-email-help"
                />
                <div id="login-email-help" className="sr-only">
                  آدرس ایمیل خود را وارد کنید
                </div>
              </FormField>

              <FormField
                label="رمز عبور"
                required
                error={error && error.includes('رمز عبور') ? error : undefined}
              >
                <TextInput
                  id="login-password"
                  type="password"
                  value={password}
                  onChange={(e) => {
                    setPassword(e.target.value);
                    if (error) setError('');
                  }}
                  error={error && error.includes('رمز عبور')}
                  placeholder="رمز عبور"
                  autoComplete="current-password"
                  aria-describedby="login-password-help"
                />
                <div id="login-password-help" className="sr-only">
                  رمز عبور خود را وارد کنید
                </div>
              </FormField>

              <FormField>
                <ButtonLoader
                  type="submit"
                  loading={loading}
                  disabled={!email || !password}
                  className="w-full py-3 px-4 bg-blue-600 text-white rounded-lg hover:bg-blue-700 focus:ring-2 focus:ring-blue-500 disabled:opacity-50 transition-colors"
                  aria-describedby="login-submit-help"
                >
                  {loading ? 'در حال ورود...' : 'ورود'}
                </ButtonLoader>
                <div id="login-submit-help" className="sr-only">
                  برای ورود به سیستم کلیک کنید
                </div>
              </FormField>
            </form>

            <div className="mt-6 text-center">
              <p className="text-gray-600 text-sm">
                حساب کاربری ندارید؟{' '}
                <button 
                  onClick={() => window.location.hash = 'register'}
                  className="text-blue-600 hover:underline"
                >
                  ثبت‌نام کنید
                </button>
              </p>
            </div>
          </div>
        </div>
      );
    }

    function RegistrationForm({ type = 'solver' }) {
      const [formData, setFormData] = React.useState({
        name: '',
        email: '',
        password: '',
        confirmPassword: '',
        // Solver specific
        bio: '',
        skills: '',
        // Seeker specific (org request)
        orgName: '',
        orgDomains: '',
        orgDescription: '',
        orgWebsite: '',
        orgPhone: '',
        orgAddress: ''
      });

      const [error, setError] = React.useState('');
      const [success, setSuccess] = React.useState(false);
      const [loading, setLoading] = React.useState(false);

      const handleSubmit = async (e) => {
        e.preventDefault();
        setLoading(true);
        setError('');

        try {
          // Validation
          if (formData.password !== formData.confirmPassword) {
            setError('رمز عبور و تکرار آن یکسان نیستند');
            return;
          }

          if (formData.password.length < 6) {
            setError('رمز عبور باید حداقل ۶ کاراکتر باشد');
            return;
          }

          const users = storage.get(KEYS.users, []);
          
          // Check if email already exists
          if (users.find(u => u.email === formData.email)) {
            setError('این ایمیل قبلاً ثبت شده است');
            return;
          }

          if (type === 'solver') {
            // Create new solver user
            const newUser = {
              id: `u-${Date.now()}`,
              role: 'SOLVER',
              email: formData.email,
              name: formData.name,
              password: formData.password,
              avatar: null,
              bio: formData.bio || 'حل‌کننده جدید',
              skills: formData.skills ? formData.skills.split(',').map(s => s.trim()) : [],
              reputation: 0,
              createdAt: new Date().toISOString()
            };

            users.push(newUser);
            storage.set(KEYS.users, users);

            setSuccess(true);

          } else if (type === 'seeker') {
            // Create organization request (pending approval)
            const orgs = storage.get(KEYS.orgs, []);
            const newOrg = {
              id: `o-${Date.now()}`,
              name: formData.orgName,
              domains: formData.orgDomains ? formData.orgDomains.split(',').map(d => d.trim()) : [],
              description: formData.orgDescription,
              logo: null,
              website: formData.orgWebsite,
              contactInfo: {
                phone: formData.orgPhone,
                address: formData.orgAddress
              },
              status: 'pending', // Requires admin approval
              createdAt: new Date().toISOString()
            };

            // Create seeker user (also pending)
            const newUser = {
              id: `u-${Date.now()}`,
              role: 'SEEKER',
              email: formData.email,
              name: formData.name,
              password: formData.password,
              orgId: newOrg.id,
              avatar: null,
              bio: `نماینده ${formData.orgName}`,
              skills: ['مدیریت', 'تعریف چالش'],
              reputation: 0,
              status: 'pending', // Requires admin approval
              createdAt: new Date().toISOString()
            };

            orgs.push(newOrg);
            users.push(newUser);
            storage.set(KEYS.orgs, orgs);
            storage.set(KEYS.users, users);

            // Create notification for admin
            const notifications = storage.get(KEYS.notifications, []);
            notifications.push({
              id: `notif-${Date.now()}`,
              type: 'org_request',
              text: `درخواست تأیید سازمان جدید: ${formData.orgName} (${formData.name})`,
              createdAt: new Date().toISOString(),
              read: false,
              userId: 'u-admin',
              targetId: newOrg.id
            });
            storage.set(KEYS.notifications, notifications);

            setSuccess(true);
          }

        } catch (err) {
          setError('خطا در ثبت‌نام');
        } finally {
          setLoading(false);
        }
      };

      const updateField = (field, value) => {
        setFormData(prev => ({ ...prev, [field]: value }));
      };

      if (success) {
        return (
          <div className="max-w-md mx-auto">
            <div className="bg-white rounded-xl shadow-lg p-8 text-center">
              <div className="text-6xl mb-4">✅</div>
              <h2 className="text-2xl font-bold text-green-600 mb-4">
                {type === 'solver' ? 'ثبت‌نام موفق!' : 'درخواست ارسال شد!'}
              </h2>
              <p className="text-gray-600 mb-6">
                {type === 'solver' 
                  ? 'حساب کاربری شما ایجاد شد. اکنون می‌توانید وارد شوید.'
                  : 'درخواست سازمان شما برای تأیید ارسال شد. پس از تأیید مدیر می‌توانید وارد شوید.'
                }
              </p>
              <button
                onClick={() => window.location.hash = 'login'}
                className="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
              >
                رفتن به صفحه ورود
              </button>
            </div>
          </div>
        );
      }

      return (
        <div className="max-w-lg mx-auto">
          <div className="bg-white rounded-xl shadow-lg p-8">
            <div className="text-center mb-6">
              <h2 className="text-2xl font-bold text-gray-900 mb-2">
                {type === 'solver' ? 'ثبت‌نام حل‌کننده' : 'درخواست سازمان'}
              </h2>
              <p className="text-gray-600">
                {type === 'solver' 
                  ? 'برای شرکت در چالش‌ها ثبت‌نام کنید'
                  : 'برای انتشار چالش‌های فناوری درخواست دهید'
                }
              </p>
            </div>

            <form onSubmit={handleSubmit} className="space-y-4">
              {/* Common fields */}
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  نام و نام خانوادگی
                </label>
                <input
                  type="text"
                  value={formData.name}
                  onChange={(e) => updateField('name', e.target.value)}
                  className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                  required
                />
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  ایمیل
                </label>
                <input
                  type="email"
                  value={formData.email}
                  onChange={(e) => updateField('email', e.target.value)}
                  className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                  required
                />
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  رمز عبور
                </label>
                <input
                  type="password"
                  value={formData.password}
                  onChange={(e) => updateField('password', e.target.value)}
                  className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                  required
                />
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  تکرار رمز عبور
                </label>
                <input
                  type="password"
                  value={formData.confirmPassword}
                  onChange={(e) => updateField('confirmPassword', e.target.value)}
                  className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                  required
                />
              </div>

              {/* Solver specific fields */}
              {type === 'solver' && (
                <>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      معرفی خودتان
                    </label>
                    <textarea
                      value={formData.bio}
                      onChange={(e) => updateField('bio', e.target.value)}
                      className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                      rows="3"
                      placeholder="درباره تخصص و تجربیات خود بنویسید"
                    />
                  </div>

                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      مهارت‌ها (با کاما جدا کنید)
                    </label>
                    <input
                      type="text"
                      value={formData.skills}
                      onChange={(e) => updateField('skills', e.target.value)}
                      className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                      placeholder="مثال: پایتون، هوش مصنوعی، یادگیری ماشین"
                    />
                  </div>
                </>
              )}

              {/* Seeker specific fields */}
              {type === 'seeker' && (
                <>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      نام سازمان
                    </label>
                    <input
                      type="text"
                      value={formData.orgName}
                      onChange={(e) => updateField('orgName', e.target.value)}
                      className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                      required
                    />
                  </div>

                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      حوزه‌های فعالیت (با کاما جدا کنید)
                    </label>
                    <input
                      type="text"
                      value={formData.orgDomains}
                      onChange={(e) => updateField('orgDomains', e.target.value)}
                      className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                      placeholder="مثال: انرژی، IoT، هوش مصنوعی"
                      required
                    />
                  </div>

                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      معرفی سازمان
                    </label>
                    <textarea
                      value={formData.orgDescription}
                      onChange={(e) => updateField('orgDescription', e.target.value)}
                      className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                      rows="3"
                      placeholder="درباره فعالیت‌ها و اهداف سازمان بنویسید"
                      required
                    />
                  </div>

                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      وب‌سایت
                    </label>
                    <input
                      type="url"
                      value={formData.orgWebsite}
                      onChange={(e) => updateField('orgWebsite', e.target.value)}
                      className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                      placeholder="https://example.com"
                    />
                  </div>

                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      تلفن تماس
                    </label>
                    <input
                      type="tel"
                      value={formData.orgPhone}
                      onChange={(e) => updateField('orgPhone', e.target.value)}
                      className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                      placeholder="+98-21-12345678"
                    />
                  </div>

                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      آدرس
                    </label>
                    <input
                      type="text"
                      value={formData.orgAddress}
                      onChange={(e) => updateField('orgAddress', e.target.value)}
                      className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                      placeholder="آدرس کامل سازمان"
                    />
                  </div>
                </>
              )}

              {error && (
                <div className="p-3 bg-red-50 border border-red-200 rounded-lg">
                  <p className="text-red-700 text-sm">{error}</p>
                </div>
              )}

              <button
                type="submit"
                disabled={loading}
                className="w-full py-2 px-4 bg-blue-600 text-white rounded-lg hover:bg-blue-700 focus:ring-2 focus:ring-blue-500 disabled:opacity-50 transition-colors"
              >
                {loading ? 'در حال ثبت‌نام...' : 'ثبت‌نام'}
              </button>
            </form>

            <div className="mt-6 text-center">
              <p className="text-gray-600 text-sm">
                قبلاً ثبت‌نام کرده‌اید؟{' '}
                <button 
                  onClick={() => window.location.hash = 'login'}
                  className="text-blue-600 hover:underline"
                >
                  وارد شوید
                </button>
              </p>
              
              {type === 'solver' && (
                <p className="text-gray-600 text-sm mt-2">
                  سازمان هستید؟{' '}
                  <button 
                    onClick={() => window.location.hash = 'register-seeker'}
                    className="text-blue-600 hover:underline"
                  >
                    درخواست سازمان
                  </button>
                </p>
              )}
              
              {type === 'seeker' && (
                <p className="text-gray-600 text-sm mt-2">
                  حل‌کننده هستید؟{' '}
                  <button 
                    onClick={() => window.location.hash = 'register'}
                    className="text-blue-600 hover:underline"
                  >
                    ثبت‌نام حل‌کننده
                  </button>
                </p>
              )}
            </div>
          </div>
        </div>
      );
    }

    // ================================
    // --- PAGE COMPONENTS ---
    // ================================
    function HomePage({ users, challenges, submissions, events, exhibitors }) {
      return (
        <div className="space-y-6">
          <header className="text-center py-8">
            <h1 className="text-3xl font-bold text-gray-900 mb-4">
              به پلتفرم نوآوری باز تستا خوش آمدید
            </h1>
            <p className="text-lg text-gray-600 max-w-2xl mx-auto">
              محیطی برای ارتباط بین شرکت‌ها و نوآوران جهت حل چالش‌های فناوری
            </p>
          </header>

          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <div className="bg-gradient-to-br from-blue-50 to-blue-100 p-6 rounded-xl">
              <div className="flex items-center justify-between mb-4">
                <h3 className="font-semibold text-blue-800">کاربران</h3>
                <span className="text-2xl">👥</span>
              </div>
              <p className="text-3xl font-bold text-blue-900">{users.length}</p>
              <p className="text-sm text-blue-600">کاربر فعال</p>
            </div>

            <div className="bg-gradient-to-br from-green-50 to-green-100 p-6 rounded-xl">
              <div className="flex items-center justify-between mb-4">
                <h3 className="font-semibold text-green-800">چالش‌ها</h3>
                <span className="text-2xl">🎯</span>
              </div>
              <p className="text-3xl font-bold text-green-900">{challenges.length}</p>
              <p className="text-sm text-green-600">چالش فعال</p>
            </div>

            <div className="bg-gradient-to-br from-purple-50 to-purple-100 p-6 rounded-xl">
              <div className="flex items-center justify-between mb-4">
                <h3 className="font-semibold text-purple-800">پیشنهادات</h3>
                <span className="text-2xl">📝</span>
              </div>
              <p className="text-3xl font-bold text-purple-900">{submissions.length}</p>
              <p className="text-sm text-purple-600">پیشنهاد ارسال شده</p>
            </div>

            <div className="bg-gradient-to-br from-orange-50 to-orange-100 p-6 rounded-xl">
              <div className="flex items-center justify-between mb-4">
                <h3 className="font-semibold text-orange-800">رویدادها</h3>
                <span className="text-2xl">📅</span>
              </div>
              <p className="text-3xl font-bold text-orange-900">{events.length}</p>
              <p className="text-sm text-orange-600">رویداد TESTA</p>
            </div>

            <div className="bg-gradient-to-br from-red-50 to-red-100 p-6 rounded-xl">
              <div className="flex items-center justify-between mb-4">
                <h3 className="font-semibold text-red-800">نمایشگاه‌ها</h3>
                <span className="text-2xl">🏪</span>
              </div>
              <p className="text-3xl font-bold text-red-900">{exhibitors.length}</p>
              <p className="text-sm text-red-600">غرفه نمایشگاهی</p>
            </div>

            <div className="bg-gradient-to-br from-gray-50 to-gray-100 p-6 rounded-xl">
              <div className="flex items-center justify-between mb-4">
                <h3 className="font-semibold text-gray-800">وضعیت</h3>
                <span className="text-2xl">✅</span>
              </div>
              <p className="text-lg font-bold text-gray-900">آماده</p>
              <p className="text-sm text-gray-600">سیستم فعال</p>
            </div>
          </div>

          <div className="bg-white rounded-xl shadow p-6">
            <h2 className="font-semibold text-lg mb-4">درباره پلتفرم</h2>
            <div className="grid md:grid-cols-2 gap-6">
              <div>
                <h3 className="font-medium mb-2">برای شرکت‌ها</h3>
                <ul className="text-sm text-gray-600 space-y-1">
                  <li>• انتشار چالش‌های فناوری</li>
                  <li>• دسترسی به نوآوران مستعد</li>
                  <li>• مدیریت فرآیند انتخاب</li>
                  <li>• ارتباط مستقیم با حل‌کنندگان</li>
                </ul>
              </div>
              <div>
                <h3 className="font-medium mb-2">برای نوآوران</h3>
                <ul className="text-sm text-gray-600 space-y-1">
                  <li>• مشاهده چالش‌های جذاب</li>
                  <li>• ارسال پیشنهادات خلاقانه</li>
                  <li>• کسب امتیاز و اعتبار</li>
                  <li>• شرکت در نمایشگاه TESTA</li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      );
    }

    function ChallengesPage({ challenges, orgs }) {
      return (
        <div className="space-y-6">
          <header className="text-center py-6">
            <h1 className="text-2xl font-bold text-gray-900 mb-2">چالش‌های فناوری</h1>
            <p className="text-gray-600">فرصت‌های همکاری و نوآوری</p>
          </header>

          <div className="grid gap-6">
            {challenges.map(challenge => {
              const org = orgs.find(o => o.id === challenge.orgId);
              return (
                <div key={challenge.id} className="bg-white rounded-xl shadow hover:shadow-lg transition-shadow p-6">
                  <div className="flex items-start justify-between mb-4">
                    <div className="flex-1">
                      <h3 className="text-lg font-semibold text-gray-900 mb-2">
                        {challenge.title}
                      </h3>
                      <p className="text-sm text-gray-600 mb-1">
                        {org?.name || 'سازمان نامشخص'}
                      </p>
                      <div className="flex items-center gap-2">
                        <span className="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded-full">
                          {challenge.category}
                        </span>
                        <span className={`px-2 py-1 text-xs rounded-full ${
                          challenge.status === 'published' 
                            ? 'bg-green-100 text-green-800' 
                            : 'bg-gray-100 text-gray-800'
                        }`}>
                          {challenge.status === 'published' ? 'منتشر شده' : challenge.status}
                        </span>
                      </div>
                    </div>
                    <div className="text-left">
                      <div className="text-lg font-bold text-green-600">
                        {challenge.reward.toLocaleString('fa-IR')} تومان
                      </div>
                      {challenge.deadline && (
                        <div className="text-xs text-gray-500 mt-1">
                          مهلت: {new Date(challenge.deadline).toLocaleDateString('fa-IR')}
                        </div>
                      )}
                    </div>
                  </div>

                  <p className="text-gray-700 mb-4 leading-relaxed">
                    {challenge.problem}
                  </p>

                  {challenge.success && (
                    <div className="mb-4 p-3 bg-green-50 rounded-lg">
                      <h4 className="font-medium text-green-800 mb-1">معیارهای موفقیت:</h4>
                      <p className="text-green-700 text-sm">{challenge.success}</p>
                    </div>
                  )}

                  <div className="flex items-center justify-between">
                    <div className="flex flex-wrap gap-1">
                      {challenge.tags?.map(tag => (
                        <span key={tag} className="px-2 py-1 bg-gray-100 text-gray-700 text-xs rounded">
                          {tag}
                        </span>
                      ))}
                    </div>
                    <button className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                      مشاهده جزئیات
                    </button>
                  </div>
                </div>
              );
            })}
          </div>

          {challenges.length === 0 && (
            <div className="text-center py-12">
              <div className="text-4xl mb-4">🎯</div>
              <p className="text-gray-500">هیچ چالشی در حال حاضر منتشر نشده است</p>
            </div>
          )}
        </div>
      );
    }

    function TESTAPage({ events, exhibitors }) {
      // Redirect to new TESTA Home page
      React.useEffect(() => {
        window.location.hash = 'testa-home';
      }, []);

      return (
        <div className="text-center py-12">
          <div className="text-4xl mb-4">🔄</div>
          <p className="text-gray-500">در حال انتقال به صفحه جدید TESTA...</p>
        </div>
      );
    }

    // ================================
    // --- PROFILE COMPONENTS ---
    // ================================
    function SolverProfile({ user }) {
      return (
        <div className="space-y-6">
          <header className="text-center py-6">
            <h1 className="text-2xl font-bold text-gray-900 mb-2">پروفایل حل‌کننده</h1>
            <p className="text-gray-600">{user.name}</p>
          </header>

          <div className="grid md:grid-cols-2 gap-6">
            {/* Basic Info */}
            <div className="bg-white rounded-xl shadow p-6">
              <h2 className="text-lg font-semibold mb-4">اطلاعات پایه</h2>
              <div className="space-y-3">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">نام و نام خانوادگی</label>
                  <p className="text-gray-900">{user.name}</p>
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">ایمیل</label>
                  <p className="text-gray-900">{user.email}</p>
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">امتیاز اعتبار</label>
                  <p className="text-gray-900">{user.reputation || 0}</p>
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">وضعیت</label>
                  <span className={`px-2 py-1 text-xs rounded-full ${
                    user.status === 'approved' ? 'bg-green-100 text-green-800' :
                    user.status === 'pending' ? 'bg-yellow-100 text-yellow-800' :
                    'bg-gray-100 text-gray-800'
                  }`}>
                    {user.status === 'approved' ? 'تأیید شده' :
                     user.status === 'pending' ? 'در انتظار تأیید' :
                     user.status || 'فعال'}
                  </span>
                </div>
              </div>
            </div>

            {/* Bio & Skills */}
            <div className="bg-white rounded-xl shadow p-6">
              <h2 className="text-lg font-semibold mb-4">بیوگرافی و مهارت‌ها</h2>
              <div className="space-y-3">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">درباره من</label>
                  <p className="text-gray-700 leading-relaxed">
                    {user.bio || 'بیوگرافی وارد نشده است.'}
                  </p>
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">مهارت‌ها</label>
                  <div className="flex flex-wrap gap-1">
                    {user.skills?.length > 0 ? (
                      user.skills.map((skill, index) => (
                        <span key={index} className="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded">
                          {skill}
                        </span>
                      ))
                    ) : (
                      <p className="text-gray-500 text-sm">مهارتی وارد نشده است.</p>
                    )}
                  </div>
                </div>
              </div>
            </div>
          </div>

          {/* Portfolio/Projects */}
          <div className="bg-white rounded-xl shadow p-6">
            <h2 className="text-lg font-semibold mb-4">پورتفولیو</h2>
            <div className="text-center py-8">
              <div className="text-4xl mb-4">📁</div>
              <p className="text-gray-500">پورتفولیو در مرحله بعدی اضافه خواهد شد</p>
              <p className="text-sm text-gray-400 mt-2">شامل پروژه‌های قبلی، گواهی‌نامه‌ها و نمونه کارها</p>
            </div>
          </div>
        </div>
      );
    }

    function SeekerProfile({ user, org }) {
      if (!org) {
        return (
          <div className="text-center py-12">
            <div className="text-4xl mb-4">🏢</div>
            <p className="text-gray-500">سازمان یافت نشد</p>
          </div>
        );
      }

      return (
        <div className="space-y-6">
          <header className="text-center py-6">
            <h1 className="text-2xl font-bold text-gray-900 mb-2">پروفایل سازمان</h1>
            <p className="text-gray-600">{org.name}</p>
          </header>

          <div className="grid md:grid-cols-2 gap-6">
            {/* Organization Info */}
            <div className="bg-white rounded-xl shadow p-6">
              <h2 className="text-lg font-semibold mb-4">اطلاعات سازمان</h2>
              <div className="space-y-3">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">نام سازمان</label>
                  <p className="text-gray-900">{org.name}</p>
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">حوزه‌های فعالیت</label>
                  <div className="flex flex-wrap gap-1">
                    {org.domains?.map((domain, index) => (
                      <span key={index} className="px-2 py-1 bg-green-100 text-green-800 text-xs rounded">
                        {domain}
                      </span>
                    ))}
                  </div>
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">وب‌سایت</label>
                  <p className="text-gray-900">
                    {org.website ? (
                      <a href={org.website} className="text-blue-600 hover:underline" target="_blank">
                        {org.website}
                      </a>
                    ) : 'وب‌سایت وارد نشده'}
                  </p>
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">وضعیت</label>
                  <span className={`px-2 py-1 text-xs rounded-full ${
                    org.status === 'approved' ? 'bg-green-100 text-green-800' :
                    org.status === 'pending' ? 'bg-yellow-100 text-yellow-800' :
                    'bg-red-100 text-red-800'
                  }`}>
                    {org.status === 'approved' ? 'تأیید شده' :
                     org.status === 'pending' ? 'در انتظار تأیید' :
                     org.status === 'rejected' ? 'رد شده' :
                     org.status}
                  </span>
                </div>
              </div>
            </div>

            {/* Contact Info */}
            <div className="bg-white rounded-xl shadow p-6">
              <h2 className="text-lg font-semibold mb-4">اطلاعات تماس</h2>
              <div className="space-y-3">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">نماینده</label>
                  <p className="text-gray-900">{user.name}</p>
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">ایمیل</label>
                  <p className="text-gray-900">{user.email}</p>
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">تلفن</label>
                  <p className="text-gray-900">{org.contactInfo?.phone || 'تلفن وارد نشده'}</p>
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">آدرس</label>
                  <p className="text-gray-900">{org.contactInfo?.address || 'آدرس وارد نشده'}</p>
                </div>
              </div>
            </div>
          </div>

          {/* About */}
          <div className="bg-white rounded-xl shadow p-6">
            <h2 className="text-lg font-semibold mb-4">درباره سازمان</h2>
            <p className="text-gray-700 leading-relaxed">
              {org.description || 'توضیحاتی درباره سازمان وارد نشده است.'}
            </p>
          </div>

          {/* Logo Placeholder */}
          <div className="bg-white rounded-xl shadow p-6">
            <h2 className="text-lg font-semibold mb-4">لوگو سازمان</h2>
            <div className="text-center py-8">
              <div className="text-6xl mb-4">🏢</div>
              <p className="text-gray-500">آپلود لوگو در مرحله بعدی اضافه خواهد شد</p>
            </div>
          </div>

          {/* Members */}
          <div className="bg-white rounded-xl shadow p-6">
            <h2 className="text-lg font-semibold mb-4">اعضای سازمان</h2>
            <div className="text-center py-8">
              <div className="text-4xl mb-4">👥</div>
              <p className="text-gray-500">مدیریت اعضا در مرحله بعدی اضافه خواهد شد</p>
            </div>
          </div>
        </div>
      );
    }

    // ================================
    // --- CHALLENGE COMPONENTS ---
    // ================================

    // NDA Modal Component
    function NDAModal({ challenge, onAccept, onCancel, session }) {
      const [loading, setLoading] = React.useState(false);

      const handleAccept = async () => {
        setLoading(true);

        try {
          // Store NDA acceptance with timestamp and version
          const ndaKey = `nda_${session.userId}_${challenge.orgId}`;
          const ndaData = {
            acceptedAt: new Date().toISOString(),
            version: '1.0', // Can be updated when NDA terms change
            challengeId: challenge.id,
            orgId: challenge.orgId,
            userId: session.userId
          };

          storage.set(ndaKey, ndaData);

          // Also update the challenge's NDA acceptance timestamp
          onAccept(ndaData);
        } catch (error) {
          console.error('Error saving NDA acceptance:', error);
          alert('خطا در ذخیره پذیرش NDA');
        } finally {
          setLoading(false);
        }
      };

      return (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div className="p-6">
              <div className="text-center mb-6">
                <div className="text-4xl mb-4">📄</div>
                <h2 className="text-2xl font-bold text-gray-900 mb-2">
                  توافقنامه عدم افشای اطلاعات (NDA)
                </h2>
                <p className="text-gray-600">
                  برای ارسال پیشنهاد، ابتدا باید NDA را مطالعه و بپذیرید
                </p>
              </div>

              <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-6 mb-6">
                <h3 className="text-lg font-semibold text-yellow-800 mb-4">
                  شرایط توافقنامه عدم افشای اطلاعات
                </h3>

                <div className="text-gray-700 space-y-3 text-sm leading-relaxed">
                  <p>
                    <strong>۱. تعریف اطلاعات محرمانه:</strong> هرگونه اطلاعاتی که توسط سازمان ارائه می‌شود،
                    شامل اما محدود به داده‌های فنی، تجاری، مالی، استراتژیک و سایر اطلاعات حساس.
                  </p>

                  <p>
                    <strong>۲. تعهد به محرمانگی:</strong> متعهد می‌شوم که اطلاعات محرمانه را نزد خود نگه دارم
                    و بدون اجازه کتبی از سازمان، آن را به هیچ شخص ثالثی افشا نکنم.
                  </p>

                  <p>
                    <strong>۳. مدت زمان تعهد:</strong> این تعهد تا ۵ سال پس از پایان همکاری یا پروژه معتبر خواهد بود.
                  </p>

                  <p>
                    <strong>۴. مجازات نقض:</strong> در صورت نقض این توافقنامه، متعهد به پرداخت خسارات و هزینه‌های
                    قانونی سازمان خواهم بود.
                  </p>

                  <p>
                    <strong>۵. مالکیت معنوی:</strong> تمامی حقوق مالکیت معنوی مربوط به راه‌حل ارائه شده،
                    در اختیار سازمان خواهد بود مگر اینکه خلاف آن توافق شود.
                  </p>
                </div>
              </div>

              <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                <div className="flex items-start gap-3">
                  <div className="text-blue-600 text-lg">ℹ️</div>
                  <div>
                    <h4 className="font-medium text-blue-900 mb-2">نکات مهم:</h4>
                    <ul className="text-blue-800 text-sm space-y-1">
                      <li>• این توافقنامه برای محافظت از منافع هر دو طرف است</li>
                      <li>• پذیرش NDA برای ارسال هرگونه پیشنهاد الزامی است</li>
                      <li>• می‌توانید NDA را در هر زمان لغو کنید</li>
                      <li>• در صورت سوالات، با پشتیبانی تماس بگیرید</li>
                    </ul>
                  </div>
                </div>
              </div>

              <div className="flex gap-4">
                <button
                  onClick={handleAccept}
                  disabled={loading}
                  className="flex-1 px-6 py-3 bg-green-600 text-white text-lg font-semibold rounded-lg hover:bg-green-700 focus:ring-2 focus:ring-green-500 disabled:opacity-50 transition-colors"
                >
                  {loading ? 'در حال ذخیره...' : '✅ پذیرش NDA و ادامه'}
                </button>
                <button
                  onClick={onCancel}
                  className="px-6 py-3 bg-gray-600 text-white text-lg font-semibold rounded-lg hover:bg-gray-700 focus:ring-2 focus:ring-gray-500 transition-colors"
                >
                  انصراف
                </button>
              </div>
            </div>
          </div>
        </div>
      );
    }

    function SubmissionForm({ challenge, onSave, onCancel, session }) {
      const [formData, setFormData] = React.useState({
        summary: '',
        proposal: '',
        files: [],
        video: ''
      });

      const [errors, setErrors] = React.useState({});
      const [loading, setLoading] = React.useState(false);
      const [showNDAModal, setShowNDAModal] = React.useState(false);
      const [ndaAccepted, setNdaAccepted] = React.useState(null);

      // Check NDA status on component mount
      React.useEffect(() => {
        const ndaKey = `nda_${session.userId}_${challenge.orgId}`;
        const existingNDA = storage.get(ndaKey, null);
        if (!existingNDA) {
          setShowNDAModal(true);
        } else {
          setNdaAccepted(existingNDA);
        }
      }, [session.userId, challenge.orgId]);

      const handleNDAAccept = (ndaData) => {
        setNdaAccepted(ndaData);
        setShowNDAModal(false);
      };

      const handleNDACancel = () => {
        setShowNDAModal(false);
        onCancel();
      };

      const validateForm = () => {
        const newErrors = {};

        if (!formData.summary.trim()) newErrors.summary = 'خلاصه پیشنهاد الزامی است';
        if (!formData.proposal.trim()) newErrors.proposal = 'جزئیات پیشنهاد الزامی است';

        setErrors(newErrors);
        return Object.keys(newErrors).length === 0;
      };

      const handleSubmit = async (e) => {
        e.preventDefault();

        if (!validateForm()) return;

        setLoading(true);

        try {
          const submissions = storage.get(KEYS.submissions, []);

          const submissionData = {
            id: `sub-${Date.now()}`,
            challengeId: challenge.id,
            userId: session.userId,
            ndaAcceptedAt: ndaAccepted.acceptedAt,
            ndaVersion: ndaAccepted.version,
            status: 'received', // Start with 'received' status
            data: {
              summary: formData.summary.trim(),
              proposal: formData.proposal.trim(),
              files: formData.files,
              video: formData.video || null
            },
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString()
          };

          submissions.push(submissionData);
          storage.set(KEYS.submissions, submissions);

          onSave(submissionData);

        } catch (error) {
          console.error('Error saving submission:', error);
          alert('خطا در ذخیره پیشنهاد');
        } finally {
          setLoading(false);
        }
      };

      const updateField = (field, value) => {
        setFormData(prev => ({ ...prev, [field]: value }));
        if (errors[field]) {
          setErrors(prev => ({ ...prev, [field]: '' }));
        }
      };

      // Show NDA modal if NDA not accepted
      if (showNDAModal) {
        return (
          <NDAModal
            challenge={challenge}
            onAccept={handleNDAAccept}
            onCancel={handleNDACancel}
            session={session}
          />
        );
      }

      return (
        <div className="max-w-4xl mx-auto">
          <div className="bg-white rounded-xl shadow-lg p-8">
            <div className="mb-6">
              <h2 className="text-2xl font-bold text-gray-900 mb-2">
                ارسال پیشنهاد برای چالش
              </h2>
              <h3 className="text-lg text-gray-700 mb-4">
                {challenge.title}
              </h3>
              <p className="text-gray-600">
                پیشنهاد خود را با جزئیات کامل شرح دهید تا شانس انتخاب شدنتان افزایش یابد.
              </p>

              {/* NDA Status */}
              {ndaAccepted && (
                <div className="bg-green-50 border border-green-200 rounded-lg p-4 mt-4">
                  <div className="flex items-center gap-2">
                    <span className="text-green-600">✅</span>
                    <div>
                      <p className="text-green-800 font-medium">NDA پذیرفته شده</p>
                      <p className="text-green-700 text-sm">
                        در تاریخ {new Date(ndaAccepted.acceptedAt).toLocaleDateString('fa-IR')} پذیرفته شده
                      </p>
                    </div>
                  </div>
                </div>
              )}
            </div>

            <form onSubmit={handleSubmit} className="space-y-6">

              {/* Summary */}
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  خلاصه پیشنهاد *
                </label>
                <input
                  type="text"
                  value={formData.summary}
                  onChange={(e) => updateField('summary', e.target.value)}
                  className={`w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 ${
                    errors.summary ? 'border-red-300' : 'border-gray-300'
                  }`}
                  placeholder="پیشنهاد خود را در یک جمله خلاصه کنید"
                />
                {errors.summary && <p className="text-red-600 text-sm mt-1">{errors.summary}</p>}
              </div>

              {/* Proposal */}
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  جزئیات پیشنهاد *
                </label>
                <textarea
                  value={formData.proposal}
                  onChange={(e) => updateField('proposal', e.target.value)}
                  className={`w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 ${
                    errors.proposal ? 'border-red-300' : 'border-gray-300'
                  }`}
                  rows="8"
                  placeholder="جزئیات کامل پیشنهاد خود را شرح دهید..."
                />
                {errors.proposal && <p className="text-red-600 text-sm mt-1">{errors.proposal}</p>}
              </div>

              {/* Files */}
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  فایل‌های ضمیمه
                </label>
                <input
                  type="text"
                  value={formData.files.join(', ')}
                  onChange={(e) => updateField('files', e.target.value.split(',').map(f => f.trim()).filter(f => f))}
                  className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                  placeholder="نام فایل‌ها را با کاما جدا کنید (مثال: proposal.pdf, demo.mp4)"
                />
              </div>

              {/* Video */}
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  لینک ویدیو دمو (اختیاری)
                </label>
                <input
                  type="url"
                  value={formData.video}
                  onChange={(e) => updateField('video', e.target.value)}
                  className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                  placeholder="https://..."
                />
              </div>

              {/* Submit Buttons */}
              <div className="flex gap-4 pt-6">
                <button
                  type="submit"
                  disabled={loading}
                  className="flex-1 px-8 py-3 bg-green-600 text-white text-lg font-semibold rounded-lg hover:bg-green-700 focus:ring-2 focus:ring-green-500 disabled:opacity-50 transition-colors"
                >
                  {loading ? 'در حال ذخیره...' : '🚀 ارسال پیشنهاد'}
                </button>
                <button
                  type="button"
                  onClick={onCancel}
                  className="px-8 py-3 bg-gray-600 text-white text-lg font-semibold rounded-lg hover:bg-gray-700 focus:ring-2 focus:ring-gray-500 transition-colors"
                >
                  انصراف
                </button>
              </div>
            </form>
          </div>
        </div>
      );
    }

    function ChallengeForm({ challenge, onSave, onCancel, session }) {
      const [formData, setFormData] = React.useState({
        title: challenge?.title || '',
        problem: challenge?.problem || '',
        success: challenge?.success || '',
        deliverables: challenge?.deliverables || '',
        reward: challenge?.reward || 0,
        category: challenge?.category || 'Energy',
        deadline: challenge?.deadline ? challenge.deadline.split('T')[0] : '',
        tags: challenge?.tags ? challenge.tags.join(', ') : '',
        attachments: challenge?.attachments || [],
        status: challenge?.status || 'draft'
      });

      const [errors, setErrors] = React.useState({});
      const [loading, setLoading] = React.useState(false);

      const categories = [
        'Energy', 'IoT', 'AI', 'Robotics', 'Biotech', 'FinTech',
        'Agritech', 'EdTech', 'HealthTech', 'CleanTech', 'Other'
      ];

      const validateForm = () => {
        const newErrors = {};

        if (!formData.title.trim()) newErrors.title = 'عنوان چالش الزامی است';
        if (!formData.problem.trim()) newErrors.problem = 'توضیح مسئله الزامی است';
        if (!formData.success.trim()) newErrors.success = 'معیارهای موفقیت الزامی است';
        if (!formData.deliverables.trim()) newErrors.deliverables = 'تحویل‌پذیرها الزامی است';
        if (formData.reward <= 0) newErrors.reward = 'پاداش باید بیشتر از صفر باشد';
        if (!formData.deadline) newErrors.deadline = 'مهلت ارسال الزامی است';

        // Check if deadline is in future
        if (formData.deadline) {
          const deadlineDate = new Date(formData.deadline);
          const now = new Date();
          if (deadlineDate <= now) {
            newErrors.deadline = 'مهلت باید در آینده باشد';
          }
        }

        setErrors(newErrors);
        return Object.keys(newErrors).length === 0;
      };

      const handleSubmit = async (e) => {
        e.preventDefault();

        if (!validateForm()) return;

        setLoading(true);

        try {
          const challenges = storage.get(KEYS.challenges, []);

          const challengeData = {
            id: challenge?.id || `c-${Date.now()}`,
            orgId: session.orgId,
            title: formData.title.trim(),
            problem: formData.problem.trim(),
            success: formData.success.trim(),
            deliverables: formData.deliverables.trim(),
            reward: Number(formData.reward),
            category: formData.category,
            deadline: new Date(formData.deadline).toISOString(),
            tags: formData.tags.split(',').map(tag => tag.trim()).filter(tag => tag),
            attachments: formData.attachments,
            status: formData.status,
            createdAt: challenge?.createdAt || new Date().toISOString(),
            updatedAt: new Date().toISOString()
          };

          if (challenge) {
            // Update existing challenge
            const index = challenges.findIndex(c => c.id === challenge.id);
            if (index !== -1) {
              challenges[index] = challengeData;
            }
          } else {
            // Create new challenge
            challenges.push(challengeData);
          }

          storage.set(KEYS.challenges, challenges);
          onSave(challengeData);

        } catch (error) {
          console.error('Error saving challenge:', error);
          alert('خطا در ذخیره چالش');
        } finally {
          setLoading(false);
        }
      };

      const updateField = (field, value) => {
        setFormData(prev => ({ ...prev, [field]: value }));
        // Clear error when user starts typing
        if (errors[field]) {
          setErrors(prev => ({ ...prev, [field]: '' }));
        }
      };

      return (
        <div className="max-w-4xl mx-auto">
          <div className="bg-white rounded-xl shadow-lg p-8">
            <div className="mb-6">
              <h2 className="text-2xl font-bold text-gray-900 mb-2">
                {challenge ? 'ویرایش چالش' : 'ایجاد چالش جدید'}
              </h2>
              <p className="text-gray-600">
                چالش خود را با جزئیات کامل تعریف کنید تا حل‌کنندگان بتوانند بهترین پیشنهادها را ارائه دهند.
              </p>
            </div>

            <form onSubmit={handleSubmit} className="space-y-6">
              {/* Basic Information */}
              <div className="grid md:grid-cols-2 gap-6">
                <div className="md:col-span-2">
                  <FormField
                    label="عنوان چالش"
                    required
                    error={errors.title}
                  >
                    <TextInput
                      id="challenge-title"
                      type="text"
                      value={formData.title}
                      onChange={(e) => updateField('title', e.target.value)}
                      error={!!errors.title}
                      placeholder="مثال: سامانه هوشمند مدیریت انرژی"
                      maxLength={100}
                      aria-describedby="title-help"
                    />
                    <div id="title-help" className="sr-only">
                      عنوان چالش را وارد کنید (حداکثر ۱۰۰ کاراکتر)
                    </div>
                  </FormField>
                </div>

                <div>
                  <FormField label="دسته‌بندی" required>
                    <SelectInput
                      id="challenge-category"
                      value={formData.category}
                      onChange={(e) => updateField('category', e.target.value)}
                      aria-describedby="category-help"
                    >
                      {categories.map(cat => (
                        <option key={cat} value={cat}>{cat}</option>
                      ))}
                    </SelectInput>
                    <div id="category-help" className="sr-only">
                      دسته‌بندی مناسب برای چالش را انتخاب کنید
                    </div>
                  </FormField>
                </div>

                <div>
                  <FormField
                    label="پاداش (تومان)"
                    required
                    error={errors.reward}
                    help="پاداش پیشنهادی برای حل چالش"
                  >
                    <TextInput
                      id="challenge-reward"
                      type="number"
                      value={formData.reward}
                      onChange={(e) => updateField('reward', Number(e.target.value))}
                      error={!!errors.reward}
                      placeholder="مثال: 50000000"
                      min="0"
                      step="100000"
                      aria-describedby="reward-help"
                    />
                  </FormField>
                </div>
              </div>

              {/* Problem Description */}
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  توضیح مسئله *
                </label>
                <textarea
                  value={formData.problem}
                  onChange={(e) => updateField('problem', e.target.value)}
                  className={`w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 ${
                    errors.problem ? 'border-red-300' : 'border-gray-300'
                  }`}
                  rows="4"
                  placeholder="مسئله را به صورت کامل و واضح توضیح دهید..."
                />
                {errors.problem && <p className="text-red-600 text-sm mt-1">{errors.problem}</p>}
              </div>

              {/* Success Criteria */}
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  معیارهای موفقیت *
                </label>
                <textarea
                  value={formData.success}
                  onChange={(e) => updateField('success', e.target.value)}
                  className={`w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 ${
                    errors.success ? 'border-red-300' : 'border-gray-300'
                  }`}
                  rows="3"
                  placeholder="چه معیارهایی برای موفقیت در نظر دارید؟"
                />
                {errors.success && <p className="text-red-600 text-sm mt-1">{errors.success}</p>}
              </div>

              {/* Deliverables */}
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  تحویل‌پذیرها *
                </label>
                <textarea
                  value={formData.deliverables}
                  onChange={(e) => updateField('deliverables', e.target.value)}
                  className={`w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 ${
                    errors.deliverables ? 'border-red-300' : 'border-gray-300'
                  }`}
                  rows="3"
                  placeholder="چه چیزهایی باید تحویل داده شود؟ (کد، گزارش، نمونه، ...)"
                />
                {errors.deliverables && <p className="text-red-600 text-sm mt-1">{errors.deliverables}</p>}
              </div>

              {/* Deadline and Tags */}
              <div className="grid md:grid-cols-2 gap-6">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    مهلت ارسال *
                  </label>
                  <input
                    type="date"
                    value={formData.deadline}
                    onChange={(e) => updateField('deadline', e.target.value)}
                    className={`w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 ${
                      errors.deadline ? 'border-red-300' : 'border-gray-300'
                    }`}
                  />
                  {errors.deadline && <p className="text-red-600 text-sm mt-1">{errors.deadline}</p>}
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    برچسب‌ها
                  </label>
                  <input
                    type="text"
                    value={formData.tags}
                    onChange={(e) => updateField('tags', e.target.value)}
                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                    placeholder="انرژی، IoT، هوش مصنوعی"
                  />
                  <p className="text-xs text-gray-500 mt-1">با کاما جدا کنید</p>
                </div>
              </div>

              {/* Attachments */}
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  پیوست‌ها
                </label>
                <div className="border border-gray-300 rounded-lg p-4 space-y-3">
                  {formData.attachments.length > 0 ? (
                    <div className="space-y-2">
                      {formData.attachments.map((file, index) => (
                        <div key={index} className="flex items-center justify-between bg-gray-50 p-2 rounded">
                          <div className="flex items-center gap-2">
                            <span className="text-gray-600">📄</span>
                            <span className="text-gray-700">{file}</span>
                          </div>
                          <button 
                            type="button"
                            onClick={() => {
                              const newAttachments = [...formData.attachments];
                              newAttachments.splice(index, 1);
                              updateField('attachments', newAttachments);
                            }}
                            className="text-red-600 hover:text-red-800"
                          >
                            ✕
                          </button>
                        </div>
                      ))}
                    </div>
                  ) : (
                    <p className="text-gray-500 text-center py-2">هیچ پیوستی اضافه نشده است</p>
                  )}
                  
                  <div className="flex items-center gap-2">
                    <input
                      type="text"
                      id="attachment-name"
                      placeholder="نام فایل پیوست"
                      className="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                    />
                    <button
                      type="button"
                      onClick={() => {
                        const input = document.getElementById('attachment-name');
                        if (input.value.trim()) {
                          updateField('attachments', [...formData.attachments, input.value.trim()]);
                          input.value = '';
                        }
                      }}
                      className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 focus:ring-2 focus:ring-blue-500"
                    >
                      افزودن
                    </button>
                  </div>
                  <p className="text-xs text-gray-500">در این نسخه، فقط نام فایل‌ها ذخیره می‌شود</p>
                </div>
              </div>
              
              {/* Status */}
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  وضعیت انتشار
                </label>
                <select
                  value={formData.status}
                  onChange={(e) => updateField('status', e.target.value)}
                  className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                >
                  <option value="draft">پیش‌نویس</option>
                  <option value="published">منتشر شده</option>
                  <option value="closed">بسته شده</option>
                </select>
              </div>

              {/* Submit Buttons */}
              <div className="flex gap-4 pt-6 border-t">
                <ButtonLoader
                  type="submit"
                  loading={loading}
                  className="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 focus:ring-2 focus:ring-blue-500 disabled:opacity-50 transition-colors focus-ring"
                  aria-describedby="submit-help"
                >
                  {loading ? 'در حال ذخیره...' : (challenge ? 'بروزرسانی چالش' : 'ایجاد چالش')}
                </ButtonLoader>
                <div id="submit-help" className="sr-only">
                  {challenge ? 'چالش را به‌روزرسانی کنید' : 'چالش جدید ایجاد کنید'}
                </div>
                <button
                  type="button"
                  onClick={onCancel}
                  className="px-6 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 focus:ring-2 focus:ring-gray-500 transition-colors focus-ring"
                  aria-label="انصراف و بازگشت"
                >
                  انصراف
                </button>
              </div>
            </form>
          </div>
        </div>
      );
    }

    function ChallengeCatalog({ challenges, onSelectChallenge, session }) {
      const [searchTerm, setSearchTerm] = React.useState('');
      const [selectedCategory, setSelectedCategory] = React.useState('');
      const [sortBy, setSortBy] = React.useState('newest');
      const [viewMode, setViewMode] = React.useState('grid');

      const categories = ['All', 'Energy', 'IoT', 'AI', 'Robotics', 'Biotech', 'FinTech', 'Agritech', 'EdTech', 'HealthTech', 'CleanTech', 'Other'];

      // Filter challenges
      const filteredChallenges = challenges.filter(challenge => {
        const matchesSearch = !searchTerm ||
          challenge.title.toLowerCase().includes(searchTerm.toLowerCase()) ||
          challenge.problem.toLowerCase().includes(searchTerm.toLowerCase()) ||
          challenge.tags?.some(tag => tag.toLowerCase().includes(searchTerm.toLowerCase()));

        const matchesCategory = !selectedCategory || selectedCategory === 'All' || challenge.category === selectedCategory;

        return matchesSearch && matchesCategory && challenge.status === 'published';
      });

      // Sort challenges
      const sortedChallenges = [...filteredChallenges].sort((a, b) => {
        switch (sortBy) {
          case 'newest':
            return new Date(b.createdAt) - new Date(a.createdAt);
          case 'oldest':
            return new Date(a.createdAt) - new Date(b.createdAt);
          case 'reward-high':
            return b.reward - a.reward;
          case 'reward-low':
            return a.reward - b.reward;
          case 'deadline':
            return new Date(a.deadline) - new Date(b.deadline);
          default:
            return 0;
        }
      });

      const formatReward = (amount) => {
        return new Intl.NumberFormat('fa-IR').format(amount);
      };

      const getDaysLeft = (deadline) => {
        const now = new Date();
        const deadlineDate = new Date(deadline);
        const diffTime = deadlineDate - now;
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        return diffDays;
      };

      return (
        <div className="space-y-6">
          {/* Header */}
          <div className="text-center py-6">
            <h1 className="text-2xl font-bold text-gray-900 mb-2">کاتالوگ چالش‌ها</h1>
            <p className="text-gray-600">چالش‌های فناوری موجود برای حل</p>
          </div>

          {/* Filters and Search */}
          <div className="bg-white rounded-xl shadow p-6">
            <div className="grid md:grid-cols-4 gap-4 mb-4">
              {/* Search */}
              <div className="md:col-span-2">
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  جستجو
                </label>
                <input
                  type="text"
                  value={searchTerm}
                  onChange={(e) => setSearchTerm(e.target.value)}
                  className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                  placeholder="جستجو در عنوان، توضیح یا برچسب‌ها..."
                />
              </div>

              {/* Category Filter */}
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  دسته‌بندی
                </label>
                <select
                  value={selectedCategory}
                  onChange={(e) => setSelectedCategory(e.target.value)}
                  className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                >
                  {categories.map(cat => (
                    <option key={cat} value={cat === 'All' ? '' : cat}>
                      {cat === 'All' ? 'همه دسته‌بندی‌ها' : cat}
                    </option>
                  ))}
                </select>
              </div>

              {/* Sort */}
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  مرتب‌سازی
                </label>
                <select
                  value={sortBy}
                  onChange={(e) => setSortBy(e.target.value)}
                  className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                >
                  <option value="newest">جدیدترین</option>
                  <option value="oldest">قدیمی‌ترین</option>
                  <option value="reward-high">پاداش بالاتر</option>
                  <option value="reward-low">پاداش پایین‌تر</option>
                  <option value="deadline">مهلت نزدیک‌تر</option>
                </select>
              </div>
            </div>

            {/* View Toggle and Results Count */}
            <div className="flex justify-between items-center">
              <div className="flex items-center gap-4">
                <span className="text-sm text-gray-600">
                  {sortedChallenges.length} چالش یافت شد
                </span>
              </div>

              <div className="flex items-center gap-4">
                {/* View Toggle */}
                <div className="flex items-center gap-2">
                  <span className="text-sm text-gray-600">نمایش:</span>
                  <button
                    onClick={() => setViewMode('grid')}
                    className={`p-2 rounded ${viewMode === 'grid' ? 'bg-blue-100 text-blue-600' : 'text-gray-400'}`}
                  >
                    ⊞
                  </button>
                  <button
                    onClick={() => setViewMode('list')}
                    className={`p-2 rounded ${viewMode === 'list' ? 'bg-blue-100 text-blue-600' : 'text-gray-400'}`}
                  >
                    ☰
                  </button>
                </div>

                {/* Create Challenge Button for Seekers */}
                {session?.role === 'SEEKER' && (
                  <button
                    onClick={() => window.location.hash = 'create-challenge'}
                    className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors flex items-center gap-2"
                  >
                    <span>➕</span>
                    ایجاد چالش جدید
                  </button>
                )}
              </div>
            </div>
          </div>

          {/* Challenges Display */}
          {sortedChallenges.length > 0 ? (
            <div className={viewMode === 'grid'
              ? "grid md:grid-cols-2 lg:grid-cols-3 gap-6"
              : "space-y-4"
            }>
              {sortedChallenges.map(challenge => (
                <div
                  key={challenge.id}
                  className={`bg-white rounded-xl shadow hover:shadow-lg transition-shadow cursor-pointer ${
                    viewMode === 'list' ? 'flex items-center' : ''
                  }`}
                  onClick={() => onSelectChallenge(challenge)}
                >
                  {viewMode === 'grid' ? (
                    // Grid View
                    <div className="p-6">
                      <div className="flex items-start justify-between mb-4">
                        <div className="flex-1">
                          <h3 className="text-lg font-semibold text-gray-900 mb-2 line-clamp-2">
                            {challenge.title}
                          </h3>
                          <div className="flex items-center gap-2 mb-2">
                            <span className="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded-full">
                              {challenge.category}
                            </span>
                            <span className={`px-2 py-1 text-xs rounded-full ${
                              getDaysLeft(challenge.deadline) > 7 ? 'bg-green-100 text-green-800' :
                              getDaysLeft(challenge.deadline) > 0 ? 'bg-yellow-100 text-yellow-800' :
                              'bg-red-100 text-red-800'
                            }`}>
                              {getDaysLeft(challenge.deadline) > 0
                                ? `${getDaysLeft(challenge.deadline)} روز`
                                : 'مهلت تمام شده'
                              }
                            </span>
                          </div>
                        </div>
                        <div className="text-left">
                          <div className="text-lg font-bold text-green-600">
                            {formatReward(challenge.reward)} تومان
                          </div>
                        </div>
                      </div>

                      <p className="text-gray-700 mb-4 line-clamp-3">
                        {challenge.problem}
                      </p>

                      <div className="flex items-center justify-between">
                        <div className="flex flex-wrap gap-1">
                          {challenge.tags?.slice(0, 3).map((tag, index) => (
                            <span key={index} className="px-2 py-1 bg-gray-100 text-gray-700 text-xs rounded">
                              {tag}
                            </span>
                          ))}
                          {challenge.tags?.length > 3 && (
                            <span className="px-2 py-1 bg-gray-100 text-gray-700 text-xs rounded">
                              +{challenge.tags.length - 3}
                            </span>
                          )}
                        </div>
                        <button className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                          مشاهده جزئیات
                        </button>
                      </div>
                    </div>
                  ) : (
                    // List View
                    <div className="p-4 flex-1">
                      <div className="flex items-center justify-between">
                        <div className="flex-1">
                          <h3 className="text-lg font-semibold text-gray-900 mb-1">
                            {challenge.title}
                          </h3>
                          <p className="text-gray-700 text-sm line-clamp-2 mb-2">
                            {challenge.problem}
                          </p>
                          <div className="flex items-center gap-4 text-sm text-gray-600">
                            <span>🏷️ {challenge.category}</span>
                            <span>💰 {formatReward(challenge.reward)} تومان</span>
                            <span>⏰ {getDaysLeft(challenge.deadline)} روز</span>
                          </div>
                        </div>
                        <div className="mr-4">
                          <button className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                            مشاهده جزئیات
                          </button>
                        </div>
                      </div>
                    </div>
                  )}
                </div>
              ))}
            </div>
          ) : (
            <div className="text-center py-12">
              <div className="text-4xl mb-4">🔍</div>
              <p className="text-gray-500 mb-2">هیچ چالشی یافت نشد</p>
              <p className="text-sm text-gray-400">
                {searchTerm || selectedCategory ? 'فیلترها را تغییر دهید یا جستجوی دیگری انجام دهید' : 'هیچ چالشی منتشر نشده است'}
              </p>
            </div>
          )}
        </div>
      );
    }

    function ChallengeDetail({ challenge, onBack, onSolve, session }) {
      const [org, setOrg] = React.useState(null);
      const [isSubmitting, setIsSubmitting] = React.useState(false);

      React.useEffect(() => {
        if (challenge?.orgId) {
          const orgs = storage.get(KEYS.orgs, []);
          const foundOrg = orgs.find(o => o.id === challenge.orgId);
          setOrg(foundOrg);
        }
      }, [challenge]);

      const formatReward = (amount) => {
        return new Intl.NumberFormat('fa-IR').format(amount);
      };

      const getDaysLeft = (deadline) => {
        const now = new Date();
        const deadlineDate = new Date(deadline);
        const diffTime = deadlineDate - now;
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        return diffDays;
      };

      const handleSolveChallenge = () => {
        if (!session) {
          alert('برای ارسال پیشنهاد ابتدا وارد سیستم شوید');
          window.location.hash = 'login';
          return;
        }

        if (session.role !== 'SOLVER') {
          alert('فقط حل‌کنندگان می‌توانند پیشنهاد ارسال کنند');
          return;
        }

        // Check if user already submitted for this challenge
        const existingSubmissions = JSON.parse(localStorage.getItem('submissions') || '[]');
        const alreadySubmitted = existingSubmissions.some(sub =>
          sub.challengeId === challenge.id && sub.userId === session.userId
        );

        if (alreadySubmitted) {
          alert('شما قبلاً برای این چالش پیشنهاد ارسال کرده‌اید');
          return;
        }

        // Navigate to submission creation
        onSolve(challenge);
      };

      if (!challenge) {
        return (
          <div className="text-center py-12">
            <div className="text-4xl mb-4">❌</div>
            <p className="text-gray-500">چالش یافت نشد</p>
            <button
              onClick={onBack}
              className="mt-4 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
            >
              بازگشت
            </button>
          </div>
        );
      }

      return (
        <div className="space-y-6">
          {/* Header */}
          <div className="bg-white rounded-xl shadow p-6">
            <div className="flex items-center justify-between mb-4">
              <button
                onClick={onBack}
                className="flex items-center gap-2 text-gray-600 hover:text-gray-900"
              >
                ← بازگشت به کاتالوگ
              </button>
              <div className="flex gap-2">
                <span className={`px-3 py-1 text-sm rounded-full ${
                  challenge.status === 'published' ? 'bg-green-100 text-green-800' :
                  challenge.status === 'draft' ? 'bg-yellow-100 text-yellow-800' :
                  'bg-gray-100 text-gray-800'
                }`}>
                  {challenge.status === 'published' ? 'منتشر شده' :
                   challenge.status === 'draft' ? 'پیش‌نویس' :
                   challenge.status}
                </span>
                <span className="px-3 py-1 bg-blue-100 text-blue-800 text-sm rounded-full">
                  {challenge.category}
                </span>
              </div>
            </div>

            <div className="grid md:grid-cols-3 gap-6">
              <div className="md:col-span-2">
                <h1 className="text-3xl font-bold text-gray-900 mb-2">
                  {challenge.title}
                </h1>
                <p className="text-gray-600 mb-4">
                  توسط {org?.name || 'سازمان نامشخص'}
                </p>
              </div>
              <div className="text-left">
                <div className="text-3xl font-bold text-green-600 mb-2">
                  {formatReward(challenge.reward)} تومان
                </div>
                <div className={`text-sm ${
                  getDaysLeft(challenge.deadline) > 7 ? 'text-green-600' :
                  getDaysLeft(challenge.deadline) > 0 ? 'text-yellow-600' :
                  'text-red-600'
                }`}>
                  {getDaysLeft(challenge.deadline) > 0
                    ? `${getDaysLeft(challenge.deadline)} روز تا مهلت`
                    : 'مهلت تمام شده'
                  }
                </div>
              </div>
            </div>

            <div className="mt-6 flex gap-4">
              {session?.role === 'SOLVER' && (
                <button
                  onClick={handleSolveChallenge}
                  disabled={isSubmitting}
                  className="px-8 py-3 bg-green-600 text-white text-lg font-semibold rounded-lg hover:bg-green-700 focus:ring-2 focus:ring-green-500 disabled:opacity-50 transition-colors"
                >
                  🚀 حل این چالش
                </button>
              )}

              {/* Edit button for challenge owner (seeker) */}
              {session?.role === 'SEEKER' && session?.orgId === challenge.orgId && (
                <button
                  onClick={() => {
                    setEditingChallenge(challenge);
                    window.location.hash = 'create-challenge';
                  }}
                  className="px-8 py-3 bg-yellow-600 text-white text-lg font-semibold rounded-lg hover:bg-yellow-700 focus:ring-2 focus:ring-yellow-500 transition-colors"
                >
                  ✏️ ویرایش چالش
                </button>
              )}
            </div>
          </div>

          {/* Problem Description */}
          <div className="bg-white rounded-xl shadow p-6">
            <h2 className="text-xl font-semibold mb-4 flex items-center">
              <span className="ml-2">📋</span>
              توضیح مسئله
            </h2>
            <p className="text-gray-700 leading-relaxed text-lg">
              {challenge.problem}
            </p>
          </div>

          {/* Success Criteria */}
          <div className="bg-white rounded-xl shadow p-6">
            <h2 className="text-xl font-semibold mb-4 flex items-center">
              <span className="ml-2">✅</span>
              معیارهای موفقیت
            </h2>
            <p className="text-gray-700 leading-relaxed">
              {challenge.success}
            </p>
          </div>

          {/* Deliverables */}
          <div className="bg-white rounded-xl shadow p-6">
            <h2 className="text-xl font-semibold mb-4 flex items-center">
              <span className="ml-2">📦</span>
              تحویل‌پذیرها
            </h2>
            <p className="text-gray-700 leading-relaxed">
              {challenge.deliverables}
            </p>
          </div>

          {/* Tags */}
          <div className="bg-white rounded-xl shadow p-6">
            <h2 className="text-xl font-semibold mb-4 flex items-center">
              <span className="ml-2">🏷️</span>
              برچسب‌ها
            </h2>
            <div className="flex flex-wrap gap-2">
              {challenge.tags?.map((tag, index) => (
                <span key={index} className="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm">
                  {tag}
                </span>
              ))}
            </div>
          </div>

          {/* Organization Info */}
          <div className="bg-white rounded-xl shadow p-6">
            <h2 className="text-xl font-semibold mb-4 flex items-center">
              <span className="ml-2">🏢</span>
              اطلاعات سازمان
            </h2>
            <div className="grid md:grid-cols-2 gap-6">
              <div>
                <h3 className="font-medium text-gray-900 mb-2">{org?.name || 'سازمان نامشخص'}</h3>
                <p className="text-gray-600 mb-4">{org?.description || 'توضیحی موجود نیست'}</p>
                <div className="space-y-2 text-sm text-gray-600">
                  {org?.website && (
                    <div>
                      🌐 <a href={org.website} className="text-blue-600 hover:underline" target="_blank">
                        وب‌سایت سازمان
                      </a>
                    </div>
                  )}
                  {org?.contactInfo?.phone && (
                    <div>📞 {org.contactInfo.phone}</div>
                  )}
                  {org?.contactInfo?.address && (
                    <div>📍 {org.contactInfo.address}</div>
                  )}
                </div>
              </div>
              <div>
                <h4 className="font-medium text-gray-900 mb-2">حوزه‌های فعالیت</h4>
                <div className="flex flex-wrap gap-1">
                  {org?.domains?.map((domain, index) => (
                    <span key={index} className="px-2 py-1 bg-green-100 text-green-800 text-xs rounded">
                      {domain}
                    </span>
                  ))}
                </div>
              </div>
            </div>
          </div>

          {/* Attachments Placeholder */}
          {challenge.attachments?.length > 0 && (
            <div className="bg-white rounded-xl shadow p-6">
              <h2 className="text-xl font-semibold mb-4 flex items-center">
                <span className="ml-2">📎</span>
                پیوست‌ها
              </h2>
              <div className="space-y-2">
                {challenge.attachments.map((attachment, index) => (
                  <div key={index} className="flex items-center gap-2 p-2 border rounded">
                    <span className="text-gray-600">📄</span>
                    <span className="text-gray-700">{attachment}</span>
                    <button className="text-blue-600 hover:underline text-sm mr-auto">
                      دانلود
                    </button>
                  </div>
                ))}
              </div>
            </div>
          )}
        </div>
      );
    }

    // ================================
    // --- ROLE-SPECIFIC PAGES ---
    // ================================
    function AdminPage({ session }) {
      const [users, setUsers] = useLocalStorage(KEYS.users, []);
      const [orgs, setOrgs] = useLocalStorage(KEYS.orgs, []);
      const [notifications, setNotifications] = useLocalStorage(KEYS.notifications, []);
      const [selectedUser, setSelectedUser] = React.useState(null);
      const [selectedOrg, setSelectedOrg] = React.useState(null);

      // Get pending approvals
      const pendingUsers = users.filter(u => u.status === 'pending' && u.role !== 'ADMIN');
      const pendingOrgs = orgs.filter(o => o.status === 'pending');

      const approveUser = (userId) => {
        const updatedUsers = users.map(u =>
          u.id === userId ? { ...u, status: 'approved' } : u
        );
        setUsers(updatedUsers);

        // Remove notification
        const updatedNotifications = notifications.filter(n =>
          !(n.type === 'user_registration' && n.targetId === userId)
        );
        setNotifications(updatedNotifications);

        alert('کاربر با موفقیت تأیید شد!');
      };

      const rejectUser = (userId) => {
        const updatedUsers = users.map(u =>
          u.id === userId ? { ...u, status: 'rejected' } : u
        );
        setUsers(updatedUsers);

        // Remove notification
        const updatedNotifications = notifications.filter(n =>
          !(n.type === 'user_registration' && n.targetId === userId)
        );
        setNotifications(updatedNotifications);

        alert('کاربر رد شد!');
      };

      const approveOrg = (orgId, userId) => {
        const updatedOrgs = orgs.map(o =>
          o.id === orgId ? { ...o, status: 'approved' } : o
        );
        const updatedUsers = users.map(u =>
          u.id === userId ? { ...u, status: 'approved' } : u
        );
        setOrgs(updatedOrgs);
        setUsers(updatedUsers);

        // Remove notification
        const updatedNotifications = notifications.filter(n =>
          !(n.type === 'org_request' && n.targetId === orgId)
        );
        setNotifications(updatedNotifications);

        alert('سازمان با موفقیت تأیید شد!');
      };

      const rejectOrg = (orgId, userId) => {
        const updatedOrgs = orgs.map(o =>
          o.id === orgId ? { ...o, status: 'rejected' } : o
        );
        const updatedUsers = users.map(u =>
          u.id === userId ? { ...u, status: 'rejected' } : u
        );
        setOrgs(updatedOrgs);
        setUsers(updatedUsers);

        // Remove notification
        const updatedNotifications = notifications.filter(n =>
          !(n.type === 'org_request' && n.targetId === orgId)
        );
        setNotifications(updatedNotifications);

        alert('سازمان رد شد!');
      };

      return (
        <div className="space-y-6">
          <header className="text-center py-6">
            <h1 className="text-2xl font-bold text-gray-900 mb-2">پنل مدیریت</h1>
            <p className="text-gray-600">مدیریت کاربران و سازمان‌ها</p>
          </header>

          <div className="grid md:grid-cols-2 gap-6">
            {/* Pending Users */}
            <div className="bg-white rounded-xl shadow p-6">
              <h2 className="text-lg font-semibold mb-4 flex items-center">
                <span className="ml-2">👤</span>
                کاربران در انتظار تأیید ({pendingUsers.length})
              </h2>

              {pendingUsers.length > 0 ? (
                <div className="space-y-4">
                  {pendingUsers.map(user => (
                    <div key={user.id} className="border border-yellow-200 rounded-lg p-4 bg-yellow-50">
                      <div className="flex items-center justify-between mb-2">
                        <div>
                          <h3 className="font-medium">{user.name}</h3>
                          <p className="text-sm text-gray-600">{user.email}</p>
                          <p className="text-xs text-gray-500">
                            {user.role === 'SOLVER' ? 'حل‌کننده' : 'جستجوگر'}
                          </p>
                        </div>
                        <div className="flex gap-2">
                          <button
                            onClick={() => setSelectedUser(user)}
                            className="px-3 py-1 bg-blue-500 text-white text-xs rounded hover:bg-blue-600"
                          >
                            مشاهده
                          </button>
                          <button
                            onClick={() => approveUser(user.id)}
                            className="px-3 py-1 bg-green-500 text-white text-xs rounded hover:bg-green-600"
                          >
                            تأیید
                          </button>
                          <button
                            onClick={() => rejectUser(user.id)}
                            className="px-3 py-1 bg-red-500 text-white text-xs rounded hover:bg-red-600"
                          >
                            رد
                          </button>
                        </div>
                      </div>
                      {user.bio && (
                        <p className="text-sm text-gray-700 mt-2">{user.bio}</p>
                      )}
                    </div>
                  ))}
                </div>
              ) : (
                <p className="text-gray-500 text-center py-4">کاربر در انتظار تأییدی وجود ندارد</p>
              )}
            </div>

            {/* Pending Organizations */}
            <div className="bg-white rounded-xl shadow p-6">
              <h2 className="text-lg font-semibold mb-4 flex items-center">
                <span className="ml-2">🏢</span>
                سازمان‌ها در انتظار تأیید ({pendingOrgs.length})
              </h2>

              {pendingOrgs.length > 0 ? (
                <div className="space-y-4">
                  {pendingOrgs.map(org => {
                    const user = users.find(u => u.orgId === org.id);
                    return (
                      <div key={org.id} className="border border-yellow-200 rounded-lg p-4 bg-yellow-50">
                        <div className="flex items-center justify-between mb-2">
                          <div>
                            <h3 className="font-medium">{org.name}</h3>
                            <p className="text-sm text-gray-600">
                              نماینده: {user?.name || 'نامشخص'}
                            </p>
                            <div className="flex gap-1 mt-1">
                              {org.domains?.map((domain, index) => (
                                <span key={index} className="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded">
                                  {domain}
                                </span>
                              ))}
                            </div>
                          </div>
                          <div className="flex gap-2">
                            <button
                              onClick={() => setSelectedOrg({ org, user })}
                              className="px-3 py-1 bg-blue-500 text-white text-xs rounded hover:bg-blue-600"
                            >
                              مشاهده
                            </button>
                            <button
                              onClick={() => approveOrg(org.id, user?.id)}
                              className="px-3 py-1 bg-green-500 text-white text-xs rounded hover:bg-green-600"
                            >
                              تأیید
                            </button>
                            <button
                              onClick={() => rejectOrg(org.id, user?.id)}
                              className="px-3 py-1 bg-red-500 text-white text-xs rounded hover:bg-red-600"
                            >
                              رد
                            </button>
                          </div>
                        </div>
                        <p className="text-sm text-gray-700 mt-2">
                          {org.description || 'توضیحی وارد نشده'}
                        </p>
                      </div>
                    );
                  })}
                </div>
              ) : (
                <p className="text-gray-500 text-center py-4">سازمان در انتظار تأییدی وجود ندارد</p>
              )}
            </div>
          </div>

          {/* Statistics */}
          <div className="bg-white rounded-xl shadow p-6">
            <h2 className="text-lg font-semibold mb-4">آمار سیستم</h2>
            <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
              <div className="text-center">
                <div className="text-2xl font-bold text-blue-600">{users.length}</div>
                <div className="text-sm text-gray-600">کاربر کل</div>
              </div>
              <div className="text-center">
                <div className="text-2xl font-bold text-green-600">{orgs.length}</div>
                <div className="text-sm text-gray-600">سازمان کل</div>
              </div>
              <div className="text-center">
                <div className="text-2xl font-bold text-yellow-600">{pendingUsers.length + pendingOrgs.length}</div>
                <div className="text-sm text-gray-600">در انتظار تأیید</div>
              </div>
              <div className="text-center">
                <div className="text-2xl font-bold text-purple-600">
                  {users.filter(u => u.role === 'ADMIN').length}
                </div>
                <div className="text-sm text-gray-600">مدیر سیستم</div>
              </div>
            </div>
          </div>

          {/* User/Org Details Modal would go here in full implementation */}
          {selectedUser && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
              <div className="bg-white rounded-xl p-6 max-w-2xl w-full mx-4 max-h-96 overflow-y-auto">
                <div className="flex justify-between items-center mb-4">
                  <h3 className="text-lg font-semibold">جزئیات کاربر</h3>
                  <button
                    onClick={() => setSelectedUser(null)}
                    className="text-gray-500 hover:text-gray-700"
                  >
                    ✕
                  </button>
                </div>
                <SolverProfile user={selectedUser} />
              </div>
            </div>
          )}

          {selectedOrg && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
              <div className="bg-white rounded-xl p-6 max-w-2xl w-full mx-4 max-h-96 overflow-y-auto">
                <div className="flex justify-between items-center mb-4">
                  <h3 className="text-lg font-semibold">جزئیات سازمان</h3>
                  <button
                    onClick={() => setSelectedOrg(null)}
                    className="text-gray-500 hover:text-gray-700"
                  >
                    ✕
                  </button>
                </div>
                <SeekerProfile user={selectedOrg.user} org={selectedOrg.org} />
              </div>
            </div>
          )}
        </div>
      );
    }

    function MyChallengesPage({ session, challenges, orgs }) {
      const userChallenges = challenges.filter(c => {
        const org = orgs.find(o => o.id === session?.orgId);
        return org && c.orgId === org.id;
      });

      return (
        <div className="space-y-6">
          <header className="text-center py-6">
            <h1 className="text-2xl font-bold text-gray-900 mb-2">چالش‌های من</h1>
            <p className="text-gray-600">مدیریت چالش‌های منتشر شده</p>
          </header>
          
          <div className="bg-white rounded-xl shadow p-6">
            <div className="flex justify-between items-center mb-4">
              <h2 className="text-lg font-semibold">📝 چالش‌های شما</h2>
              <button
                onClick={() => window.location.hash = 'create-challenge'}
                className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors flex items-center gap-2"
              >
                <span>➕</span>
                چالش جدید
              </button>
            </div>

            {userChallenges.length > 0 ? (
              <div className="space-y-4">
                {userChallenges.map(challenge => (
                  <div key={challenge.id} className="p-4 border rounded-lg hover:bg-gray-50 transition-colors">
                    <div className="flex justify-between items-start mb-2">
                      <div className="flex-1">
                        <h3 className="font-medium">{challenge.title}</h3>
                        <p className="text-sm text-gray-600 mt-1 line-clamp-2">{challenge.problem}</p>
                      </div>
                      <div className="flex gap-2 mr-4">
                        <button
                          onClick={() => {
                            setSelectedChallenge(challenge);
                            navigate('challenge-detail');
                          }}
                          className="px-3 py-1 bg-blue-500 text-white text-xs rounded hover:bg-blue-600"
                        >
                          مشاهده
                        </button>
                        <button
                          onClick={() => {
                            setEditingChallenge(challenge);
                            navigate('create-challenge');
                          }}
                          className="px-3 py-1 bg-yellow-500 text-white text-xs rounded hover:bg-yellow-600"
                        >
                          ویرایش
                        </button>
                      </div>
                    </div>
                    <div className="flex items-center gap-4 text-xs text-gray-500">
                      <span>💰 {challenge.reward.toLocaleString('fa-IR')} تومان</span>
                      <span>📊 {challenge.status}</span>
                      <span>⏰ {new Date(challenge.deadline).toLocaleDateString('fa-IR')}</span>
                    </div>
                  </div>
                ))}
              </div>
            ) : (
              <div className="text-center py-8">
                <div className="text-4xl mb-4">🎯</div>
                <p className="text-gray-500 mb-4">هنوز چالشی منتشر نکرده‌اید.</p>
                <p className="text-sm text-gray-400">
                  برای شروع، روی دکمه "چالش جدید" کلیک کنید.
                </p>
              </div>
            )}
            
            <div className="mt-6">
              <p className="text-sm text-gray-600">
                🚧 ایجاد چالش جدید و مدیریت پیشنهادات در مرحله بعدی اضافه خواهد شد.
              </p>
            </div>
          </div>
        </div>
      );
    }

    // Submissions Management Table for Seekers
    // Rubric and Scoring System
    function SubmissionScoring({ submission, challenge, onScoreUpdate, onClose }) {
      const [scores, setScores] = React.useState({
        fit: submission.scores?.fit || 0,
        feasibility: submission.scores?.feasibility || 0,
        costTime: submission.scores?.costTime || 0,
        innovation: submission.scores?.innovation || 0
      });

      const rubric = {
        fit: { weight: 0.40, label: 'تطابق با نیازها', description: 'چقدر پیشنهاد با نیازهای تعریف شده چالش مطابقت دارد' },
        feasibility: { weight: 0.25, label: 'قابل اجرا بودن', description: 'چقدر اجرای فنی پیشنهاد عملی و ممکن است' },
        costTime: { weight: 0.20, label: 'هزینه و زمان', description: 'بهینگی هزینه‌ها و زمان اجرای پیشنهاد' },
        innovation: { weight: 0.15, label: 'نوآوری', description: 'میزان خلاقیت و نوآوری در رویکرد پیشنهادی' }
      };

      const calculateTotal = () => {
        return (
          scores.fit * rubric.fit.weight +
          scores.feasibility * rubric.feasibility.weight +
          scores.costTime * rubric.costTime.weight +
          scores.innovation * rubric.innovation.weight
        ).toFixed(1);
      };

      const handleSave = () => {
        const totalScore = parseFloat(calculateTotal());
        const updatedSubmission = {
          ...submission,
          scores: {
            fit: scores.fit,
            feasibility: scores.feasibility,
            costTime: scores.costTime,
            innovation: scores.innovation,
            total: totalScore
          },
          scoredAt: new Date().toISOString()
        };

        onScoreUpdate(updatedSubmission);
        onClose();
      };

      const updateScore = (category, value) => {
        setScores(prev => ({ ...prev, [category]: parseInt(value) || 0 }));
      };

      return (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div className="p-6">
              <div className="flex justify-between items-center mb-6">
                <div>
                  <h2 className="text-2xl font-bold text-gray-900">نمره‌دهی به پیشنهاد</h2>
                  <p className="text-gray-600 mt-1">{challenge.title}</p>
                </div>
                <button
                  onClick={onClose}
                  className="text-gray-400 hover:text-gray-600 text-2xl"
                >
                  ✕
                </button>
              </div>

              {/* Submission Summary */}
              <div className="bg-gray-50 rounded-lg p-4 mb-6">
                <h3 className="font-semibold text-gray-900 mb-2">خلاصه پیشنهاد:</h3>
                <p className="text-gray-700">{submission.data.summary}</p>
              </div>

              {/* Rubric Scoring */}
              <div className="space-y-6">
                {Object.entries(rubric).map(([key, item]) => (
                  <div key={key} className="border border-gray-200 rounded-lg p-4">
                    <div className="flex justify-between items-start mb-3">
                      <div>
                        <h4 className="font-semibold text-gray-900">{item.label}</h4>
                        <p className="text-gray-600 text-sm">{item.description}</p>
                        <p className="text-blue-600 font-medium mt-1">وزن: {(item.weight * 100).toFixed(0)}%</p>
                      </div>
                      <div className="text-left">
                        <div className="text-2xl font-bold text-gray-900">
                          {scores[key] || 0}/10
                        </div>
                        <div className="text-sm text-gray-600">
                          امتیاز: {((scores[key] || 0) * item.weight).toFixed(1)}
                        </div>
                      </div>
                    </div>

                    <div className="flex items-center gap-4">
                      <input
                        type="range"
                        min="0"
                        max="10"
                        value={scores[key] || 0}
                        onChange={(e) => updateScore(key, e.target.value)}
                        className="flex-1 h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"
                      />
                      <input
                        type="number"
                        min="0"
                        max="10"
                        value={scores[key] || 0}
                        onChange={(e) => updateScore(key, e.target.value)}
                        className="w-16 px-2 py-1 border border-gray-300 rounded text-center"
                      />
                    </div>
                  </div>
                ))}
              </div>

              {/* Total Score */}
              <div className="bg-blue-50 border border-blue-200 rounded-lg p-6 mt-6">
                <div className="flex justify-between items-center">
                  <div>
                    <h3 className="text-xl font-bold text-blue-900">نمره کل</h3>
                    <p className="text-blue-700 text-sm">مجموع نمرات وزنی</p>
                  </div>
                  <div className="text-4xl font-bold text-blue-600">
                    {calculateTotal()}/10
                  </div>
                </div>
              </div>

              {/* Action Buttons */}
              <div className="flex gap-4 mt-6">
                <button
                  onClick={handleSave}
                  className="flex-1 px-6 py-3 bg-green-600 text-white text-lg font-semibold rounded-lg hover:bg-green-700 focus:ring-2 focus:ring-green-500 disabled:opacity-50 transition-colors"
                >
                  💾 ذخیره نمرات
                </button>
                <button
                  onClick={onClose}
                  className="px-6 py-3 bg-gray-600 text-white text-lg font-semibold rounded-lg hover:bg-gray-700 focus:ring-2 focus:ring-gray-500 transition-colors"
                >
                  انصراف
                </button>
              </div>
            </div>
          </div>
        </div>
      );
    }

    // Comparison View Component
    function SubmissionsComparison({ submissions, challenge, onSelectWinner, onClose }) {
      const [selectedSubmissions, setSelectedSubmissions] = React.useState([]);

      const toggleSubmission = (submissionId) => {
        setSelectedSubmissions(prev =>
          prev.includes(submissionId)
            ? prev.filter(id => id !== submissionId)
            : prev.length < 2
            ? [...prev, submissionId]
            : prev
        );
      };

      const getSelectedSubmissions = () => {
        return submissions.filter(sub => selectedSubmissions.includes(sub.id));
      };

      const handleSelectWinner = (submissionId) => {
        const winner = submissions.find(sub => sub.id === submissionId);
        if (winner) {
          onSelectWinner(winner);
          onClose();
        }
      };

      return (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-xl shadow-2xl max-w-7xl w-full max-h-[90vh] overflow-y-auto">
            <div className="p-6">
              <div className="flex justify-between items-center mb-6">
                <div>
                  <h2 className="text-2xl font-bold text-gray-900">مقایسه پیشنهادات</h2>
                  <p className="text-gray-600 mt-1">{challenge.title}</p>
                </div>
                <button
                  onClick={onClose}
                  className="text-gray-400 hover:text-gray-600 text-2xl"
                >
                  ✕
                </button>
              </div>

              {/* Submission Selection */}
              <div className="bg-gray-50 rounded-lg p-4 mb-6">
                <h3 className="font-semibold text-gray-900 mb-3">انتخاب پیشنهادات برای مقایسه:</h3>
                <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-3">
                  {submissions.map(submission => {
                    const user = JSON.parse(localStorage.getItem('users') || '[]').find(u => u.id === submission.userId);
                    const isSelected = selectedSubmissions.includes(submission.id);
                    const hasScore = submission.scores?.total;

                    return (
                      <div
                        key={submission.id}
                        className={`border-2 rounded-lg p-3 cursor-pointer transition-colors ${
                          isSelected
                            ? 'border-blue-500 bg-blue-50'
                            : 'border-gray-200 hover:border-gray-300'
                        } ${!hasScore ? 'opacity-50' : ''}`}
                        onClick={() => hasScore && toggleSubmission(submission.id)}
                      >
                        <div className="flex items-center justify-between mb-2">
                          <span className={`text-sm ${isSelected ? 'text-blue-700 font-medium' : 'text-gray-700'}`}>
                            {user?.name || 'ناشناس'}
                          </span>
                          {hasScore && (
                            <span className="text-lg font-bold text-green-600">
                              {submission.scores.total}/10
                            </span>
                          )}
                        </div>
                        <p className="text-sm text-gray-600 line-clamp-2">{submission.data.summary}</p>
                        {!hasScore && (
                          <p className="text-xs text-orange-600 mt-1">هنوز نمره‌گذاری نشده</p>
                        )}
                      </div>
                    );
                  })}
                </div>
              </div>

              {/* Side-by-Side Comparison */}
              {selectedSubmissions.length === 2 && (
                <div className="grid md:grid-cols-2 gap-6">
                  {getSelectedSubmissions().map((submission, index) => {
                    const user = JSON.parse(localStorage.getItem('users') || '[]').find(u => u.id === submission.userId);

                    return (
                      <div key={submission.id} className="border border-gray-200 rounded-lg p-6">
                        <div className="flex items-center justify-between mb-4">
                          <h3 className="text-lg font-semibold text-gray-900">
                            گزینه {index + 1}: {user?.name || 'ناشناس'}
                          </h3>
                          {submission.scores?.total && (
                            <div className="text-right">
                              <div className="text-2xl font-bold text-green-600">
                                {submission.scores.total}/10
                              </div>
                              <button
                                onClick={() => handleSelectWinner(submission.id)}
                                className="mt-2 px-4 py-2 bg-green-600 text-white text-sm rounded-lg hover:bg-green-700 transition-colors"
                              >
                                🏆 انتخاب به عنوان برنده
                              </button>
                            </div>
                          )}
                        </div>

                        {/* Scores Breakdown */}
                        {submission.scores && (
                          <div className="grid grid-cols-2 gap-4 mb-4">
                            <div className="bg-blue-50 p-3 rounded">
                              <div className="text-sm text-blue-700">تطابق</div>
                              <div className="text-lg font-bold">{submission.scores.fit}/10</div>
                            </div>
                            <div className="bg-purple-50 p-3 rounded">
                              <div className="text-sm text-purple-700">قابل اجرا</div>
                              <div className="text-lg font-bold">{submission.scores.feasibility}/10</div>
                            </div>
                            <div className="bg-orange-50 p-3 rounded">
                              <div className="text-sm text-orange-700">هزینه/زمان</div>
                              <div className="text-lg font-bold">{submission.scores.costTime}/10</div>
                            </div>
                            <div className="bg-pink-50 p-3 rounded">
                              <div className="text-sm text-pink-700">نوآوری</div>
                              <div className="text-lg font-bold">{submission.scores.innovation}/10</div>
                            </div>
                          </div>
                        )}

                        {/* Proposal Details */}
                        <div className="space-y-3">
                          <div>
                            <h4 className="font-medium text-gray-900">خلاصه:</h4>
                            <p className="text-gray-700 text-sm">{submission.data.summary}</p>
                          </div>
                          <div>
                            <h4 className="font-medium text-gray-900">جزئیات:</h4>
                            <p className="text-gray-700 text-sm line-clamp-4">{submission.data.proposal}</p>
                          </div>
                          <div className="flex items-center gap-4 text-sm text-gray-500">
                            <span>📅 {new Date(submission.createdAt).toLocaleDateString('fa-IR')}</span>
                            {submission.data.files?.length > 0 && (
                              <span>📎 {submission.data.files.length} فایل</span>
                            )}
                            {submission.data.video && <span>🎥 ویدیو</span>}
                          </div>
                        </div>
                      </div>
                    );
                  })}
                </div>
              )}

              {selectedSubmissions.length !== 2 && (
                <div className="text-center py-12">
                  <div className="text-4xl mb-4">⚖️</div>
                  <p className="text-gray-500">
                    لطفاً دقیقاً ۲ پیشنهاد را برای مقایسه انتخاب کنید
                  </p>
                </div>
              )}
            </div>
          </div>
        </div>
      );
    }

    // Duplicate ToastContainer removed; using single definition above.

    // Reputation update function
    const updateReputation = (userId, points, reason) => {
      const users = storage.get(KEYS.users, []);
      const userIndex = users.findIndex(u => u.id === userId);

      if (userIndex !== -1) {
        users[userIndex].reputation = (users[userIndex].reputation || 0) + points;
        storage.set(KEYS.users, users);

        // Add reputation event
        const reputationEvents = storage.get(KEYS.reputationEvents, []);
        reputationEvents.push({
          id: `rep-${Date.now()}`,
          userId: userId,
          type: reason,
          points: points,
          at: new Date().toISOString(),
          description: `امتیاز ${points > 0 ? 'کسب شده' : 'کاهش یافته'} به دلیل: ${reason}`
        });
        storage.set(KEYS.reputationEvents, reputationEvents);

        return users[userIndex];
      }
      return null;
    };

    // Message Thread Component
    function MessageThread({ submission, session, users, onSendMessage, onMarkAsRead }) {
      const [newMessage, setNewMessage] = React.useState('');
      const [sending, setSending] = React.useState(false);

      // Get messages for this submission
      const submissionMessages = JSON.parse(localStorage.getItem('messages') || '[]')
        .filter(msg => msg.submissionId === submission.id)
        .sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt));

      // Mark messages as read when viewing
      React.useEffect(() => {
        const unreadMessages = submissionMessages.filter(msg =>
          msg.fromUserId !== session.userId && !msg.readAt
        );

        if (unreadMessages.length > 0) {
          unreadMessages.forEach(msg => {
            const allMessages = JSON.parse(localStorage.getItem('messages') || '[]');
            const messageIndex = allMessages.findIndex(m => m.id === msg.id);
            if (messageIndex !== -1) {
              allMessages[messageIndex].readAt = new Date().toISOString();
              localStorage.setItem('messages', JSON.stringify(allMessages));
            }
          });
          onMarkAsRead && onMarkAsRead();
        }
      }, [submissionMessages, session.userId]);

      const handleSendMessage = async () => {
        if (!newMessage.trim()) return;

        setSending(true);
        try {
          const messageData = {
            id: `msg-${Date.now()}`,
            submissionId: submission.id,
            fromUserId: session.userId,
            body: newMessage.trim(),
            createdAt: new Date().toISOString(),
            readAt: null
          };

          const messages = JSON.parse(localStorage.getItem('messages') || '[]');
          messages.push(messageData);
          localStorage.setItem('messages', JSON.stringify(messages));

          onSendMessage && onSendMessage(messageData);
          setNewMessage('');

          // Show toast notification
          console.log('Message sent successfully');
        } catch (error) {
          console.error('Error sending message:', error);
        } finally {
          setSending(false);
        }
      };

      const getSenderName = (userId) => {
        const user = users.find(u => u.id === userId);
        return user?.name || 'ناشناس';
      };

      const formatTime = (dateString) => {
        return new Date(dateString).toLocaleString('fa-IR', {
          year: 'numeric',
          month: 'short',
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });
      };

      return (
        <div className="flex flex-col h-full">
          {/* Header */}
          <div className="bg-white border-b p-4">
            <h3 className="text-lg font-semibold text-gray-900">
              گفتگوی پیشنهاد: {submission.data.summary.slice(0, 50)}...
            </h3>
            <p className="text-sm text-gray-600 mt-1">
              {(() => {
                const challenge = JSON.parse(localStorage.getItem('challenges') || '[]').find(c => c.id === submission.challengeId);
                const otherUserId = session.role === 'SEEKER'
                  ? submission.userId
                  : (challenge?.orgId === session.orgId ? submission.userId : 'u-seeker');

                return `بین ${getSenderName(session.userId)} و ${getSenderName(otherUserId)}`;
              })()}
            </p>
          </div>

          {/* Messages */}
          <div className="flex-1 overflow-y-auto p-4 space-y-4">
            {submissionMessages.length > 0 ? (
              submissionMessages.map(message => {
                const isFromMe = message.fromUserId === session.userId;
                const sender = users.find(u => u.id === message.fromUserId);

                return (
                  <div key={message.id} className={`flex ${isFromMe ? 'justify-end' : 'justify-start'}`}>
                    <div className={`max-w-xs lg:max-w-md px-4 py-2 rounded-lg ${
                      isFromMe
                        ? 'bg-blue-500 text-white'
                        : 'bg-gray-200 text-gray-900'
                    }`}>
                      <div className="text-sm font-medium mb-1">
                        {sender?.name || 'ناشناس'}
                      </div>
                      <div className="text-sm">{message.body}</div>
                      <div className={`text-xs mt-1 ${isFromMe ? 'text-blue-100' : 'text-gray-500'}`}>
                        {formatTime(message.createdAt)}
                        {message.readAt && isFromMe && (
                          <span className="ml-2">✓✓</span>
                        )}
                      </div>
                    </div>
                  </div>
                );
              })
            ) : (
              <div className="text-center py-8">
                <div className="text-4xl mb-4">💬</div>
                <p className="text-gray-500">هنوز پیامی ارسال نشده است</p>
              </div>
            )}
          </div>

          {/* Message Composer */}
          <div className="border-t bg-white p-4">
            <div className="flex gap-2">
              <textarea
                value={newMessage}
                onChange={(e) => setNewMessage(e.target.value)}
                placeholder="پیام خود را بنویسید..."
                className="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 resize-none"
                rows="2"
                onKeyPress={(e) => {
                  if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    handleSendMessage();
                  }
                }}
              />
              <button
                onClick={handleSendMessage}
                disabled={sending || !newMessage.trim()}
                className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 focus:ring-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
              >
                {sending ? 'در حال ارسال...' : '📤 ارسال'}
              </button>
            </div>
          </div>
        </div>
      );
    }

    // Messages Overview Component
    function MessagesOverview({ session, submissions, challenges, users, onSelectThread }) {
      const [messages, setMessages] = React.useState([]);

      React.useEffect(() => {
        const allMessages = JSON.parse(localStorage.getItem('messages') || '[]');
        setMessages(allMessages);
      }, []);

      // Get threads for current user
      const getUserThreads = () => {
        if (session.role === 'ADMIN') {
          // Admin sees all threads
          return [...new Set(messages.map(msg => msg.submissionId))];
        } else {
          // Seeker sees threads for their organization's submissions
          // Solver sees threads for their submissions
          return [...new Set(
            messages
              .filter(msg => {
                const submission = JSON.parse(localStorage.getItem('submissions') || '[]')
                  .find(sub => sub.id === msg.submissionId);

                if (!submission) return false;

                if (session.role === 'SEEKER') {
                  const challenge = challenges.find(c => c.id === submission.challengeId);
                  return challenge && challenge.orgId === session.orgId;
                } else if (session.role === 'SOLVER') {
                  return submission.userId === session.userId;
                }

                return false;
              })
              .map(msg => msg.submissionId)
          )];
        }
      };

      const threads = getUserThreads();

      const getThreadInfo = (submissionId) => {
        const submission = submissions.find(sub => sub.id === submissionId);
        const threadMessages = messages.filter(msg => msg.submissionId === submissionId);
        const lastMessage = threadMessages.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))[0];

        const unreadCount = threadMessages.filter(msg =>
          msg.fromUserId !== session.userId && !msg.readAt
        ).length;

        return {
          submission,
          lastMessage,
          unreadCount,
          totalMessages: threadMessages.length
        };
      };

      const formatTime = (dateString) => {
        const date = new Date(dateString);
        const now = new Date();
        const diffMs = now - date;
        const diffHours = diffMs / (1000 * 60 * 60);

        if (diffHours < 24) {
          return date.toLocaleTimeString('fa-IR', {
            hour: '2-digit',
            minute: '2-digit'
          });
        } else {
          return date.toLocaleDateString('fa-IR', {
            month: 'short',
            day: 'numeric'
          });
        }
      };

      return (
        <div className="space-y-6">
          <header className="text-center py-6">
            <h1 className="text-2xl font-bold text-gray-900 mb-2">پیام‌ها</h1>
            <p className="text-gray-600">گفتگوهای پیشنهادات</p>
          </header>

          <div className="bg-white rounded-xl shadow p-6">
            <h2 className="text-lg font-semibold mb-4">گفتگوها</h2>

            {threads.length > 0 ? (
              <div className="space-y-3">
                {threads.map(submissionId => {
                  const { submission, lastMessage, unreadCount, totalMessages } = getThreadInfo(submissionId);
                  const challenge = challenges.find(c => c.id === submission?.challengeId);
                  const otherUserId = session.role === 'SEEKER'
                    ? submission?.userId
                    : challenge?.orgId;
                  const otherUser = users.find(u => u.id === otherUserId);

                  return (
                    <div
                      key={submissionId}
                      onClick={() => onSelectThread && onSelectThread(submission)}
                      className="p-4 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer transition-colors"
                    >
                      <div className="flex justify-between items-start">
                        <div className="flex-1">
                          <div className="flex items-center gap-2 mb-1">
                            <h3 className="font-medium text-gray-900">
                              {submission?.data.summary.slice(0, 60)}...
                            </h3>
                            {unreadCount > 0 && (
                              <span className="bg-red-500 text-white text-xs px-2 py-1 rounded-full">
                                {unreadCount}
                              </span>
                            )}
                          </div>
                          <p className="text-sm text-gray-600 mb-1">
                            چالش: {challenge?.title || 'نامشخص'}
                          </p>
                          <p className="text-sm text-gray-500">
                            با: {otherUser?.name || 'ناشناس'}
                          </p>
                        </div>
                        <div className="text-left">
                          {lastMessage && (
                            <div className="text-xs text-gray-500">
                              {formatTime(lastMessage.createdAt)}
                            </div>
                          )}
                          <div className="text-xs text-gray-400 mt-1">
                            {totalMessages} پیام
                          </div>
                        </div>
                      </div>
                      {lastMessage && (
                        <div className="mt-2 text-sm text-gray-700 line-clamp-1">
                          {lastMessage.body}
                        </div>
                      )}
                    </div>
                  );
                })}
              </div>
            ) : (
              <div className="text-center py-12">
                <div className="text-4xl mb-4">💬</div>
                <p className="text-gray-500">هنوز گفتگویی ندارید</p>
                <p className="text-sm text-gray-400 mt-2">
                  پیام‌ها در این بخش نمایش داده خواهند شد
                </p>
              </div>
            )}
          </div>
        </div>
      );
    }

    // Countdown Timer Component
    function CountdownTimer({ targetDate }) {
      const [timeLeft, setTimeLeft] = React.useState(calculateTimeLeft());

      function calculateTimeLeft() {
        const difference = new Date(targetDate) - new Date();
        let timeLeft = {};

        if (difference > 0) {
          timeLeft = {
            days: Math.floor(difference / (1000 * 60 * 60 * 24)),
            hours: Math.floor((difference / (1000 * 60 * 60)) % 24),
            minutes: Math.floor((difference / 1000 / 60) % 60),
            seconds: Math.floor((difference / 1000) % 60)
          };
        }

        return timeLeft;
      }

      React.useEffect(() => {
        const timer = setTimeout(() => {
          setTimeLeft(calculateTimeLeft());
        }, 1000);

        return () => clearTimeout(timer);
      });

      const timerComponents = [];

      Object.keys(timeLeft).forEach((interval) => {
        if (!timeLeft[interval]) {
          return;
        }

        const label = {
          days: 'روز',
          hours: 'ساعت',
          minutes: 'دقیقه',
          seconds: 'ثانیه'
        }[interval];

        timerComponents.push(
          <span key={interval} className="mx-2">
            <span className="text-2xl font-bold text-blue-600">{timeLeft[interval]}</span>
            <span className="text-sm text-gray-600 mr-1">{label}</span>
          </span>
        );
      });

      return (
        <div className="text-center">
          {timerComponents.length ? (
            <div className="flex justify-center items-center">
              {timerComponents}
            </div>
          ) : (
            <div className="text-lg font-semibold text-green-600">
              🎉 نمایشگاه TESTA آغاز شده است!
            </div>
          )}
        </div>
      );
    }

    // Announcements Rolling Bulletin Component
    function RollingAnnouncements({ announcements }) {
      const [currentIndex, setCurrentIndex] = React.useState(0);

      React.useEffect(() => {
        const interval = setInterval(() => {
          setCurrentIndex((prevIndex) =>
            prevIndex === announcements.length - 1 ? 0 : prevIndex + 1
          );
        }, 4000); // Change announcement every 4 seconds

        return () => clearInterval(interval);
      }, [announcements.length]);

      if (!announcements || announcements.length === 0) {
        return null;
      }

      return (
        <div className="bg-gradient-to-r from-blue-600 to-purple-600 text-white p-4 rounded-lg shadow-lg mb-6">
          <div className="flex items-center justify-center">
            <div className="text-2xl mr-3">📢</div>
            <div className="text-center">
              <div className="font-semibold text-lg mb-1">اعلان ویژه</div>
              <div className="text-sm opacity-90">
                {announcements[currentIndex]}
              </div>
            </div>
          </div>
        </div>
      );
    }

    // Duplicate UI loader components removed (LoadingSpinner, SkeletonLoader, PageLoader, ButtonLoader).

    // Duplicate Enhanced Form Components removed; using earlier definitions.

    // Animation Components
    function FadeIn({ children, delay = 0, className = '' }) {
      return (
        <div
          className={`animate-fade-in ${className}`}
          style={{ animationDelay: `${delay}ms` }}
        >
          {children}
        </div>
      );
    }

    function SlideIn({ children, direction = 'up', delay = 0, className = '' }) {
      const directionClasses = {
        up: 'animate-slide-in-up',
        down: 'animate-slide-in-down',
        left: 'animate-slide-in-left',
        right: 'animate-slide-in-right'
      };

      return (
        <div
          className={`${directionClasses[direction]} ${className}`}
          style={{ animationDelay: `${delay}ms` }}
        >
          {children}
        </div>
      );
    }

    function ScaleIn({ children, delay = 0, className = '' }) {
      return (
        <div
          className={`animate-scale-in ${className}`}
          style={{ animationDelay: `${delay}ms` }}
        >
          {children}
        </div>
      );
    }

    // Notification System with Animations
    function Notification({ type = 'info', title, message, onClose, autoClose = 5000 }) {
      const [visible, setVisible] = React.useState(true);

      React.useEffect(() => {
        if (autoClose > 0) {
          const timer = setTimeout(() => {
            setVisible(false);
            setTimeout(onClose, 300); // Wait for animation
          }, autoClose);
          return () => clearTimeout(timer);
        }
      }, [autoClose, onClose]);

      const typeStyles = {
        success: 'bg-green-50 border-green-200 text-green-800',
        error: 'bg-red-50 border-red-200 text-red-800',
        warning: 'bg-yellow-50 border-yellow-200 text-yellow-800',
        info: 'bg-blue-50 border-blue-200 text-blue-800'
      };

      const iconStyles = {
        success: '✅',
        error: '❌',
        warning: '⚠️',
        info: 'ℹ️'
      };

      if (!visible) return null;

      return (
        <div className={`fixed top-4 left-4 z-50 max-w-sm animate-slide-in-right`}>
          <div className={`p-4 rounded-lg border shadow-lg ${typeStyles[type]}`}>
            <div className="flex items-start gap-3">
              <span className="text-lg">{iconStyles[type]}</span>
              <div className="flex-1">
                {title && <h4 className="font-semibold text-sm mb-1">{title}</h4>}
                <p className="text-sm">{message}</p>
              </div>
              <button
                onClick={() => {
                  setVisible(false);
                  setTimeout(onClose, 300);
                }}
                className="text-gray-400 hover:text-gray-600 transition-colors"
                aria-label="بستن اعلان"
              >
                ✕
              </button>
            </div>
          </div>
        </div>
      );
    }

    // QR Code Generator Component
    function QRCodeGenerator({ text, size = 128, className = "" }) {
      const canvasRef = React.useRef(null);

      React.useEffect(() => {
        if (canvasRef.current && text) {
          generateQRCode(text, size);
        }
      }, [text, size]);

      const generateQRCode = (data, canvasSize) => {
        const canvas = canvasRef.current;
        const ctx = canvas.getContext('2d');

        // Clear canvas
        ctx.clearRect(0, 0, canvasSize, canvasSize);

        // Simple QR-like pattern generation (simplified for demo)
        // In a real implementation, you'd use a proper QR code library
        const pattern = generateQRPattern(data, 21); // 21x21 QR code

        const moduleSize = canvasSize / pattern.length;

        // Draw the pattern
        for (let y = 0; y < pattern.length; y++) {
          for (let x = 0; x < pattern.length; x++) {
            if (pattern[y][x]) {
              ctx.fillStyle = '#000000';
              ctx.fillRect(x * moduleSize, y * moduleSize, moduleSize, moduleSize);
            }
          }
        }

        // Add finder patterns (the big squares at corners)
        drawFinderPattern(ctx, 0, 0, moduleSize);
        drawFinderPattern(ctx, pattern.length - 7, 0, moduleSize);
        drawFinderPattern(ctx, 0, pattern.length - 7, moduleSize);
      };

      const generateQRPattern = (data, size) => {
        // Create a simple but more recognizable QR-like pattern
        const pattern = Array(size).fill().map(() => Array(size).fill(false));

        // Generate a hash from the data
        let hash = 0;
        for (let i = 0; i < data.length; i++) {
          hash = ((hash << 5) - hash) + data.charCodeAt(i);
          hash = hash & hash; // Convert to 32-bit integer
        }

        // Create a more structured pattern
        for (let i = 0; i < size; i++) {
          for (let j = 0; j < size; j++) {
            // Use multiple hash functions for better distribution
            const h1 = (hash + i * 31 + j * 37) % 2;
            const h2 = ((hash >> 8) + i * 41 + j * 43) % 2;
            const h3 = ((hash >> 16) + i * 47 + j * 53) % 2;

            // Combine patterns to create a more QR-like appearance
            pattern[i][j] = (h1 + h2 + h3) >= 2;
          }
        }

        // Reserve space for finder patterns (keep them solid)
        for (let i = 0; i < 7; i++) {
          for (let j = 0; j < 7; j++) {
            pattern[i][j] = true;
            pattern[size - 1 - i][j] = true;
            pattern[i][size - 1 - j] = true;
          }
        }

        // Add some timing patterns (alternating black/white)
        for (let i = 8; i < size - 8; i += 2) {
          pattern[6][i] = true; // Top timing pattern
          pattern[i][6] = true; // Left timing pattern
        }

        return pattern;
      };

      const drawFinderPattern = (ctx, startX, startY, moduleSize) => {
        const size = 7;
        ctx.fillStyle = '#000000';

        // Draw the outer square
        ctx.fillRect(startX * moduleSize, startY * moduleSize, size * moduleSize, size * moduleSize);

        // Draw the inner white square
        ctx.fillStyle = '#FFFFFF';
        ctx.fillRect((startX + 1) * moduleSize, (startY + 1) * moduleSize, 5 * moduleSize, 5 * moduleSize);

        // Draw the inner black square
        ctx.fillStyle = '#000000';
        ctx.fillRect((startX + 2) * moduleSize, (startY + 2) * moduleSize, 3 * moduleSize, 3 * moduleSize);
      };

      const downloadQR = () => {
        const canvas = canvasRef.current;
        const link = document.createElement('a');
        link.download = 'qr-code.png';
        link.href = canvas.toDataURL();
        link.click();
      };

      if (!text) {
        return (
          <div className={`flex items-center justify-center bg-gray-100 rounded-lg ${className}`}
               style={{ width: size, height: size }}>
            <div className="text-gray-400 text-sm">No data</div>
          </div>
        );
      }

      const scanQR = () => {
        // Simulate QR scan by navigating to the target route
        try {
          const url = new URL(text);
          if (url.pathname && url.pathname !== '/') {
            const route = url.pathname.substring(1); // Remove leading slash
            const hash = url.hash; // Get the hash part
            window.location.hash = route + hash;
            console.log('QR Scanned - Navigating to:', route + hash);

            // Update QR scan stats
            const currentStats = JSON.parse(localStorage.getItem('testaStats') || '{}');
            currentStats.qrScans = (currentStats.qrScans || 0) + 1;
            localStorage.setItem('testaStats', JSON.stringify(currentStats));
          }
        } catch (error) {
          console.error('Invalid QR code URL:', text);
        }
      };

      return (
        <div className={`inline-block ${className}`}>
          <canvas
            ref={canvasRef}
            width={size}
            height={size}
            className="border border-gray-300 rounded cursor-pointer hover:border-blue-500 transition-colors"
            onClick={scanQR}
            title="برای اسکن کلیک کنید"
          />
          <div className="mt-2 flex gap-2">
            <button
              onClick={downloadQR}
              className="flex-1 px-2 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700 transition-colors"
            >
              📥 دانلود
            </button>
            <button
              onClick={scanQR}
              className="flex-1 px-2 py-1 bg-green-600 text-white text-xs rounded hover:bg-green-700 transition-colors"
            >
              📱 اسکن
            </button>
          </div>
        </div>
      );
    }

    // Statistics Dashboard Component
    function TESTAStatsPage({ session }) {
      const [stats, setStats] = React.useState({
        visitorsToday: 0,
        qrScans: 0,
        sessionsStarted: 0,
        eventRegistrations: 0,
        messagesSent: 0
      });

      React.useEffect(() => {
        // Load stats from localStorage or generate mock data
        const loadStats = () => {
          const today = new Date().toDateString();
          const storedStats = JSON.parse(localStorage.getItem('testaStats') || '{}');

          if (storedStats.date !== today) {
            // Reset for new day
            const newStats = {
              date: today,
              visitorsToday: Math.floor(Math.random() * 50) + 20,
              qrScans: Math.floor(Math.random() * 30) + 10,
              sessionsStarted: Math.floor(Math.random() * 15) + 5,
              eventRegistrations: JSON.parse(localStorage.getItem('eventRegistrations') || '[]').length,
              messagesSent: JSON.parse(localStorage.getItem('messages') || '[]').length
            };
            localStorage.setItem('testaStats', JSON.stringify(newStats));
            setStats(newStats);
          } else {
            setStats(storedStats);
          }
        };

        loadStats();

        // Update stats periodically
        const interval = setInterval(() => {
          const currentStats = JSON.parse(localStorage.getItem('testaStats') || '{}');
          setStats(currentStats);
        }, 5000);

        return () => clearInterval(interval);
      }, []);

      const SimpleBarChart = ({ data, maxValue, color = '#3B82F6' }) => {
        return (
          <div className="flex items-end gap-2 h-32">
            {data.map((value, index) => (
              <div key={index} className="flex flex-col items-center gap-1">
                <div
                  className="w-8 bg-blue-500 rounded-t transition-all duration-500"
                  style={{
                    height: `${(value / maxValue) * 100}%`,
                    backgroundColor: color
                  }}
                />
                <span className="text-xs text-gray-500">{value}</span>
              </div>
            ))}
          </div>
        );
      };

      const PieChart = ({ data, colors = ['#3B82F6', '#EF4444', '#10B981'] }) => {
        const total = data.reduce((sum, value) => sum + value, 0);
        let currentAngle = -90; // Start from top

        return (
          <div className="relative w-32 h-32 mx-auto">
            <svg viewBox="0 0 100 100" className="w-full h-full">
              {data.map((value, index) => {
                const angle = (value / total) * 360;
                const startAngle = currentAngle;
                const endAngle = currentAngle + angle;

                const x1 = 50 + 40 * Math.cos((startAngle * Math.PI) / 180);
                const y1 = 50 + 40 * Math.sin((startAngle * Math.PI) / 180);
                const x2 = 50 + 40 * Math.cos((endAngle * Math.PI) / 180);
                const y2 = 50 + 40 * Math.sin((endAngle * Math.PI) / 180);

                const largeArcFlag = angle > 180 ? 1 : 0;

                currentAngle = endAngle;

                return (
                  <path
                    key={index}
                    d={`M 50 50 L ${x1} ${y1} A 40 40 0 ${largeArcFlag} 1 ${x2} ${y2} Z`}
                    fill={colors[index % colors.length]}
                  />
                );
              })}
            </svg>
          </div>
        );
      };

      return (
        <div className="space-y-6">
          <header className="text-center py-6">
            <h1 className="text-2xl font-bold text-gray-900 mb-2">📊 آمار TESTA</h1>
            <p className="text-gray-600">آمار لحظه‌ای نمایشگاه</p>
          </header>

          {/* Key Metrics */}
          <div className="grid md:grid-cols-2 lg:grid-cols-4 gap-6">
            <div className="bg-white rounded-xl shadow p-6 text-center">
              <div className="text-3xl mb-2">👥</div>
              <div className="text-2xl font-bold text-blue-600">{stats.visitorsToday}</div>
              <div className="text-sm text-gray-600">بازدیدکننده امروز</div>
            </div>

            <div className="bg-white rounded-xl shadow p-6 text-center">
              <div className="text-3xl mb-2">📱</div>
              <div className="text-2xl font-bold text-green-600">{stats.qrScans}</div>
              <div className="text-sm text-gray-600">اسکن QR</div>
            </div>

            <div className="bg-white rounded-xl shadow p-6 text-center">
              <div className="text-3xl mb-2">💬</div>
              <div className="text-2xl font-bold text-purple-600">{stats.sessionsStarted}</div>
              <div className="text-sm text-gray-600">جلسه شروع شده</div>
            </div>

            <div className="bg-white rounded-xl shadow p-6 text-center">
              <div className="text-3xl mb-2">🎫</div>
              <div className="text-2xl font-bold text-orange-600">{stats.eventRegistrations}</div>
              <div className="text-sm text-gray-600">ثبت‌نام رویداد</div>
            </div>
          </div>

          {/* Charts */}
          <div className="grid md:grid-cols-2 gap-6">
            {/* Visitors Trend */}
            <div className="bg-white rounded-xl shadow p-6">
              <h3 className="text-lg font-semibold mb-4">نمودار بازدیدکنندگان</h3>
              <SimpleBarChart
                data={[12, 19, 15, 25, stats.visitorsToday, 28, 22]}
                maxValue={40}
                color="#3B82F6"
              />
              <div className="flex justify-between mt-2 text-xs text-gray-500">
                <span>شنبه</span>
                <span>یکشنبه</span>
                <span>دوشنبه</span>
                <span>سه‌شنبه</span>
                <span>چهارشنبه</span>
                <span>پنج‌شنبه</span>
                <span>جمعه</span>
              </div>
            </div>

            {/* Activity Distribution */}
            <div className="bg-white rounded-xl shadow p-6">
              <h3 className="text-lg font-semibold mb-4">توزیع فعالیت‌ها</h3>
              <PieChart
                data={[stats.qrScans, stats.eventRegistrations, stats.messagesSent]}
              />
              <div className="mt-4 space-y-2">
                <div className="flex items-center gap-2">
                  <div className="w-3 h-3 bg-blue-500 rounded"></div>
                  <span className="text-sm">اسکن QR</span>
                </div>
                <div className="flex items-center gap-2">
                  <div className="w-3 h-3 bg-red-500 rounded"></div>
                  <span className="text-sm">ثبت‌نام رویداد</span>
                </div>
                <div className="flex items-center gap-2">
                  <div className="w-3 h-3 bg-green-500 rounded"></div>
                  <span className="text-sm">پیام‌ها</span>
                </div>
              </div>
            </div>
          </div>

          {/* QR Code Testing */}
          <div className="bg-white rounded-xl shadow p-6">
            <h3 className="text-lg font-semibold mb-4">🧪 آزمایش ویژگی‌های پیشرفته</h3>
            <div className="grid md:grid-cols-2 gap-6">
              <div>
                <h4 className="font-medium mb-3">📱 آزمایش QR Code</h4>
                <ul className="text-sm text-gray-600 space-y-1">
                  <li>• روی کد QR کلیک کنید</li>
                  <li>• یا از دکمه "اسکن" استفاده کنید</li>
                  <li>• آمار اسکن‌ها به‌روزرسانی می‌شود</li>
                  <li>• به صفحه مربوطه منتقل خواهید شد</li>
                </ul>
              </div>
              <div>
                <h4 className="font-medium mb-3">🖥️ حالت کیوسک</h4>
                <ul className="text-sm text-gray-600 space-y-1">
                  <li>• از پنل مدیریت وارد حالت کیوسک شوید</li>
                  <li>• اندازه UI بزرگ‌تر می‌شود</li>
                  <li>• ایمیل‌ها محافظت می‌شوند</li>
                  <li>• پس از ۵ دقیقه عدم فعالیت، خروج خودکار</li>
                </ul>
              </div>
            </div>
          </div>

          {/* Recent Activity */}
          <div className="bg-white rounded-xl shadow p-6">
            <h3 className="text-lg font-semibold mb-4">فعالیت‌های اخیر</h3>
            <div className="space-y-3">
              <div className="flex items-center gap-3 p-3 bg-blue-50 rounded-lg">
                <div className="text-blue-600">📱</div>
                <div className="flex-1">
                  <div className="font-medium">QR Code اسکن شد</div>
                  <div className="text-sm text-gray-600">برای غرفه پارس‌تک</div>
                </div>
                <div className="text-xs text-gray-500">۲ دقیقه پیش</div>
              </div>

              <div className="flex items-center gap-3 p-3 bg-green-50 rounded-lg">
                <div className="text-green-600">🎫</div>
                <div className="flex-1">
                  <div className="font-medium">ثبت‌نام در رویداد</div>
                  <div className="text-sm text-gray-600">کارگاه IoT و هوشمندسازی</div>
                </div>
                <div className="text-xs text-gray-500">۵ دقیقه پیش</div>
              </div>

              <div className="flex items-center gap-3 p-3 bg-purple-50 rounded-lg">
                <div className="text-purple-600">💬</div>
                <div className="flex-1">
                  <div className="font-medium">پیام جدید</div>
                  <div className="text-sm text-gray-600">در گفتگوی پیشنهاد</div>
                </div>
                <div className="text-xs text-gray-500">۱۰ دقیقه پیش</div>
              </div>
            </div>
          </div>
        </div>
      );
    }

    // Kiosk Mode Context and Hook
    const KioskContext = React.createContext();

    function useKioskMode() {
      const [isKioskMode, setIsKioskMode] = React.useState(() => {
        return JSON.parse(localStorage.getItem('kioskMode') || 'false');
      });

      const [lastActivity, setLastActivity] = React.useState(Date.now());
      const [autoResetInterval, setAutoResetInterval] = React.useState(null);

      const enableKioskMode = () => {
        setIsKioskMode(true);
        localStorage.setItem('kioskMode', 'true');

        // Start auto-reset timer (15 minutes)
        const interval = setInterval(() => {
          resetDemoData();
        }, 15 * 60 * 1000); // 15 minutes

        setAutoResetInterval(interval);
      };

      const disableKioskMode = () => {
        setIsKioskMode(false);
        localStorage.setItem('kioskMode', 'false');

        if (autoResetInterval) {
          clearInterval(autoResetInterval);
          setAutoResetInterval(null);
        }
      };

      const resetDemoData = () => {
        console.log('Auto-resetting demo data...');

        // Reset all demo data
        const seedDataOnce = window.seedDataOnce;
        if (seedDataOnce) {
          localStorage.removeItem('seeded');
          seedDataOnce();
        }

        // Clear session
        localStorage.setItem('session', 'null');

        // Reset kiosk mode
        setIsKioskMode(false);
        localStorage.setItem('kioskMode', 'false');
      };

      const updateActivity = () => {
        setLastActivity(Date.now());
      };

      // Auto-logout on inactivity (5 minutes in kiosk mode)
      React.useEffect(() => {
        if (!isKioskMode) return;

        const checkInactivity = () => {
          const now = Date.now();
          const timeSinceActivity = now - lastActivity;

          if (timeSinceActivity > 5 * 60 * 1000) { // 5 minutes
            console.log('Auto-logout due to inactivity');
            localStorage.setItem('session', 'null');
            window.location.reload();
          }
        };

        const interval = setInterval(checkInactivity, 30000); // Check every 30 seconds
        return () => clearInterval(interval);
      }, [isKioskMode, lastActivity]);

      // Track user activity
      React.useEffect(() => {
        if (!isKioskMode) return;

        const handleActivity = () => updateActivity();

        const events = ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart'];
        events.forEach(event => {
          document.addEventListener(event, handleActivity, true);
        });

        return () => {
          events.forEach(event => {
            document.removeEventListener(event, handleActivity, true);
          });
        };
      }, [isKioskMode]);

      return {
        isKioskMode,
        enableKioskMode,
        disableKioskMode,
        resetDemoData,
        updateActivity
      };
    }

    // Privacy Mask Utility
    function maskEmail(email) {
      if (!email) return '';

      const [username, domain] = email.split('@');
      if (!domain) return email;

      const maskedUsername = username.length > 2
        ? username.substring(0, 2) + '*'.repeat(username.length - 2)
        : username;

      const domainParts = domain.split('.');
      const maskedDomain = domainParts[0].length > 2
        ? domainParts[0].substring(0, 2) + '*'.repeat(domainParts[0].length - 2)
        : domainParts[0];

      return `${maskedUsername}@${maskedDomain}.${domainParts.slice(1).join('.')}`;
    }

    // TESTA Home Page
    function TESTAHomePage({ session }) {
      const [loading, setLoading] = React.useState(true);
      const targetDate = "2024-06-30T09:00:00Z"; // TESTA start date

      const announcements = [
        "🏆 جوایز ویژه برای بهترین طرح‌های نوآورانه",
        "🤝 فرصت ملاقات با سرمایه‌گذاران و شتاب‌دهنده‌ها",
        "🎯 چالش‌های زنده با جوایز نقدی",
        "🌟 نمایش آخرین دستاوردهای فناوری ایران",
        "📅 رویدادهای جانبی در طول نمایشگاه"
      ];

      // Simulate loading
      React.useEffect(() => {
        const timer = setTimeout(() => setLoading(false), 1000);
        return () => clearTimeout(timer);
      }, []);

      if (loading) {
        return <PageLoader message="در حال بارگذاری صفحه اصلی TESTA..." />;
      }

      return (
        <div className="space-y-8">
          {/* Hero Section */}
          <FadeIn>
            <div className="text-center py-12 bg-gradient-to-br from-purple-600 via-blue-600 to-indigo-700 text-white rounded-2xl shadow-2xl">
              <div className="max-w-4xl mx-auto px-6">
              <h1 className="text-5xl font-bold mb-4">
                🎪 TESTA ۲۰۲۴
              </h1>
              <p className="text-xl mb-8 opacity-90">
                نمایشگاه فناوری و نوآوری ایران
              </p>

              {/* Countdown Timer */}
              <div className="bg-white/10 backdrop-blur-sm rounded-xl p-8 mb-8">
                <h2 className="text-2xl font-semibold mb-4">زمان باقی‌مانده تا آغاز نمایشگاه</h2>
                <CountdownTimer targetDate={targetDate} />
              </div>

              <div className="grid md:grid-cols-3 gap-6 text-center">
                <div className="bg-white/10 rounded-lg p-4">
                  <div className="text-3xl mb-2">🏢</div>
                  <div className="font-semibold">۵۰+ شرکت</div>
                  <div className="text-sm opacity-80">نمایشگاه‌دار</div>
                </div>
                <div className="bg-white/10 rounded-lg p-4">
                  <div className="text-3xl mb-2">👥</div>
                  <div className="font-semibold">۱۰۰۰+ بازدیدکننده</div>
                  <div className="text-sm opacity-80">انتظار می‌رود</div>
                </div>
                <div className="bg-white/10 rounded-lg p-4">
                  <div className="text-3xl mb-2">🎯</div>
                  <div className="font-semibold">۲۰+ چالش</div>
                  <div className="text-sm opacity-80">فعال</div>
                </div>
              </div>
            </div>
            </div>
          </FadeIn>

          {/* Rolling Announcements */}
          <FadeIn delay={400}>
            <RollingAnnouncements announcements={announcements} />
          </FadeIn>

          {/* Quick Actions */}
          <FadeIn delay={600}>
            <div className="grid md:grid-cols-2 lg:grid-cols-4 gap-6">
            <div className="bg-white rounded-xl shadow p-6 text-center hover:shadow-lg transition-shadow cursor-pointer"
                 onClick={() => window.location.hash = 'testa-schedule'}>
              <div className="text-4xl mb-4">📅</div>
              <h3 className="font-semibold text-lg mb-2">برنامه روزانه</h3>
              <p className="text-gray-600 text-sm">مشاهده برنامه کامل نمایشگاه</p>
            </div>

            <div className="bg-white rounded-xl shadow p-6 text-center hover:shadow-lg transition-shadow cursor-pointer"
                 onClick={() => window.location.hash = 'testa-events'}>
              <div className="text-4xl mb-4">🎤</div>
              <h3 className="font-semibold text-lg mb-2">رویدادها</h3>
              <p className="text-gray-600 text-sm">ثبت‌نام در کارگاه‌ها و سخنرانی‌ها</p>
            </div>

            <div className="bg-white rounded-xl shadow p-6 text-center hover:shadow-lg transition-shadow cursor-pointer"
                 onClick={() => window.location.hash = 'testa-booths'}>
              <div className="text-4xl mb-4">🏪</div>
              <h3 className="font-semibold text-lg mb-2">نمایشگاه‌ها</h3>
              <p className="text-gray-600 text-sm">گپ زدن با شرکت‌های حاضر</p>
            </div>

            <div className="bg-white rounded-xl shadow p-6 text-center hover:shadow-lg transition-shadow cursor-pointer"
                 onClick={() => window.location.hash = 'challenges'}>
              <div className="text-4xl mb-4">🎯</div>
              <h3 className="font-semibold text-lg mb-2">چالش‌ها</h3>
              <p className="text-gray-600 text-sm">مشارکت در چالش‌های فناوری</p>
            </div>
          </div>
          </FadeIn>

          {/* QR Code Demo Section */}
          <FadeIn delay={800}>
            <div className="bg-white rounded-xl shadow p-6">
            <h2 className="text-lg font-semibold mb-4 flex items-center">
              <span className="ml-2">📱</span>
              کدهای QR قابل آزمایش
            </h2>
            <p className="text-sm text-gray-600 mb-4">
              روی کد QR کلیک کنید یا از دکمه "اسکن" استفاده کنید تا به صفحه مربوطه منتقل شوید
            </p>
            <div className="grid md:grid-cols-3 gap-4">
              <div className="text-center p-4 border rounded-lg">
                <QRCodeGenerator
                  text={`${window.location.origin}/testa-events`}
                  size={100}
                  className="mb-2"
                />
                <p className="text-sm font-medium">رویدادها</p>
                <p className="text-xs text-gray-500">برای آزمایش اسکن</p>
              </div>
              <div className="text-center p-4 border rounded-lg">
                <QRCodeGenerator
                  text={`${window.location.origin}/testa-booths`}
                  size={100}
                  className="mb-2"
                />
                <p className="text-sm font-medium">نمایشگاه‌ها</p>
                <p className="text-xs text-gray-500">برای آزمایش اسکن</p>
              </div>
              <div className="text-center p-4 border rounded-lg">
                <QRCodeGenerator
                  text={`${window.location.origin}/testa-schedule`}
                  size={100}
                  className="mb-2"
                />
                <p className="text-sm font-medium">برنامه</p>
                <p className="text-xs text-gray-500">برای آزمایش اسکن</p>
              </div>
            </div>
          </div>
          </FadeIn>

          {/* About TESTA */}
          <FadeIn delay={1000}>
            <div className="bg-white rounded-xl shadow p-8">
            <h2 className="text-2xl font-bold text-center mb-6">درباره TESTA</h2>
            <div className="grid md:grid-cols-2 gap-8">
              <div>
                <h3 className="text-lg font-semibold mb-4 text-blue-600">🎯 اهداف نمایشگاه</h3>
                <ul className="space-y-2 text-gray-700">
                  <li>• ایجاد پل ارتباطی بین شرکت‌ها و نوآوران</li>
                  <li>• نمایش دستاوردهای فناوری ایران</li>
                  <li>• فرصت سرمایه‌گذاری در ایده‌های نو</li>
                  <li>• برگزاری چالش‌های فناوری زنده</li>
                </ul>
              </div>
              <div>
                <h3 className="text-lg font-semibold mb-4 text-green-600">📅 برنامه زمانی</h3>
                <div className="space-y-2 text-gray-700">
                  <div className="flex justify-between">
                    <span>روز اول:</span>
                    <span>۳۰ خرداد - افتتاحیه و سخنرانی‌ها</span>
                  </div>
                  <div className="flex justify-between">
                    <span>روز دوم:</span>
                    <span>۳۱ خرداد - کارگاه‌ها و چالش‌ها</span>
                  </div>
                  <div className="flex justify-between">
                    <span>روز سوم:</span>
                    <span>۱ تیر - اختتامیه و جوایز</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
          </FadeIn>
        </div>
      );
    }

    // TESTA Schedule Page
    function TESTASchedulePage() {
      const scheduleData = [
        {
          "day": 1,
          "date": "۳۰ خرداد ۱۴۰۳",
          "title": "روز افتتاحیه",
          "events": [
            { "time": "09:00", "title": "افتتاحیه نمایشگاه", "track": "Main", "speaker": "دکتر احمدی", "location": "سالن اصلی" },
            { "time": "10:00", "title": "سخنان کلیدی: آینده فناوری در ایران", "track": "Keynote", "speaker": "مهندس محمدی", "location": "سالن اصلی" },
            { "time": "11:30", "title": "چالش‌های فناوری سال ۱۴۰۳", "track": "Challenges", "speaker": "پنل برگزارکنندگان", "location": "سالن چالش‌ها" },
            { "time": "14:00", "title": "آینده انرژی در ایران", "track": "Energy", "speaker": "دکتر رضایی", "location": "سالن انرژی" },
            { "time": "15:30", "title": "کارگاه IoT و هوشمندسازی", "track": "IoT", "speaker": "مهندس کریمی", "location": "سالن IoT" },
            { "time": "17:00", "title": "اختتامیه روز اول", "track": "Main", "speaker": "-", "location": "سالن اصلی" }
          ]
        },
        {
          "day": 2,
          "date": "۳۱ خرداد ۱۴۰۳",
          "title": "روز تخصصی",
          "events": [
            { "time": "09:00", "title": "بازدید از نمایشگاه‌ها", "track": "Exhibition", "speaker": "-", "location": "تمام سالن‌ها" },
            { "time": "11:00", "title": "اینترنت اشیاء و شهر هوشمند", "track": "IoT", "speaker": "دکتر نوری", "location": "سالن IoT" },
            { "time": "12:30", "title": "ناهار و شبکه‌سازی", "track": "Networking", "speaker": "-", "location": "سالن غذاخوری" },
            { "time": "14:00", "title": "هوش مصنوعی در صنعت", "track": "AI", "speaker": "مهندس احمدی", "location": "سالن AI" },
            { "time": "15:30", "title": "چالش‌های زنده فناوری", "track": "Live Challenges", "speaker": "داوران", "location": "سالن چالش‌ها" },
            { "time": "17:00", "title": "اختتامیه روز دوم", "track": "Main", "speaker": "-", "location": "سالن اصلی" }
          ]
        },
        {
          "day": 3,
          "date": "۱ تیر ۱۴۰۳",
          "title": "روز اختتامیه",
          "events": [
            { "time": "09:00", "title": "مرور دستاوردهای نمایشگاه", "track": "Review", "speaker": "کمیته برگزاری", "location": "سالن اصلی" },
            { "time": "10:30", "title": "ارائه برندگان چالش‌ها", "track": "Awards", "speaker": "هیئت داوران", "location": "سالن اصلی" },
            { "time": "12:00", "title": "ناهار اختتامیه", "track": "Closing", "speaker": "-", "location": "سالن غذاخوری" },
            { "time": "14:00", "title": "کارگاه‌های تخصصی", "track": "Workshops", "speaker": "متخصصین", "location": "سالن‌های مختلف" },
            { "time": "16:00", "title": "اختتامیه نهایی", "track": "Closing", "speaker": "کمیته برگزاری", "location": "سالن اصلی" }
          ]
        }
      ];

      const [selectedDay, setSelectedDay] = React.useState(1);

      const tracks = ["Main", "Keynote", "Energy", "IoT", "AI", "Challenges", "Exhibition", "Networking", "Live Challenges", "Review", "Awards", "Workshops", "Closing"];

      const getTrackColor = (track) => {
        const colors = {
          "Main": "bg-purple-100 text-purple-800",
          "Keynote": "bg-blue-100 text-blue-800",
          "Energy": "bg-green-100 text-green-800",
          "IoT": "bg-orange-100 text-orange-800",
          "AI": "bg-red-100 text-red-800",
          "Challenges": "bg-yellow-100 text-yellow-800",
          "Exhibition": "bg-indigo-100 text-indigo-800",
          "Networking": "bg-pink-100 text-pink-800",
          "Live Challenges": "bg-teal-100 text-teal-800",
          "Review": "bg-cyan-100 text-cyan-800",
          "Awards": "bg-emerald-100 text-emerald-800",
          "Workshops": "bg-violet-100 text-violet-800",
          "Closing": "bg-gray-100 text-gray-800"
        };
        return colors[track] || "bg-gray-100 text-gray-800";
      };

      const selectedDayData = scheduleData.find(day => day["day"] === selectedDay);

      return (
        <div className="space-y-6">
          <header className="text-center py-6">
            <h1 className="text-2xl font-bold text-gray-900 mb-2">برنامه TESTA ۲۰۲۴</h1>
            <p className="text-gray-600">برنامه کامل سه روز نمایشگاه</p>
          </header>

          {/* Day Selector */}
          <div className="flex justify-center mb-8">
            <div className="bg-white rounded-xl shadow p-2 flex">
              {scheduleData.map(day => (
                <button
                  key={day.day}
                  onClick={() => setSelectedDay(day.day)}
                  className={`px-6 py-3 rounded-lg font-medium transition-colors ${
                    selectedDay === day.day
                      ? 'bg-blue-600 text-white'
                      : 'text-gray-600 hover:bg-gray-100'
                  }`}
                >
                  روز {day.day}
                  <div className="text-sm opacity-75">{day.date}</div>
                </button>
              ))}
            </div>
          </div>

          {/* Day Title */}
          <div className="text-center mb-6">
            <h2 className="text-3xl font-bold text-gray-900">{selectedDayData.title}</h2>
            <p className="text-lg text-gray-600">{selectedDayData.date}</p>
          </div>

          {/* Schedule Grid */}
          <div className="bg-white rounded-xl shadow overflow-hidden">
            <div className="overflow-x-auto">
              <table className="w-full">
                <thead className="bg-gray-50">
                  <tr>
                    <th className="px-6 py-4 text-right font-medium text-gray-700">زمان</th>
                    <th className="px-6 py-4 text-right font-medium text-gray-700">عنوان رویداد</th>
                    <th className="px-6 py-4 text-right font-medium text-gray-700">ترک</th>
                    <th className="px-6 py-4 text-right font-medium text-gray-700">سخنران</th>
                    <th className="px-6 py-4 text-right font-medium text-gray-700">مکان</th>
                  </tr>
                </thead>
                <tbody className="divide-y divide-gray-200">
                  {selectedDayData.events.map((event, index) => (
                    <tr key={index} className="hover:bg-gray-50">
                      <td className="px-6 py-4 font-mono font-semibold text-blue-600">
                        {event.time}
                      </td>
                      <td className="px-6 py-4">
                        <div className="font-medium text-gray-900">{event.title}</div>
                      </td>
                      <td className="px-6 py-4">
                        <span className={`px-2 py-1 text-xs rounded-full ${getTrackColor(event.track)}`}>
                          {event.track}
                        </span>
                      </td>
                      <td className="px-6 py-4 text-gray-700">
                        {event.speaker}
                      </td>
                      <td className="px-6 py-4 text-gray-700">
                        {event.location}
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </div>

          {/* Track Legend */}
          <div className="bg-white rounded-xl shadow p-6">
            <h3 className="text-lg font-semibold mb-4">راهنمای ترک‌ها</h3>
            <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
              {tracks.map(track => (
                <div key={track} className="flex items-center gap-2">
                  <span className={`px-2 py-1 text-xs rounded-full ${getTrackColor(track)}`}>
                    {track}
                  </span>
                </div>
              ))}
            </div>
          </div>
        </div>
      );
    }

    // TESTA Events Page with Registration
    function TESTAEventsPage({ session }) {
      const [loading, setLoading] = React.useState(true);
      const [eventRegistrations, setEventRegistrations] = React.useState(() => {
        return JSON.parse(localStorage.getItem('eventRegistrations') || '[]');
      });

      // Simulate loading
      React.useEffect(() => {
        const timer = setTimeout(() => setLoading(false), 800);
        return () => clearTimeout(timer);
      }, []);

      const events = [
        {
          id: "event-1",
          title: "کارگاه IoT و هوشمندسازی صنعتی",
          description: "آموزش عملی پیاده‌سازی راه‌حل‌های IoT در صنعت با استفاده از سنسورهای هوشمند و پلتفرم‌های ابری",
          date: "۱۴۰۳/۰۳/۳۱",
          time: "۱۴:۰۰ - ۱۷:۰۰",
          location: "سالن IoT",
          speaker: "مهندس کریمی",
          capacity: 50,
          registered: 0,
          track: "Workshop",
          requirements: "دانش پایه برنامه‌نویسی و الکترونیک"
        },
        {
          id: "event-2",
          title: "سخنان کلیدی: آینده هوش مصنوعی در ایران",
          description: "بررسی فرصت‌ها و چالش‌های توسعه هوش مصنوعی در ایران و نقش آن در تحول دیجیتال",
          date: "۱۴۰۳/۰۳/۳۱",
          time: "۱۰:۰۰ - ۱۱:۳۰",
          location: "سالن اصلی",
          speaker: "دکتر احمدی",
          capacity: 200,
          registered: 0,
          track: "Keynote",
          requirements: "علاقه‌مندی به موضوعات فناوری"
        },
        {
          id: "event-3",
          title: "چالش زنده: راه‌حل‌های انرژی پاک",
          description: "مسابقه زنده برای ارائه راه‌حل‌های نوآورانه در حوزه انرژی‌های تجدیدپذیر",
          date: "۱۴۰۳/۰۳/۳۱",
          time: "۱۵:۳۰ - ۱۷:۰۰",
          location: "سالن چالش‌ها",
          speaker: "هیئت داوران",
          capacity: 100,
          registered: 0,
          track: "Live Challenge",
          requirements: "دانش فنی در حوزه انرژی"
        },
        {
          id: "event-4",
          title: "شبکه‌سازی با سرمایه‌گذاران",
          description: "فرصت ملاقات و گفتگوی مستقیم با سرمایه‌گذاران ریسک‌پذیر و شتاب‌دهنده‌های فناوری",
          date: "۱۴۰۳/۰۴/۰۱",
          time: "۱۴:۰۰ - ۱۶:۰۰",
          location: "سالن شبکه‌سازی",
          speaker: "متخصصین سرمایه‌گذاری",
          capacity: 30,
          registered: 0,
          track: "Networking",
          requirements: "داشتن محصول یا ایده آماده سرمایه‌گذاری"
        },
        {
          id: "event-5",
          title: "کارگاه توسعه محصول دیجیتال",
          description: "آموزش روش‌های مدرن توسعه محصول دیجیتال از ایده تا بازار با رویکرد چابک",
          date: "۱۴۰۳/۰۴/۰۱",
          time: "۰۹:۰۰ - ۱۲:۰۰",
          location: "سالن استارت‌آپ",
          speaker: "کارشناسان محصول",
          capacity: 40,
          registered: 0,
          track: "Workshop",
          requirements: "تجربه کاری در حوزه فناوری"
        },
        {
          id: "event-6",
          title: "ارائه برندگان چالش‌ها",
          description: "معرفی و تقدیر از برندگان چالش‌های TESTA با جوایز ویژه",
          date: "۱۴۰۳/۰۴/۰۱",
          time: "۱۰:۳۰ - ۱۲:۰۰",
          location: "سالن اصلی",
          speaker: "هیئت داوران",
          capacity: 300,
          registered: 0,
          track: "Awards",
          requirements: "ثبت‌نام در چالش‌ها"
        }
      ];

      const [selectedEvent, setSelectedEvent] = React.useState(null);
      const [showRegistrationForm, setShowRegistrationForm] = React.useState(false);
      const [registrationForm, setRegistrationForm] = React.useState({
        "name": session?.name || '',
        "email": session?.email || '',
        "role": session?.role || 'SOLVER',
        "organization": '',
        "expectations": ''
      });

      // Update registered counts from localStorage
      React.useEffect(() => {
        const registrations = JSON.parse(localStorage.getItem('eventRegistrations') || '[]');
        const updatedEvents = events.map(event => ({
          ...event,
          "registered": registrations.filter(reg => reg["eventId"] === event["id"]).length
        }));
        // Note: This is just for display, the actual events array is static
      }, [eventRegistrations]);

      const handleRegister = (event) => {
        if (!session) {
          alert('برای ثبت‌نام در رویدادها ابتدا وارد سیستم شوید');
          window.location.hash = 'login';
          return;
        }
        setSelectedEvent(event);
        setShowRegistrationForm(true);
      };

      const submitRegistration = () => {
        if (!selectedEvent) return;

        const registration = {
          "id": `reg-${Date.now()}`,
          "eventId": selectedEvent["id"],
          "userId": session["userId"],
          "userName": registrationForm["name"],
          "userEmail": registrationForm["email"],
          "userRole": registrationForm["role"],
          "organization": registrationForm["organization"],
          "expectations": registrationForm["expectations"],
          "registeredAt": new Date().toISOString(),
          "eventTitle": selectedEvent["title"],
          "eventDate": selectedEvent["date"],
          "eventTime": selectedEvent["time"]
        };

        const registrations = JSON.parse(localStorage.getItem('eventRegistrations') || '[]');
        registrations.push(registration);
        localStorage.setItem('eventRegistrations', JSON.stringify(registrations));

        setEventRegistrations(registrations);
        setShowRegistrationForm(false);
        setSelectedEvent(null);

        alert('ثبت‌نام شما با موفقیت انجام شد!');
      };

      const isUserRegistered = (eventId) => {
        if (!session) return false;
        return eventRegistrations.some(reg =>
          reg["eventId"] === eventId && reg["userId"] === session["userId"]
        );
      };

      const getTrackColor = (track) => {
        const colors = {
          "Workshop": "bg-blue-100 text-blue-800",
          "Keynote": "bg-purple-100 text-purple-800",
          "Live Challenge": "bg-green-100 text-green-800",
          "Networking": "bg-orange-100 text-orange-800",
          "Awards": "bg-yellow-100 text-yellow-800"
        };
        return colors[track] || "bg-gray-100 text-gray-800";
      };

      if (loading) {
        return <PageLoader message="در حال بارگذاری رویدادها..." />;
      }

      return (
        <div className="space-y-6">
          <header className="text-center py-6">
            <h1 className="text-2xl font-bold text-gray-900 mb-2">رویدادهای TESTA</h1>
            <p className="text-gray-600">ثبت‌نام در کارگاه‌ها، سخنرانی‌ها و چالش‌های زنده</p>
          </header>

          {/* Events Grid */}
          <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
            {events.map(event => {
              const isRegistered = isUserRegistered(event.id);
              const isFull = event.registered >= event.capacity;

              return (
                <div key={event.id} className="bg-white rounded-xl shadow hover:shadow-lg transition-shadow p-6">
                  <div className="flex items-start justify-between mb-4">
                    <div className="flex-1">
                      <h3 className="text-lg font-semibold text-gray-900 mb-2">
                        {event.title}
                      </h3>
                      <div className="flex items-center gap-2 mb-2">
                        <span className={`px-2 py-1 text-xs rounded-full ${getTrackColor(event.track)}`}>
                          {event.track}
                        </span>
                        <span className="text-sm text-gray-600">
                          👥 {event.registered}/{event.capacity}
                        </span>
                      </div>
                    </div>
                    <div className="text-left text-sm text-gray-600">
                      <div>{event.date}</div>
                      <div>{event.time}</div>
                    </div>
                  </div>

                  <p className="text-gray-700 text-sm mb-4 line-clamp-3">
                    {event.description}
                  </p>

                  <div className="space-y-2 text-sm text-gray-600 mb-4">
                    <div>🎤 {event.speaker}</div>
                    <div>📍 {event.location}</div>
                    <div>📋 {event.requirements}</div>
                  </div>

                  {/* QR Code for Event */}
                  <div className="mb-4 flex justify-center">
                    <QRCodeGenerator
                      text={`${window.location.origin}/testa-events#register-${event.id}`}
                      size={80}
                      className="mb-2"
                    />
                  </div>

                  <button
                    onClick={() => handleRegister(event)}
                    disabled={isRegistered || isFull}
                    className={`w-full px-4 py-2 text-sm font-medium rounded-lg transition-colors ${
                      isRegistered
                        ? 'bg-green-100 text-green-800 cursor-not-allowed'
                        : isFull
                        ? 'bg-red-100 text-red-800 cursor-not-allowed'
                        : 'bg-blue-600 text-white hover:bg-blue-700'
                    }`}
                  >
                    {isRegistered ? '✅ ثبت‌نام شده' : isFull ? '🏁 ظرفیت تکمیل' : '📝 ثبت‌نام'}
                  </button>
                </div>
              );
            })}
          </div>

          {/* Registration Form Modal */}
          {showRegistrationForm && selectedEvent && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
              <div className="bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                <div className="p-6">
                  <div className="flex justify-between items-center mb-6">
                    <div>
                      <h2 className="text-2xl font-bold text-gray-900">ثبت‌نام در رویداد</h2>
                      <p className="text-gray-600 mt-1">{selectedEvent.title}</p>
                    </div>
                    <button
                      onClick={() => setShowRegistrationForm(false)}
                      className="text-gray-400 hover:text-gray-600 text-2xl"
                    >
                      ✕
                    </button>
                  </div>

                  <div className="space-y-4">
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">
                        نام و نام خانوادگی *
                      </label>
                      <input
                        type="text"
                        value={registrationForm.name}
                        onChange={(e) => setRegistrationForm(prev => ({ ...prev, name: e.target.value }))}
                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        required
                      />
                    </div>

                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">
                        ایمیل *
                      </label>
                      <input
                        type="email"
                        value={registrationForm.email}
                        onChange={(e) => setRegistrationForm(prev => ({ ...prev, email: e.target.value }))}
                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        required
                      />
                    </div>

                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">
                        نقش شما
                      </label>
                      <select
                        value={registrationForm.role}
                        onChange={(e) => setRegistrationForm(prev => ({ ...prev, role: e.target.value }))}
                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                      >
                        <option value="SOLVER">حل‌کننده (نوآور)</option>
                        <option value="SEEKER">جستجوگر (کارفرما)</option>
                        <option value="ADMIN">مدیر</option>
                        <option value="VISITOR">بازدیدکننده</option>
                      </select>
                    </div>

                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">
                        سازمان (اختیاری)
                      </label>
                      <input
                        type="text"
                        value={registrationForm.organization}
                        onChange={(e) => setRegistrationForm(prev => ({ ...prev, organization: e.target.value }))}
                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        placeholder="نام سازمان یا شرکت"
                      />
                    </div>

                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">
                        انتظارات شما از این رویداد
                      </label>
                      <textarea
                        value={registrationForm.expectations}
                        onChange={(e) => setRegistrationForm(prev => ({ ...prev, expectations: e.target.value }))}
                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        rows="3"
                        placeholder="چه انتظاری از این رویداد دارید؟"
                      />
                    </div>
                  </div>

                  <div className="flex gap-4 mt-6">
                    <button
                      onClick={submitRegistration}
                      disabled={!registrationForm.name || !registrationForm.email}
                      className="flex-1 px-6 py-3 bg-green-600 text-white text-lg font-semibold rounded-lg hover:bg-green-700 focus:ring-2 focus:ring-green-500 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
                    >
                      ✅ ثبت‌نام نهایی
                    </button>
                    <button
                      onClick={() => setShowRegistrationForm(false)}
                      className="px-6 py-3 bg-gray-600 text-white text-lg font-semibold rounded-lg hover:bg-gray-700 focus:ring-2 focus:ring-gray-500 transition-colors"
                    >
                      انصراف
                    </button>
                  </div>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    }

    // TESTA Map & Booths Page
    function TESTABoothsPage() {
      const exhibitors = [
        {
          "id": "ex-1",
          "name": "پارس‌تک",
          "boothCode": "A12",
          "category": "Energy",
          "description": "نمایشگر راه‌حل‌های انرژی هوشمند با تمرکز بر IoT صنعتی",
          "logo": null,
          "website": "https://parstech.ir",
          "contactInfo": {
            "phone": "+98-21-12345678",
            "email": "info@parstech.ir"
          },
          "products": ["سنسورهای هوشمند انرژی", "پلتفرم مانیتورینگ IoT", "راه‌حل‌های بهینه‌سازی مصرف"]
        },
        {
          "id": "ex-2",
          "name": "شرکت انرژی سبز",
          "boothCode": "B08",
          "category": "Energy",
          "description": "توسعه‌دهنده راه‌حل‌های انرژی پاک و تجدیدپذیر",
          "logo": null,
          "website": "https://greenenergy.ir",
          "contactInfo": {
            "phone": "+98-31-87654321",
            "email": "info@greenenergy.ir"
          },
          "products": ["پنل‌های خورشیدی هوشمند", "سیستم‌های ذخیره انرژی", "راه‌حل‌های ترکیبی انرژی"]
        },
        {
          "id": "ex-3",
          "name": "تک‌نو",
          "boothCode": "C15",
          "category": "IoT",
          "description": "پلتفرم‌های IoT و هوش مصنوعی برای صنعت ۴.۰",
          "logo": null,
          "website": "https://techno.ir",
          "contactInfo": {
            "phone": "+98-51-11223344",
            "email": "info@techno.ir"
          },
          "products": ["پلتفرم IoT ابری", "راه‌حل‌های هوش مصنوعی صنعتی", "سنسورهای هوشمند صنعتی"]
        },
        {
          "id": "ex-4",
          "name": "نوآوران دیجیتال",
          "boothCode": "D05",
          "category": "AI",
          "description": "راه‌حل‌های هوش مصنوعی برای کسب‌وکارها",
          "logo": null,
          "website": "https://digitalinnovators.ir",
          "contactInfo": {
            "phone": "+98-26-33445566",
            "email": "contact@digitalinnovators.ir"
          },
          "products": ["پلتفرم‌های یادگیری ماشین", "راه‌حل‌های پردازش تصویر", "چت‌بات‌های هوشمند"]
        },
        {
          "id": "ex-5",
          "name": "رباتیک پیشرفته",
          "boothCode": "E20",
          "category": "Robotics",
          "description": "طراحی و ساخت ربات‌های صنعتی و خدماتی",
          "logo": null,
          "website": "https://advancedrobotics.ir",
          "contactInfo": {
            "phone": "+98-41-55667788",
            "email": "info@advancedrobotics.ir"
          },
          "products": ["ربات‌های صنعتی", "سیستم‌های اتوماسیون", "ربات‌های خدماتی"]
        },
        {
          "id": "ex-6",
          "name": "فین‌تک نوین",
          "boothCode": "F10",
          "category": "FinTech",
          "description": "راه‌حل‌های فناوری مالی و بلاک‌چین",
          "logo": null,
          "website": "https://fintech.ir",
          "contactInfo": {
            "phone": "+98-11-77889900",
            "email": "contact@fintech.ir"
          },
          "products": ["پلتفرم‌های پرداخت دیجیتال", "راه‌حل‌های بلاک‌چین", "سیستم‌های کیف پول الکترونیک"]
        }
      ];

      const [selectedExhibitor, setSelectedExhibitor] = React.useState(null);
      const [searchTerm, setSearchTerm] = React.useState('');
      const [selectedCategory, setSelectedCategory] = React.useState('All');

      const categories = ["All", "Energy", "IoT", "AI", "Robotics", "FinTech"];

      const filteredExhibitors = exhibitors.filter(exhibitor => {
        const matchesSearch = !searchTerm ||
          exhibitor["name"].toLowerCase().includes(searchTerm.toLowerCase()) ||
          exhibitor["description"].toLowerCase().includes(searchTerm.toLowerCase()) ||
          exhibitor["products"].some(product => product.toLowerCase().includes(searchTerm.toLowerCase()));

        const matchesCategory = !selectedCategory || selectedCategory === 'All' || exhibitor["category"] === selectedCategory;

        return matchesSearch && matchesCategory;
      });

      const getCategoryColor = (category) => {
        const colors = {
          "Energy": "bg-green-100 text-green-800",
          "IoT": "bg-blue-100 text-blue-800",
          "AI": "bg-purple-100 text-purple-800",
          "Robotics": "bg-orange-100 text-orange-800",
          "FinTech": "bg-red-100 text-red-800"
        };
        return colors[category] || "bg-gray-100 text-gray-800";
      };

      return (
        <div className="space-y-6">
          <header className="text-center py-6">
            <h1 className="text-2xl font-bold text-gray-900 mb-2">نمایشگاه‌ها و غرفه‌ها</h1>
            <p className="text-gray-600">گپ زدن با شرکت‌های حاضر در TESTA</p>
          </header>

          {/* Map Section */}
          <div className="bg-white rounded-xl shadow p-6">
            <h2 className="text-xl font-semibold mb-4 flex items-center">
              <span className="ml-2">🗺️</span>
              نقشه نمایشگاه
            </h2>
            <div className="bg-gray-100 rounded-lg p-8 text-center">
              <div className="text-6xl mb-4">🏢</div>
              <p className="text-gray-600 mb-4">
                نقشه تعاملی نمایشگاه TESTA به زودی اضافه خواهد شد
              </p>
              <div className="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                <div className="bg-blue-50 p-3 rounded">
                  <div className="font-medium text-blue-900">سالن A</div>
                  <div className="text-blue-700">انرژی و IoT</div>
                </div>
                <div className="bg-purple-50 p-3 rounded">
                  <div className="font-medium text-purple-900">سالن B</div>
                  <div className="text-purple-700">هوش مصنوعی</div>
                </div>
                <div className="bg-green-50 p-3 rounded">
                  <div className="font-medium text-green-900">سالن C</div>
                  <div className="text-green-700">رباتیک</div>
                </div>
                <div className="bg-orange-50 p-3 rounded">
                  <div className="font-medium text-orange-900">سالن D</div>
                  <div className="text-orange-700">فین‌تک</div>
                </div>
              </div>
            </div>
          </div>

          {/* Filters */}
          <div className="bg-white rounded-xl shadow p-6">
            <div className="grid md:grid-cols-2 gap-4 mb-6">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  جستجو
                </label>
                <input
                  type="text"
                  value={searchTerm}
                  onChange={(e) => setSearchTerm(e.target.value)}
                  className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                  placeholder="جستجو در نام شرکت، محصولات..."
                />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  دسته‌بندی
                </label>
                <select
                  value={selectedCategory}
                  onChange={(e) => setSelectedCategory(e.target.value)}
                  className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                >
                  {categories.map(cat => (
                    <option key={cat} value={cat === 'All' ? '' : cat}>
                      {cat === 'All' ? 'همه دسته‌بندی‌ها' : cat}
                    </option>
                  ))}
                </select>
              </div>
            </div>

            {/* Exhibitors Grid */}
            <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
              {filteredExhibitors.map(exhibitor => (
                <div
                  key={exhibitor.id}
                  className="border border-gray-200 rounded-lg p-6 hover:shadow-md transition-shadow cursor-pointer"
                  onClick={() => setSelectedExhibitor(exhibitor)}
                >
                  <div className="flex items-start justify-between mb-4">
                    <div className="flex-1">
                      <h3 className="text-lg font-semibold text-gray-900 mb-2">
                        {exhibitor.name}
                      </h3>
                      <div className="flex items-center gap-2 mb-2">
                        <span className={`px-2 py-1 text-xs rounded-full ${getCategoryColor(exhibitor.category)}`}>
                          {exhibitor.category}
                        </span>
                        <span className="px-2 py-1 bg-gray-100 text-gray-800 text-xs rounded-full">
                          {exhibitor.boothCode}
                        </span>
                      </div>
                    </div>
                    <div className="text-2xl">🏢</div>
                  </div>

                  <p className="text-gray-700 text-sm mb-4 line-clamp-2">
                    {exhibitor.description}
                  </p>

                  <div className="space-y-1 text-sm text-gray-600 mb-4">
                    <div>📧 {exhibitor.contactInfo.email}</div>
                    <div>📞 {exhibitor.contactInfo.phone}</div>
                  </div>

                  {/* QR Code for Booth */}
                  <div className="mb-4 flex justify-center">
                    <QRCodeGenerator
                      text={`${window.location.origin}/testa-booths#booth-${exhibitor.id}`}
                      size={70}
                      className="mb-1"
                    />
                  </div>

                  <div className="text-blue-600 hover:text-blue-800 text-sm">
                    مشاهده جزئیات ←
                  </div>
                </div>
              ))}
            </div>

            {filteredExhibitors.length === 0 && (
              <div className="text-center py-12">
                <div className="text-4xl mb-4">🔍</div>
                <p className="text-gray-500">هیچ غرفه‌ای یافت نشد</p>
                <p className="text-sm text-gray-400 mt-2">
                  فیلترها را تغییر دهید یا عبارت جستجو را اصلاح کنید
                </p>
              </div>
            )}
          </div>

          {/* Exhibitor Details Modal */}
          {selectedExhibitor && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
              <div className="bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                <div className="p-6">
                  <div className="flex justify-between items-center mb-6">
                    <div>
                      <h2 className="text-2xl font-bold text-gray-900">{selectedExhibitor.name}</h2>
                      <p className="text-gray-600 mt-1">غرفه {selectedExhibitor.boothCode}</p>
                    </div>
                    <button
                      onClick={() => setSelectedExhibitor(null)}
                      className="text-gray-400 hover:text-gray-600 text-2xl"
                    >
                      ✕
                    </button>
                  </div>

                  <div className="grid md:grid-cols-2 gap-8">
                    <div>
                      <h3 className="text-lg font-semibold mb-4">درباره شرکت</h3>
                      <p className="text-gray-700 mb-6">
                        {selectedExhibitor.description}
                      </p>

                      <div className="space-y-3">
                        <div>
                          <h4 className="font-medium text-gray-900 mb-2">اطلاعات تماس</h4>
                          <div className="space-y-1 text-sm text-gray-600">
                            <div>📧 {selectedExhibitor.contactInfo.email}</div>
                            <div>📞 {selectedExhibitor.contactInfo.phone}</div>
                            {selectedExhibitor.website && (
                              <div>🌐 <a href={selectedExhibitor.website} className="text-blue-600 hover:underline" target="_blank">
                                وب‌سایت شرکت
                              </a></div>
                            )}
                          </div>
                        </div>
                      </div>
                    </div>

                    <div>
                      <h3 className="text-lg font-semibold mb-4">محصولات و خدمات</h3>
                      <div className="space-y-3">
                        {selectedExhibitor.products.map((product, index) => (
                          <div key={index} className="flex items-center gap-3 p-3 bg-gray-50 rounded-lg">
                            <div className="text-blue-600">🔹</div>
                            <div className="text-gray-700">{product}</div>
                          </div>
                        ))}
                      </div>
                    </div>
                  </div>

                  <div className="mt-8 pt-6 border-t flex gap-4">
                    {selectedExhibitor.website && (
                      <a
                        href={selectedExhibitor.website}
                        target="_blank"
                        className="flex-1 px-6 py-3 bg-blue-600 text-white text-center rounded-lg hover:bg-blue-700 transition-colors"
                      >
                        🌐 بازدید از وب‌سایت
                      </a>
                    )}
                    <button
                      onClick={() => setSelectedExhibitor(null)}
                      className="px-6 py-3 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors"
                    >
                      بستن
                    </button>
                  </div>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    }

    function SubmissionsTable({ session, submissions, challenges, users, onStatusUpdate }) {
      const [scoringSubmission, setScoringSubmission] = React.useState(null);
      const [showComparison, setShowComparison] = React.useState(false);
      const [toasts, setToasts] = React.useState([]);
      const [selectedSubmission, setSelectedSubmission] = React.useState(null);

      const orgSubmissions = submissions.filter(sub => {
        const challenge = challenges.find(c => c["id"] === sub["challengeId"]);
        return challenge && challenge["orgId"] === session["orgId"];
      });

      const statusOptions = [
        { "value": 'received', "label": 'دریافت شده', "color": 'bg-blue-100 text-blue-800' },
        { "value": 'under_review', "label": 'در حال بررسی', "color": 'bg-yellow-100 text-yellow-800' },
        { "value": 'needs_revision', "label": 'نیاز به بازنگری', "color": 'bg-orange-100 text-orange-800' },
        { "value": 'accepted', "label": 'پذیرفته شده', "color": 'bg-green-100 text-green-800' },
        { "value": 'rejected', "label": 'رد شده', "color": 'bg-red-100 text-red-800' }
      ];

      // Toast management
      const addToast = (type, message) => {
        const toast = {
          "id": Date.now(),
          "type": type,
          "message": message
        };
        setToasts(prev => [...prev, toast]);
        setTimeout(() => removeToast(toast.id), 5000);
      };

      const removeToast = (id) => {
        setToasts(prev => prev.filter(toast => toast["id"] !== id));
      };

      const handleScoreUpdate = (updatedSubmission) => {
        const updatedSubmissions = submissions.map(sub =>
          sub["id"] === updatedSubmission["id"] ? updatedSubmission : sub
        );
        storage.set(KEYS.submissions, updatedSubmissions);
        onStatusUpdate(updatedSubmissions);
        addToast('success', 'نمرات با موفقیت ذخیره شد!');
      };

      const handleSelectWinner = (winnerSubmission) => {
        const updatedSubmissions = submissions.map(sub => {
          if (sub["id"] === winnerSubmission["id"]) {
            return { ...sub, "status": 'accepted', "winner": true };
          } else if (sub["challengeId"] === winnerSubmission["challengeId"] && sub["status"] === 'under_review') {
            return { ...sub, "status": 'rejected' };
          }
          return sub;
        });

        storage.set(KEYS.submissions, updatedSubmissions);
        onStatusUpdate(updatedSubmissions);

        // Update reputation for winner
        const winner = users.find(u => u.id === winnerSubmission.userId);
        updateReputation(winnerSubmission.userId, 20, 'accepted_submission');
        updateReputation(winnerSubmission.userId, 5, 'profile_completion'); // Bonus for completing profile
        updateReputation(winnerSubmission.userId, 2, 'on_time_submission'); // Bonus for on-time submission

        // Create notification for winner
        const notifications = storage.get(KEYS.notifications, []);
        notifications.push({
          id: `notif-${Date.now()}`,
          type: 'winner_announcement',
          text: `🎉 تبریک! پیشنهاد شما برای چالش "${challenges.find(c => c.id === winnerSubmission.challengeId)?.title}" به عنوان برنده انتخاب شد!`,
          createdAt: new Date().toISOString(),
          userId: winnerSubmission.userId,
          targetId: winnerSubmission.id,
          read: false
        });
        storage.set(KEYS.notifications, notifications);

        addToast('success', `🏆 برنده انتخاب شد: ${winner?.name || 'ناشناس'} - امتیاز: +27`);
      };

      const handleStatusChange = (submissionId, newStatus) => {
        const updatedSubmissions = submissions.map(sub =>
          sub.id === submissionId
            ? { ...sub, status: newStatus, updatedAt: new Date().toISOString() }
            : sub
        );
        storage.set(KEYS.submissions, updatedSubmissions);
        onStatusUpdate(updatedSubmissions);

        // Create notification for the solver
        const submission = updatedSubmissions.find(sub => sub.id === submissionId);
        const solver = users.find(u => u.id === submission.userId);

        const notifications = storage.get(KEYS.notifications, []);
        const notification = {
          id: `notif-${Date.now()}`,
          type: 'submission_status_update',
          text: `وضعیت پیشنهاد شما برای چالش "${challenges.find(c => c.id === submission.challengeId)?.title}" به "${statusOptions.find(s => s.value === newStatus)?.label}" تغییر یافت.`,
          createdAt: new Date().toISOString(),
          userId: solver.id,
          targetId: submission.id,
          read: false
        };
        notifications.push(notification);
        storage.set(KEYS.notifications, notifications);

        addToast('success', 'وضعیت پیشنهاد به‌روزرسانی شد');
      };

      const getStatusBadge = (status) => {
        const statusOption = statusOptions.find(s => s.value === status);
        return statusOption ? statusOption : { label: status, color: 'bg-gray-100 text-gray-800' };
      };

      return (
        <div className="space-y-6">
          {/* Toast Notifications */}
          <ToastContainer toasts={toasts} onRemoveToast={removeToast} />

          <header className="text-center py-6">
            <h1 className="text-2xl font-bold text-gray-900 mb-2">مدیریت پیشنهادات</h1>
            <p className="text-gray-600">بررسی و مدیریت پیشنهادات دریافت شده</p>
          </header>

          <div className="bg-white rounded-xl shadow p-6">
            <div className="flex items-center justify-between mb-6">
              <h2 className="text-lg font-semibold">پیشنهادات دریافت شده</h2>
              <div className="flex items-center gap-4">
                <div className="text-sm text-gray-600">
                  مجموع: {orgSubmissions.length} پیشنهاد
                </div>
                {orgSubmissions.filter(s => s.scores?.total).length >= 2 && (
                  <button
                    onClick={() => setShowComparison(true)}
                    className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center gap-2"
                  >
                    <span>⚖️</span>
                    مقایسه پیشنهادات
                  </button>
                )}
              </div>
            </div>

            {orgSubmissions.length > 0 ? (
              <div className="overflow-x-auto">
                <table className="w-full text-sm">
                  <thead className="bg-gray-50">
                    <tr>
                      <th className="px-4 py-3 text-right font-medium text-gray-700">پیشنهاد‌دهنده</th>
                      <th className="px-4 py-3 text-right font-medium text-gray-700">چالش</th>
                      <th className="px-4 py-3 text-right font-medium text-gray-700">خلاصه</th>
                      <th className="px-4 py-3 text-right font-medium text-gray-700">نمره</th>
                      <th className="px-4 py-3 text-right font-medium text-gray-700">تاریخ ارسال</th>
                      <th className="px-4 py-3 text-right font-medium text-gray-700">وضعیت</th>
                      <th className="px-4 py-3 text-right font-medium text-gray-700">اقدامات</th>
                    </tr>
                  </thead>
                  <tbody className="divide-y divide-gray-200">
                    {orgSubmissions.map(submission => {
                      const challenge = challenges.find(c => c.id === submission.challengeId);
                      const solver = users.find(u => u.id === submission.userId);
                      const statusBadge = getStatusBadge(submission.status);

                      return (
                        <tr key={submission.id} className="hover:bg-gray-50">
                          <td className="px-4 py-3">
                            <div>
                              <p className="font-medium text-gray-900">{solver?.name || 'ناشناس'}</p>
                              <p className="text-gray-500 text-xs">{solver?.email}</p>
                            </div>
                          </td>
                          <td className="px-4 py-3">
                            <p className="font-medium text-gray-900">{challenge?.title || 'چالش نامشخص'}</p>
                          </td>
                          <td className="px-4 py-3">
                            <p className="text-gray-700 text-sm line-clamp-2 max-w-xs">
                              {submission.data.summary}
                            </p>
                          </td>
                          <td className="px-4 py-3">
                            {submission.scores?.total ? (
                              <div className="text-center">
                                <div className="text-lg font-bold text-green-600">
                                  {submission.scores.total}/10
                                </div>
                                <button
                                  onClick={() => setScoringSubmission(submission)}
                                  className="text-xs text-blue-600 hover:underline"
                                >
                                  ویرایش نمره
                                </button>
                              </div>
                            ) : (
                              <button
                                onClick={() => setScoringSubmission(submission)}
                                className="px-3 py-1 bg-green-600 text-white text-sm rounded hover:bg-green-700 transition-colors"
                              >
                                نمره‌دهی
                              </button>
                            )}
                          </td>
                          <td className="px-4 py-3 text-gray-600">
                            {new Date(submission.createdAt).toLocaleDateString('fa-IR')}
                          </td>
                          <td className="px-4 py-3">
                            <span className={`px-2 py-1 text-xs rounded-full ${statusBadge.color}`}>
                              {statusBadge.label}
                            </span>
                            {submission.winner && (
                              <span className="ml-2 px-2 py-1 text-xs rounded-full bg-yellow-100 text-yellow-800">
                                🏆 برنده
                              </span>
                            )}
                          </td>
                          <td className="px-4 py-3">
                            <div className="flex gap-2">
                              <select
                                value={submission.status}
                                onChange={(e) => handleStatusChange(submission.id, e.target.value)}
                                className="px-2 py-1 text-xs border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                              >
                                {statusOptions.map(option => (
                                  <option key={option.value} value={option.value}>
                                    {option.label}
                                  </option>
                                ))}
                              </select>
                              <button
                                onClick={() => {
                                  setSelectedSubmission(submission);
                                  window.location.hash = 'message-thread';
                                }}
                                className="px-2 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700 transition-colors"
                                title="پیام‌ها"
                              >
                                💬
                              </button>
                            </div>
                          </td>
                        </tr>
                      );
                    })}
                  </tbody>
                </table>
              </div>
            ) : (
              <div className="text-center py-12">
                <div className="text-4xl mb-4">📋</div>
                <p className="text-gray-500">هنوز پیشنهادی دریافت نشده است</p>
              </div>
            )}
          </div>

          {/* Scoring Modal */}
          {scoringSubmission && (
            <SubmissionScoring
              submission={scoringSubmission}
              challenge={challenges.find(c => c.id === scoringSubmission.challengeId)}
              onScoreUpdate={handleScoreUpdate}
              onClose={() => setScoringSubmission(null)}
            />
          )}

          {/* Comparison Modal */}
          {showComparison && (
            <SubmissionsComparison
              submissions={orgSubmissions}
              challenge={challenges.find(c => c.id === orgSubmissions[0]?.challengeId)}
              onSelectWinner={handleSelectWinner}
              onClose={() => setShowComparison(false)}
            />
          )}
        </div>
      );
    }

    function MySubmissionsPage({ session, submissions, challenges, orgs }) {
      const [selectedSubmission, setSelectedSubmission] = React.useState(null);
      const userSubmissions = submissions.filter(s => s.userId === session?.userId);

      const statusOptions = [
        { value: 'received', label: 'دریافت شده', color: 'bg-blue-100 text-blue-800', icon: '📬' },
        { value: 'under_review', label: 'در حال بررسی', color: 'bg-yellow-100 text-yellow-800', icon: '🔍' },
        { value: 'needs_revision', label: 'نیاز به بازنگری', color: 'bg-orange-100 text-orange-800', icon: '✏️' },
        { value: 'accepted', label: 'پذیرفته شده', color: 'bg-green-100 text-green-800', icon: '✅' },
        { value: 'rejected', label: 'رد شده', color: 'bg-red-100 text-red-800', icon: '❌' }
      ];

      const getStatusInfo = (status) => {
        return statusOptions.find(s => s.value === status) || statusOptions[0];
      };

      const getStatusDescription = (status) => {
        switch (status) {
          case 'received': return 'پیشنهاد شما دریافت شده و به زودی بررسی خواهد شد.';
          case 'under_review': return 'پیشنهاد شما در حال بررسی توسط تیم است.';
          case 'needs_revision': return 'پیشنهاد شما نیاز به بازنگری دارد. لطفاً پیشنهاد خود را بهبود بخشید.';
          case 'accepted': return 'پیشنهاد شما پذیرفته شده است! تبریک می‌گوییم.';
          case 'rejected': return 'متاسفانه پیشنهاد شما در این مرحله پذیرفته نشد.';
          default: return 'وضعیت نامشخص';
        }
      };

      return (
        <div className="space-y-6">
          <header className="text-center py-6">
            <h1 className="text-2xl font-bold text-gray-900 mb-2">پیشنهادات من</h1>
            <p className="text-gray-600">پیگیری وضعیت پیشنهادات ارسال شده</p>
          </header>

          <div className="grid md:grid-cols-3 gap-6 mb-6">
            {statusOptions.map(status => {
              const count = userSubmissions.filter(s => s.status === status.value).length;
              return (
                <div key={status.value} className="bg-white rounded-lg shadow p-4">
                  <div className="flex items-center gap-3">
                    <span className="text-2xl">{status.icon}</span>
                    <div>
                      <p className="font-medium text-gray-900">{status.label}</p>
                      <p className="text-2xl font-bold text-gray-700">{count}</p>
                    </div>
                  </div>
                </div>
              );
            })}
          </div>

          <div className="bg-white rounded-xl shadow p-6">
            <h2 className="text-lg font-semibold mb-4">📋 پیشنهادات شما</h2>
            {userSubmissions.length > 0 ? (
              <div className="space-y-4">
                {userSubmissions.map(submission => {
                  const challenge = challenges.find(c => c.id === submission.challengeId);
                  const org = orgs.find(o => o.id === challenge?.orgId);
                  const statusInfo = getStatusInfo(submission.status);

                  return (
                    <div key={submission.id} className="border border-gray-200 rounded-lg p-6 hover:shadow-md transition-shadow">
                                              <div className="flex items-start justify-between mb-4">
                          <div className="flex-1">
                            <h3 className="text-lg font-semibold text-gray-900 mb-2">
                              {challenge?.title || 'چالش نامشخص'}
                            </h3>
                            <p className="text-gray-600 mb-2">{org?.name || 'سازمان نامشخص'}</p>
                            <p className="text-gray-700">{submission.data.summary}</p>
                          </div>
                          <div className="text-left">
                            <div className="flex flex-col items-end gap-2">
                              <span className={`inline-flex items-center gap-2 px-3 py-1 text-sm rounded-full ${statusInfo.color}`}>
                                <span>{statusInfo.icon}</span>
                                {statusInfo.label}
                              </span>
                              {submission.winner && (
                                <span className="inline-flex items-center gap-2 px-3 py-1 text-sm rounded-full bg-yellow-100 text-yellow-800">
                                  <span>🏆</span>
                                  برنده چالش
                                </span>
                              )}
                            </div>
                          </div>
                        </div>

                      <div className="bg-gray-50 rounded-lg p-4 mb-4">
                        <p className="text-gray-700 text-sm">{getStatusDescription(submission.status)}</p>
                      </div>

                      <div className="flex items-center justify-between text-sm text-gray-500">
                        <div className="flex items-center gap-4">
                          <span>📅 ارسال: {new Date(submission.createdAt).toLocaleDateString('fa-IR')}</span>
                          {submission.ndaAcceptedAt && (
                            <span>🔒 NDA: {new Date(submission.ndaAcceptedAt).toLocaleDateString('fa-IR')}</span>
                          )}
                        </div>
                        <div className="flex items-center gap-4">
                          {submission.data.files?.length > 0 && (
                            <span>📎 فایل‌ها: {submission.data.files.length}</span>
                          )}
                          {submission.data.video && (
                            <span>🎥 ویدیو</span>
                          )}
                        </div>
                      </div>

                      {/* Show proposal details if status allows */}
                      {(submission.status === 'needs_revision' || submission.status === 'accepted') && (
                        <div className="mt-4 pt-4 border-t border-gray-200">
                          <h4 className="font-medium text-gray-900 mb-2">جزئیات پیشنهاد:</h4>
                          <p className="text-gray-700 text-sm bg-gray-50 p-3 rounded">
                            {submission.data.proposal}
                          </p>
                        </div>
                      )}

                      {/* Action buttons based on status */}
                      <div className="mt-4 pt-4 border-t border-gray-200 flex gap-2">
                        <button
                          onClick={() => {
                            setSelectedSubmission(submission);
                            window.location.hash = 'message-thread';
                          }}
                          className="px-4 py-2 bg-green-600 text-white text-sm rounded-lg hover:bg-green-700 transition-colors flex items-center gap-1"
                        >
                          <span>💬</span>
                          پیام‌ها
                        </button>
                        {submission.status === 'needs_revision' && (
                          <button
                            onClick={() => alert('ارسال نسخه بازنگری شده در مرحله بعدی پیاده‌سازی خواهد شد')}
                            className="px-4 py-2 bg-blue-600 text-white text-sm rounded-lg hover:bg-blue-700 transition-colors"
                          >
                            📤 ارسال نسخه جدید
                          </button>
                        )}
                      </div>
                    </div>
                  );
                })}
              </div>
            ) : (
              <div className="text-center py-12">
                <div className="text-4xl mb-4">📝</div>
                <p className="text-gray-500 mb-4">هنوز پیشنهادی ارسال نکرده‌اید.</p>
                <button
                  onClick={() => window.location.hash = 'challenges'}
                  className="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
                >
                  مشاهده چالش‌ها
                </button>
              </div>
            )}
          </div>
        </div>
      );
    }

    function ProfilePage({ user, org }) {
      if (!user) {
        return (
          <div className="text-center py-12">
            <div className="text-4xl mb-4">👤</div>
            <p className="text-gray-500">کاربر یافت نشد</p>
          </div>
        );
      }

      // Show different profiles based on user role
      if (user.role === 'SEEKER' && org) {
        return <SeekerProfile user={user} org={org} />;
      } else if (user.role === 'SOLVER') {
        return <SolverProfile user={user} />;
      } else {
        return (
          <div className="text-center py-12">
            <div className="text-4xl mb-4">⚠️</div>
            <p className="text-gray-500">پروفایل برای این نوع کاربر تعریف نشده</p>
          </div>
        );
      }
    }

    // =========================
    // --- APP (Stage 2.2) -----
    // =========================
    function App() {
      // Seed once on first render
      React.useEffect(() => {
        console.log('App component mounted, checking seeding...');
        seedDataOnce();

        // Also check if users exist and seed if needed
        setTimeout(() => {
          const users = storage.get(KEYS.users, []);
          console.log('Users check after mount:', users.length);
          if (users.length === 0) {
            console.log('No users found, forcing reseed...');
            localStorage.removeItem('seeded');
            seedDataOnce();
          }
        }, 100);

        // Set up global keyboard shortcuts
        const handleGlobalKeyboard = (e) => {
          // Alt+1 to focus main navigation
          if (e.altKey && e.key === '1') {
            e.preventDefault();
            const nav = document.querySelector('nav');
            focusManager.focusFirst(nav);
          }
          
          // Alt+2 to focus main content
          if (e.altKey && e.key === '2') {
            e.preventDefault();
            const main = document.querySelector('main, [role="main"]');
            focusManager.focusFirst(main);
          }
          
          // Escape to close any open modals
          if (e.key === 'Escape') {
            const modal = document.querySelector('[role="dialog"]:not([hidden])');
            if (modal) {
              const closeButton = modal.querySelector('[aria-label*="بستن"], [aria-label*="close"]');
              closeButton?.click();
            }
          }
        };

        document.addEventListener('keydown', handleGlobalKeyboard);
        return () => document.removeEventListener('keydown', handleGlobalKeyboard);
      }, []);

      // Router setup
      const [currentRoute, navigate] = useHashRouter('home');

      // Data state
      const [session, setSession] = useLocalStorage(KEYS.session, null);
      const [users] = useLocalStorage(KEYS.users, []);
      const [orgs] = useLocalStorage(KEYS.orgs, []);
      const [challenges, setChallenges] = useLocalStorage(KEYS.challenges, []);
      const [submissions, setSubmissions] = useLocalStorage(KEYS.submissions, []);
      const [events] = useLocalStorage(KEYS.events, []);
      const [exhibitors] = useLocalStorage(KEYS.exhibitors, []);

      // Challenge management state
      const [selectedChallenge, setSelectedChallenge] = React.useState(null);
      const [editingChallenge, setEditingChallenge] = React.useState(null);
      const [showChallengeForm, setShowChallengeForm] = React.useState(false);
      const [creatingSubmission, setCreatingSubmission] = React.useState(null);
      const [selectedSubmission, setSelectedSubmission] = React.useState(null);

      // Kiosk mode
      const kioskMode = useKioskMode();

      // Enhanced keyboard navigation and accessibility
      React.useEffect(() => {
        const handleKeyDown = (event) => {
          // Ctrl/Cmd + K for search (global shortcut)
          if ((event.ctrlKey || event.metaKey) && event.key === 'k') {
            event.preventDefault();
            const searchInput = document.querySelector('input[type="search"], input[placeholder*="جستجو"]');
            if (searchInput) {
              searchInput.focus();
              searchInput.select();
            }
          }

          // Ctrl/Cmd + H for home
          if ((event.ctrlKey || event.metaKey) && event.key === 'h') {
            event.preventDefault();
            navigate('home');
          }

          // Alt + 1-9 for quick navigation
          if (event.altKey && event.key >= '1' && event.key <= '9') {
            event.preventDefault();
            const navItems = document.querySelectorAll('nav button[aria-current], nav button');
            const index = parseInt(event.key) - 1;
            if (navItems[index]) {
              navItems[index].click();
            }
          }

          // Escape key for closing modals/overlays
          if (event.key === 'Escape') {
            // Close any open modals, dropdowns, or overlays
            const modals = document.querySelectorAll('[role="dialog"], .modal, [data-modal]');
            const dropdowns = document.querySelectorAll('[aria-expanded="true"]');
            const closeButtons = document.querySelectorAll('[data-close], .close-button, [aria-label*="بستن"]');
            
            if (modals.length > 0) {
              const topModal = modals[modals.length - 1];
              const closeBtn = topModal.querySelector('[data-close], button[aria-label*="بستن"]');
              closeBtn?.click();
            } else if (dropdowns.length > 0) {
              const lastDropdown = dropdowns[dropdowns.length - 1];
              lastDropdown.setAttribute('aria-expanded', 'false');
              lastDropdown.click?.();
            } else if (closeButtons.length > 0) {
              closeButtons[closeButtons.length - 1].click();
            }
          }

          // Tab navigation improvements (focus trapping in modals)
          if (event.key === 'Tab') {
            const activeModal = document.querySelector('[role="dialog"]:not([hidden])');
            if (activeModal) {
              const focusableElements = activeModal.querySelectorAll(
                'button:not([disabled]), [href]:not([disabled]), input:not([disabled]), select:not([disabled]), textarea:not([disabled]), [tabindex]:not([tabindex="-1"]):not([disabled])'
              );
              
              if (focusableElements.length === 0) return;
              
              const firstElement = focusableElements[0];
              const lastElement = focusableElements[focusableElements.length - 1];

              if (event.shiftKey) {
                if (document.activeElement === firstElement || !activeModal.contains(document.activeElement)) {
                  event.preventDefault();
                  lastElement.focus();
                }
              } else {
                if (document.activeElement === lastElement) {
                  event.preventDefault();
                  firstElement.focus();
                }
              }
            }
          }

          // Arrow key navigation for lists, grids, and carousels
          if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'].includes(event.key)) {
            const activeElement = document.activeElement;
            
            // Navigation for grid layouts (challenges, submissions, etc.)
            if (activeElement?.closest('[role="grid"], .grid, [data-grid]')) {
              event.preventDefault();
              handleGridNavigation(event.key, activeElement);
            }
            
            // Navigation for lists
            else if (activeElement?.closest('[role="list"], [role="listbox"], .list-navigation')) {
              event.preventDefault();
              handleListNavigation(event.key, activeElement);
            }
            
            // Navigation for tab panels
            else if (activeElement?.closest('[role="tablist"]')) {
              event.preventDefault();
              handleTabNavigation(event.key, activeElement);
            }
          }

          // Space or Enter for activation
          if (event.key === ' ' || event.key === 'Enter') {
            const activeElement = document.activeElement;
            if (activeElement?.getAttribute('role') === 'button' && !activeElement.disabled) {
              event.preventDefault();
              activeElement.click();
            }
          }

          // F1 for help/shortcuts
          if (event.key === 'F1') {
            event.preventDefault();
            showKeyboardShortcuts();
          }
        };

        // Grid navigation helper
        const handleGridNavigation = (key, currentElement) => {
          const gridContainer = currentElement.closest('[role="grid"], .grid, [data-grid]');
          const gridItems = Array.from(gridContainer.querySelectorAll('[role="gridcell"], .grid > *, [data-grid-item]'));
          const currentIndex = gridItems.indexOf(currentElement);
          
          if (currentIndex === -1) return;
          
          const gridCols = parseInt(getComputedStyle(gridContainer).gridTemplateColumns?.split(' ').length) || 3;
          let targetIndex = currentIndex;
          
          switch (key) {
            case 'ArrowLeft':
              targetIndex = Math.max(0, currentIndex - 1);
              break;
            case 'ArrowRight':
              targetIndex = Math.min(gridItems.length - 1, currentIndex + 1);
              break;
            case 'ArrowUp':
              targetIndex = Math.max(0, currentIndex - gridCols);
              break;
            case 'ArrowDown':
              targetIndex = Math.min(gridItems.length - 1, currentIndex + gridCols);
              break;
          }
          
          if (targetIndex !== currentIndex && gridItems[targetIndex]) {
            gridItems[targetIndex].focus();
          }
        };

        // List navigation helper
        const handleListNavigation = (key, currentElement) => {
          const listContainer = currentElement.closest('[role="list"], [role="listbox"], .list-navigation');
          const listItems = Array.from(listContainer.querySelectorAll('[role="listitem"], [role="option"], li, .list-item'));
          const currentIndex = listItems.indexOf(currentElement);
          
          if (currentIndex === -1) return;
          
          let targetIndex = currentIndex;
          
          switch (key) {
            case 'ArrowUp':
              targetIndex = Math.max(0, currentIndex - 1);
              break;
            case 'ArrowDown':
              targetIndex = Math.min(listItems.length - 1, currentIndex + 1);
              break;
            case 'Home':
              targetIndex = 0;
              break;
            case 'End':
              targetIndex = listItems.length - 1;
              break;
          }
          
          if (targetIndex !== currentIndex && listItems[targetIndex]) {
            listItems[targetIndex].focus();
          }
        };

        // Tab navigation helper
        const handleTabNavigation = (key, currentElement) => {
          const tabList = currentElement.closest('[role="tablist"]');
          const tabs = Array.from(tabList.querySelectorAll('[role="tab"]'));
          const currentIndex = tabs.indexOf(currentElement);
          
          if (currentIndex === -1) return;
          
          let targetIndex = currentIndex;
          
          switch (key) {
            case 'ArrowLeft':
              targetIndex = currentIndex === 0 ? tabs.length - 1 : currentIndex - 1;
              break;
            case 'ArrowRight':
              targetIndex = currentIndex === tabs.length - 1 ? 0 : currentIndex + 1;
              break;
            case 'Home':
              targetIndex = 0;
              break;
            case 'End':
              targetIndex = tabs.length - 1;
              break;
          }
          
          if (targetIndex !== currentIndex && tabs[targetIndex]) {
            tabs.forEach((tab, index) => {
              tab.setAttribute('aria-selected', index === targetIndex ? 'true' : 'false');
              tab.setAttribute('tabindex', index === targetIndex ? '0' : '-1');
            });
            tabs[targetIndex].focus();
          }
        };

        // Show keyboard shortcuts help
        const showKeyboardShortcuts = () => {
          const helpModal = document.createElement('div');
          helpModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
          helpModal.setAttribute('role', 'dialog');
          helpModal.setAttribute('aria-labelledby', 'shortcuts-title');
          helpModal.innerHTML = `
            <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full mx-4 max-h-96 overflow-y-auto">
              <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                  <h2 id="shortcuts-title" class="text-xl font-bold text-gray-900">میانبرهای کیبورد</h2>
                  <button data-close class="text-gray-400 hover:text-gray-600 text-xl" aria-label="بستن">
                    ✕
                  </button>
                </div>
                <div class="grid md:grid-cols-2 gap-6">
                  <div>
                    <h3 class="font-semibold mb-3">ناوبری عمومی</h3>
                    <div class="space-y-2 text-sm">
                      <div class="flex justify-between">
                        <span>Ctrl/Cmd + K</span>
                        <span>جستجو</span>
                      </div>
                      <div class="flex justify-between">
                        <span>Ctrl/Cmd + H</span>
                        <span>صفحه اصلی</span>
                      </div>
                      <div class="flex justify-between">
                        <span>Alt + 1-9</span>
                        <span>منوی سریع</span>
                      </div>
                      <div class="flex justify-between">
                        <span>Escape</span>
                        <span>بستن مودال</span>
                      </div>
                      <div class="flex justify-between">
                        <span>F1</span>
                        <span>راهنما</span>
                      </div>
                    </div>
                  </div>
                  <div>
                    <h3 class="font-semibold mb-3">ناوبری در صفحات</h3>
                    <div class="space-y-2 text-sm">
                      <div class="flex justify-between">
                        <span>Tab/Shift+Tab</span>
                        <span>حرکت در عناصر</span>
                      </div>
                      <div class="flex justify-between">
                        <span>Arrow Keys</span>
                        <span>ناوبری در فهرست‌ها</span>
                      </div>
                      <div class="flex justify-between">
                        <span>Space/Enter</span>
                        <span>فعال‌سازی</span>
                      </div>
                      <div class="flex justify-between">
                        <span>Home/End</span>
                        <span>شروع/پایان فهرست</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          `;

          const closeBtn = helpModal.querySelector('[data-close]');
          closeBtn.addEventListener('click', () => {
            helpModal.remove();
          });

          helpModal.addEventListener('click', (e) => {
            if (e.target === helpModal) {
              helpModal.remove();
            }
          });

          document.body.appendChild(helpModal);
          closeBtn.focus();
        };

        document.addEventListener('keydown', handleKeyDown);
        return () => document.removeEventListener('keydown', handleKeyDown);
      }, [navigate]);

      // Authentication handlers
      const handleLogin = (userSession) => {
        setSession(userSession);
        navigate('home');
      };

      const handleLogout = () => {
        setSession(null);
      };

      // Challenge management handlers
      const handleSelectChallenge = (challenge) => {
        setSelectedChallenge(challenge);
        navigate('challenge-detail');
      };

      const handleCreateChallenge = () => {
        setEditingChallenge(null);
        setShowChallengeForm(true);
        navigate('create-challenge');
      };

      const handleEditChallenge = (challenge) => {
        setEditingChallenge(challenge);
        setShowChallengeForm(true);
        navigate('create-challenge');
      };

      const handleSaveChallenge = (challengeData) => {
        setChallenges(prev => {
          const existingIndex = prev.findIndex(c => c.id === challengeData.id);
          if (existingIndex !== -1) {
            const updated = [...prev];
            updated[existingIndex] = challengeData;
            return updated;
          } else {
            return [...prev, challengeData];
          }
        });
        setShowChallengeForm(false);
        setEditingChallenge(null);
        navigate('challenges');
      };

      const handleCancelChallenge = () => {
        setShowChallengeForm(false);
        setEditingChallenge(null);
        navigate('challenges');
      };

      const handleBackToCatalog = () => {
        setSelectedChallenge(null);
        navigate('challenges');
      };

      // Submission handlers
      const handleCreateSubmission = (challenge) => {
        setCreatingSubmission(challenge);
        navigate('create-submission');
      };

      const handleSaveSubmission = (submissionData) => {
        setCreatingSubmission(null);
        // Navigate to my-submissions to see the new submission
        navigate('my-submissions');
        alert('پیشنهاد شما با موفقیت ارسال شد!');
      };

      const handleCancelSubmission = () => {
        setCreatingSubmission(null);
        navigate('challenges');
      };
  
      // Temporary Reset Demo button for QA (will move to Admin later)
      const handleReset = () => {
        if (!confirm("بازنشانی دمو؟ همهٔ داده‌ها پاک و مجدداً مقداردهی می‌شود.")) return;
        storage.clear();
        // Clear session
        setSession(null);
        // Reseed and reload UI
        seedDataOnce();
        navigate('home');
      };

      // Render current page based on route
      const renderCurrentPage = () => {
        // Authentication routes
        if (currentRoute === 'login') {
          return <LoginForm onLogin={handleLogin} />;
        }
        
        if (currentRoute === 'register') {
          return <RegistrationForm type="solver" />;
        }
        
        if (currentRoute === 'register-seeker') {
          return <RegistrationForm type="seeker" />;
        }

        // Public/Protected routes
        switch (currentRoute) {
          case 'home':
            return <HomePage users={users} challenges={challenges} submissions={submissions} events={events} exhibitors={exhibitors} session={session} />;
          case 'challenges':
            return <ChallengeCatalog
              challenges={challenges}
              onSelectChallenge={handleSelectChallenge}
              session={session}
            />;
          case 'challenge-detail':
            return <ChallengeDetail
              challenge={selectedChallenge}
              onBack={handleBackToCatalog}
              onSolve={handleCreateSubmission}
              session={session}
            />;
          case 'create-challenge':
            if (session?.role === 'SEEKER') {
              return <ChallengeForm
                challenge={editingChallenge}
                onSave={handleSaveChallenge}
                onCancel={handleCancelChallenge}
                session={session}
              />;
            } else {
              navigate('home');
              return null;
            }
          case 'create-submission':
            if (session?.role === 'SOLVER') {
              return <SubmissionForm
                challenge={creatingSubmission}
                onSave={handleSaveSubmission}
                onCancel={handleCancelSubmission}
                session={session}
              />;
            } else {
              navigate('home');
              return null;
            }
                    case 'testa':
            return <TESTAPage events={events} exhibitors={exhibitors} session={session} />;
          case 'testa-home':
            return <TESTAHomePage session={session} />;
          case 'testa-schedule':
            return <TESTASchedulePage />;
          case 'testa-events':
            return <TESTAEventsPage session={session} />;
          case 'testa-booths':
            return <TESTABoothsPage />;
          case 'testa-stats':
            return <TESTAStatsPage session={session} />;

          // Role-specific routes
          case 'admin':
            if (session?.role === 'ADMIN') {
              return <AdminPage session={session} />;
            } else {
              navigate('home');
              return null;
            }

          case 'my-challenges':
            if (session?.role === 'SEEKER') {
              return <MyChallengesPage session={session} challenges={challenges} orgs={orgs} />;
            } else {
              navigate('home');
              return null;
            }
          case 'submissions':
            if (session?.role === 'SEEKER') {
              return <SubmissionsTable
                session={session}
                submissions={submissions}
                challenges={challenges}
                users={users}
                onStatusUpdate={setSubmissions}
              />;
            } else {
              navigate('home');
              return null;
            }

          case 'my-submissions':
            if (session?.role === 'SOLVER') {
              return <MySubmissionsPage session={session} submissions={submissions} challenges={challenges} orgs={orgs} />;
            } else {
              navigate('home');
              return null;
            }
          case 'messages':
            if (session) {
              return <MessagesOverview
                session={session}
                submissions={submissions}
                challenges={challenges}
                users={users}
                onSelectThread={(submission) => {
                  setSelectedSubmission(submission);
                  navigate('message-thread');
                }}
              />;
            } else {
              navigate('login');
              return null;
            }
          case 'message-thread':
            if (session && selectedSubmission) {
              return <MessageThread
                submission={selectedSubmission}
                session={session}
                users={users}
                onSendMessage={() => {
                  // Refresh submissions to trigger re-render
                  setSubmissions([...submissions]);
                }}
              />;
            } else {
              navigate('messages');
              return null;
            }

          case 'profile':
            if (session) {
              const user = users.find(u => u.id === session.userId);
              const org = session.role === 'SEEKER' ? orgs.find(o => o.id === session.orgId) : null;
              return <ProfilePage user={user} org={org} />;
            } else {
              navigate('login');
              return null;
            }
          
          default:
            return <HomePage users={users} challenges={challenges} submissions={submissions} events={events} exhibitors={exhibitors} session={session} />;
        }
      };
  
      return (
        <div className={`min-h-screen ${kioskMode.isKioskMode ? 'bg-blue-50' : 'bg-gray-50'}`}>
          {/* Skip Links for Accessibility */}
          <SkipLink href="#main-content">رفتن به محتوای اصلی</SkipLink>
          <SkipLink href="#navigation">رفتن به منوی ناوبری</SkipLink>
          
          {/* Page Loading Indicator */}
          <div id="page-loading" className="page-loading" style={{ display: 'none' }} role="status" aria-label="در حال بارگذاری">
            <div className="flex flex-col items-center">
              <LoadingSpinner size="lg" />
              <p className="mt-4 text-gray-600">در حال بارگذاری...</p>
            </div>
          </div>

          <Navigation
            id="navigation"
            currentRoute={currentRoute}
            navigate={navigate}
            session={session}
            onLogout={handleLogout}
            kioskMode={kioskMode}
          />

          <main 
            id="main-content" 
            className={`${kioskMode.isKioskMode ? 'max-w-7xl text-lg' : 'max-w-5xl'} mx-auto px-6 py-8`} 
            role="main"
            tabIndex="-1"
            aria-label="محتوای اصلی"
          >
            {renderCurrentPage()}
          </main>

          {/* Global Toast Container */}
          <ToastContainer toasts={[]} onRemoveToast={() => {}} />

          {/* Kiosk Mode / Admin Controls */}
          {session?.role === 'ADMIN' && (
            <div className={`fixed bottom-4 left-4 z-50 ${kioskMode.isKioskMode ? 'scale-125' : ''}`}>
              <div className="bg-white rounded-lg shadow-lg p-3 border">
                <div className="flex items-center gap-2 mb-2">
                  <span className="text-xs text-gray-500">نشست:</span>
                  <span className="text-xs font-medium">{session?.name || "—"}</span>
                  {kioskMode.isKioskMode && (
                    <span className="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded-full">
                      🖥️ Kiosk
                    </span>
                  )}
                </div>

                {/* Kiosk Mode Toggle */}
                <div className="mb-2">
                  <button
                    onClick={kioskMode.isKioskMode ? kioskMode.disableKioskMode : kioskMode.enableKioskMode}
                    className={`w-full px-3 py-1 rounded-md text-xs transition-colors ${
                      kioskMode.isKioskMode
                        ? 'bg-red-100 hover:bg-red-200 text-red-800'
                        : 'bg-blue-100 hover:bg-blue-200 text-blue-800'
                    }`}
                  >
                    {kioskMode.isKioskMode ? '🔄 خروج از حالت کیوسک' : '🖥️ حالت کیوسک'}
                  </button>
                </div>

                {!kioskMode.isKioskMode && (
                  <>
                    <button
                      onClick={handleReset}
                      className="w-full px-3 py-1 rounded-md bg-gray-100 hover:bg-gray-200 text-xs transition-colors mb-2"
                    >
                      🔄 Reset Demo
                    </button>
                    <button
                      onClick={() => {
                        console.log('Manual seeding...');
                        localStorage.removeItem('seeded');
                        seedDataOnce();
                      }}
                      className="w-full px-3 py-1 rounded-md bg-blue-100 hover:bg-blue-200 text-xs transition-colors"
                    >
                      🌱 Seed Data
                    </button>
                  </>
                )}
              </div>
            </div>
          )}

          {/* Kiosk Mode Indicator */}
          {kioskMode.isKioskMode && (
            <>
              <div className="fixed top-4 left-1/2 transform -translate-x-1/2 z-40">
                <div className="bg-blue-600 text-white px-4 py-2 rounded-full text-sm font-medium shadow-lg">
                  🖥️ حالت نمایشگاهی فعال
                </div>
              </div>

              {/* Floating Reset Demo Button for Kiosk */}
              <div className="fixed bottom-4 right-4 z-50">
                <button
                  onClick={() => {
                    if (confirm('آیا مطمئن هستید که می‌خواهید دمو را بازنشانی کنید؟')) {
                      kioskMode.resetDemoData();
                    }
                  }}
                  className="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg shadow-lg text-sm font-medium transition-colors"
                  title="بازنشانی دمو"
                >
                  🔄 Reset Demo
                </button>
              </div>
            </>
          )}
        </div>
      );
    }
  
    // --- TEST SIMPLE COMPONENT FIRST ---
    function SimpleTest() {
      return React.createElement('div', { style: { padding: '20px', background: '#e3f2fd' } }, 
        React.createElement('h2', null, 'React is working!'),
        React.createElement('p', null, 'If you see this, React is loaded correctly.')
      );
    }

    // --- RENDER ROOT ---
    try {
      console.log('Starting React app...');
      const root = document.getElementById("root");
      if (!root) {
        console.error('Root element not found!');
        document.body.innerHTML = '<div style="padding: 20px; color: red;">Error: Root element not found!</div>';
        throw new Error('Root element not found');
      }
      
      console.log('Root element found, creating React root...');
      const reactRoot = ReactDOM.createRoot(root);
      
      // Test simple component first
      console.log('Testing simple component...');
      reactRoot.render(React.createElement(SimpleTest));
      
      // If that works, try the full app after a delay
      setTimeout(() => {
        console.log('Now rendering full App component...');
        try {
          reactRoot.render(React.createElement(App));
          console.log('App rendered successfully!');
        } catch (appError) {
          console.error('Error in App component:', appError);
          reactRoot.render(React.createElement('div', 
            { style: { padding: '20px', color: 'red', fontFamily: 'Arial' } },
            React.createElement('h2', null, 'خطا در کامپوننت اصلی'),
            React.createElement('p', null, 'خطا در بارگذاری کامپوننت اصلی:'),
            React.createElement('pre', 
              { style: { background: '#f5f5f5', padding: '10px', borderRadius: '4px' } },
              appError.message
            ),
            React.createElement('button', 
              { onClick: () => location.reload(), style: { padding: '10px 20px', marginTop: '10px' } },
              'تلاش مجدد'
            )
          ));
        }
      }, 1000);
      
    } catch (error) {
      console.error('Error rendering React app:', error);
      document.body.innerHTML = `
        <div style="padding: 20px; color: red; font-family: Arial;">
          <h2>خطا در بارگذاری React</h2>
          <p>متأسفانه خطایی در بارگذاری React رخ داده است:</p>
          <pre style="background: #f5f5f5; padding: 10px; border-radius: 4px;">${error.message}</pre>
          <button onclick="location.reload()" style="padding: 10px 20px; margin-top: 10px;">تلاش مجدد</button>
        </div>
      `;
    }
  </script>
</body>
</html>
  